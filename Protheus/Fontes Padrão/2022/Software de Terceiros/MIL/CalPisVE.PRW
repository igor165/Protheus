User Function CalPISVE


// ENTRADA DE VEICULOS 
cGruVei    := GetMv("MV_GRUVEI")+space(4-len(GetMv("MV_GRUVEI")))
DbSelectArea("VVG")
DbGotop()
Do While ! VVG->(Eof())
	FG_Seek("VV1","VVG->VVG_CHASSI",2,.f.)
	FG_Seek("SB1","cGruVei+VV1->VV1_CHAINT",7,.f.)
	FG_SEEK("SF4","VVG->VVG_CODTES",1,.f.)
	if VVG->VVG_PICOSB == "1" // Tem Pis/Cofins de Substituicao
		nBasePC := VVG->VVG_VALUNI + VVG->VVG_VALDES + VVG->VVG_TOTSEG + VVG->VVG_DESACE + VVG->VVG_TOTFRE + VVG->VVG_VALIPI
	Else
		nBasePC := 0
	Endif
	aPisCof := CalcPisCofSai(nBasePC)
	Reclock("VVG",.F.)   
	VVG->VVG_PISENT :=  0
	VVG->VVG_COFENT :=  0
	If aPisCof[1,1] > 0 
		VVG->VVG_PISENT := aPisCof[1,1] 
	EndIf
	If aPisCof[1,2] > 0
		VVG->VVG_COFENT := aPisCof[1,2] 
	Endif	            
	MsUnlock()
	DbSkip()
EndDo                  

//Saida de veiculos

DbSelectArea("VVA")
DbGoTop()
Do While ! VVA->(EOF())                  
	FG_SEEK("VV0","VVA->VVA_NUMTRA",1,.f.)
	FG_SEEK("SB1","VVA->VVA_CHAINT",8,.f.)
	FG_SEEK("SF4","VVA->VVA_CODTES",1,.f.)
   cTipFat := VV0->VV0_TIPFAT 
   RecLock("VVA",.F.)
	If cTipFat == "2" //Faturamento Direto
		aPisCof := CalcPiscofSai(VVA->VVA_VALCVD)
		VVA->VVA_PISVEN := aPisCof[1,1] 
		VVA->VVA_PMFVEN := FG_CalcMF( { {FG_RtDtImp("PIS",VV0->VV0_DATMOV),aPisCof[1,1]} })
		VVA->VVA_COFVEN := aPisCof[1,2] 
		VVA->VVA_CMFVEN := FG_CalcMF( { {FG_RtDtImp("COF",VV0->VV0_DATMOV),aPisCof[1,2]} })
	Else
		if cTipFat == "1" // Veiculo Usado      
		   Reclock("SB1",.F.)
		   SB1->B1_PPIS := 0.65
		   MsUnlock("SB1")
			aPisCof := CalcPiscofSai((VVA->VVA_VALVDA-(VVG->VVG_VCNVEI+VVG->VVG_VALFRE)))
   		VVA->VVA_PISVEN := aPisCof[1,1] 
   		VVA->VVA_COFVEN := aPisCof[1,2] 
   		VVA->VVA_PMFVEN := FG_CalcMF( { {FG_RtDtImp("PIS",VV0->VV0_DATMOV),aPisCof[1,1] }})
	   	VVA->VVA_CMFVEN := FG_CalcMF( { {FG_RtDtImp("COF",VV0->VV0_DATMOV),aPisCof[1,2] }})
		Endif
   ENDIF
   aPisCof := CalcPisCofSai(VVA->VVA_RECTEC)
	if VVA->VVA_INPCRT == "1"
		VVA->VVA_PISRTE   := aPisCof[1,1] + aPisCof[1,2] 
		VVA->VVA_PMFRTE   := FG_CalcMF({ {FG_RtDtImp("PIS",VVA->VVA_DATRTC),VVA->VVA_PISRTE} }) 
	Endif
	If VVA->VVA_INPCBF == "1"
		aPisCof := CalcPisCofSai(VVA->VVA_BONFAB)
		VVA->VVA_PISBFB := aPisCof[1,1] + aPisCof[1,2] 
		VVA->VVA_PMFBFB := FG_CalcMF({ {FG_RtDtImp("PIS",VVA->VVA_DATBFB),VVA->VVA_PISBFB} })
	Endif   
	VVA->VVA_TOTIMP := VVA->VVA_ICMVEN+VVA->VVA_ISSCVD+VVA->VVA_PISVEN+VVA->VVA_COFVEN+VVA->VVA_ISSRTE+VVA->VVA_PISRTE+VVA->VVA_ISSBFB+VVA->VVA_PISBFB
	VVA->VVA_TMFIMP := VVA->VVA_IMFVEN+VVA->VVA_IMFCVD+VVA->VVA_PMFVEN+VVA->VVA_CMFVEN+VVA->VVA_IMFRTE+VVA->VVA_PMFRTE+VVA->VVA_IMFBFB+VVA->VVA_PMFBFB
	VVA->VVA_TOTCUS := VVA->VVA_VCAVEI-VVA->VVA_REDCUS+VVA->VVA_JUREST+VVA->VVA_VALFRE+VVA->VVA_ACESSO+VVA->VVA_VDESCO+VVA->VVA_PISENT+VVA->VVA_COFENT 
	VVA->VVA_TMFCUS := VVA->VVA_VMFVEI-VVA->VVA_RMFCUS+VVA->VVA_JMFEST+VVA->VVA_VMFFRE+VVA->VVA_AMFSSO+VVA->VVA_VMFSCO+VVA->VVA_PMFENT+VVA->VVA_CMFENT 
	VVA->VVA_LUCBRU := VVA->VVA_FATTOT-VVA->VVA_TOTIMP-VVA->VVA_VCAVEI-VVA->VVA_VALFRE
	VVA->VVA_LMFBRU := VVA->VVA_FMFTOT-VVA->VVA_TMFIMP-VVA->VVA_VMFVEI-VVA->VVA_VMFFRE
	if cTipFat == "2"
		VVA->VVA_TOTDES := VVA->VVA_DESVEI+VVA->VVA_DESCLI+VVA->VVA_SEGVIA+VVA->VVA_VALASS+VVA->VVA_VALREV+VVA->VVA_VALFRE+VVA->VVA_ASSIMP+VVA->VVA_DESFIX
		VVA->VVA_TMFDES := VVA->VVA_DMFVEI+VVA->VVA_DMFCLI+VVA->VVA_SMFVIA+VVA->VVA_VMFASS+VVA->VVA_VMFREV+VVA->VVA_VMFFRE+VVA->VVA_AMFIMP+VVA->VVA_DMFFIX
	Else
		VVA->VVA_TOTDES := VVA->VVA_DESVEI+VVA->VVA_DESCLI+VVA->VVA_SEGVIA+VVA->VVA_VALASS+VVA->VVA_VALREV+VVA->VVA_ASSIMP+VVA->VVA_DESFIX
		VVA->VVA_TMFDES := VVA->VVA_DMFVEI+VVA->VVA_DMFCLI+VVA->VVA_SMFVIA+VVA->VVA_VMFASS+VVA->VVA_VMFREV+VVA->VVA_AMFIMP+VVA->VVA_DMFFIX
	Endif
	VVA->VVA_LUCLQ1 := VVA->VVA_LUCBRU-VVA->VVA_JUREST-VVA->VVA_ACESSO-VVA->VVA_VDESCO-VVA->VVA_DESCLI-VVA->VVA_SEGVIA-VVA->VVA_VALASS-VVA->VVA_VALREV-VVA->VVA_DESVEI-VVA->VVA_ASSIMP-VVA->VVA_COMVDE-VVA->VVA_COMGER-VVA->VVA_COMPAT //LUCRO MARGINAL
	VVA->VVA_LMFLQ1 := VVA->VVA_LMFBRU-VVA->VVA_JMFEST-VVA->VVA_AMFSSO-VVA->VVA_VMFSCO-VVA->VVA_DMFCLI-VVA->VVA_SMFVIA-VVA->VVA_VMFASS-VVA->VVA_VMFREV-VVA->VVA_DMFVEI-VVA->VVA_AMFIMP-VVA->VVA_CMFVDE-VVA->VVA_CMFGER-VVA->VVA_CMFPAT //LUCRO MARGINAL
	VVA->VVA_LUCLQ2 := VVA->VVA_LUCLQ1-VVA->VVA_DESFIX+(VVA->VVA_REDCUS+VVA->VVA_RECVEI-VVA->VVA_DSPFIN)      //LAIR
	VVA->VVA_LMFLQ2 := VVA->VVA_LMFLQ1-VVA->VVA_DMFFIX+(VVA->VVA_RMFCUS+VVA->VVA_RMFVEI-VVA->VVA_DMFFIN)      //LAIR
	MsUnlockAll() 
	DbSelectArea("VVA")
	DbSkip()
EndDo		

Return .T.
	