#INCLUDE "MATA520.CH"
#INCLUDE "PROTHEUS.CH"
#INCLUDE 'FWMVCDEF.CH'

Static lFindRskAct := Nil

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ Mata520  ³ Autor ³ Claudinei M. Benzi    ³ Data ³ 15.01.93  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Programa de Exclusao de Notas Fiscais                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe e ³ Void Mata520(void)                                          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Generico                                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ ATUALIZACOES SOFRIDAS DESDE A CONSTRUCAO INICIAL.                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ PROGRAMADOR  ³ DATA   ³ BOPS ³  MOTIVO DA ALTERACAO                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Edson   M.   ³07/01/98³10099A³Acerto da gravacao do num da NF no SC5   ³±±
±±³ Edson   M.   ³09/01/98³XXXXXX³Acerto da gravacao do campo C6_OP        ³±±
±±³ Marcos Simidu³13/01/98³XXXXXX³Implementacao de Op. Triangulares.       ³±±
±±³ Eduardo Riera³25/02/98³XXXXXX³Acerto no controle de reservas           ³±±
±±³ Eduardo Riera³26/03/98³XXXXXX³Implementacao dos Campos E1_SERIE e      ³±±
±±³              ³        ³      ³F2_PREFIXO                               ³±±
±±³ Jose Lucas   ³09/06/98³XXXXXX³Pontos de Entrada A520EXC (Argentina).   ³±±
±±³ Edson   M.   ³22/06/98³XXXXXX³Ajuste na tela de Visual.(Argentina)     ³±±
±±³ Wagner       ³30/06/98³XXXXXX³Posicionar detprova para contab na dele  ³±±
±±³ Eduardo      ³02/07/98³14676a³Inclusao de Ponto de Entrada ms520vld    ³±±
±±³ Eduardo      ³06.08.98³03974A³Parametros da funcao FA440deleE          ³±±
±±³ Edson   M.   ³19/08/98³16955A³Acerto do help sobre a data de fechto.   ³±±
±±³ Rodrigo Sart.³21/08/98³6741A ³Acerto na exclusao de NFs com material   ³±±
±±³              ³        ³      ³rejeitado                                ³±±
±±³ Wagner       ³19/11/98³18693A³Headprova esta sendo aberto sempre!!     ³±±
±±³ Jose Lucas   ³10/12/98³XXXXXX³Inclus„o de STR0034...STR0035 na fun‡„o  ³±±
±±³              ³        ³      ³A520WHeader().                           ³±±
±±³ Mauricio     ³01/02/99³19471a³Tratamento INSS                          ³±±
±±³ Rodrigo Sart.³11/02/99³XXXXXX³Acerto na funcao CriaSDB                 ³±±
±±³ Jose Lucas   ³18/07/99³19847A³Acertos modificacoes na Argentina...     ³±±
±±³              ³        ³      ³Tratamento da varivael cPaisLoc e dire-  ³±±
±±³              ³        ³      ³tiva de comipilacao #IFNDEF SPANISH      ³±±
±±³ Julio Wittwer³30.07.99³META  ³Interpretar MV_CPNEG                     ³±±
±±³ Aline C.Vale ³11.08.99³23200 ³Na vizualizacao utilizar a Pict do SD2   ³±±
±±³ Jose Lucas   ³25.08.99³16321A³Disponibilzado Pto de Entrada M520SF3    ³±±
±±³ Paulo Augusto³13.10.99³XXXXXX³Decl. da variavel nQtdVen para o Chile   ³±±
±±³ ALVES        ³29.11.99³XXXXXX³Preparano MATA520 para executar rotinas  ³±±
±±³              ³        ³      ³automaticas                              ³±±
±±³ Jose Lucas   ³06.12.99³23523A³Nova tela de Visualiza‡„o na fun‡„o A520 ³±±
±±³              ³        ³      ³Visual(), que tamb‚m ‚ executada pelo    ³±±
±±³              ³        ³      ³MATA467.PRX,tratamento do MV_BORRFAT.    ³±±
±±³ Leonardo     ³16/02/00³XXXXXX³Substituir diretiva SPANISH por cPaisLoc ³±±
±±³ Denis Martins³16.02.00³XXXXXX³Atual. Funcao A520GetIpxTes-Loc.Colombia ³±±
±±³ Patricia Sal.³01/03/00³XXXXXX³Util.os campos D7_PRODUTO+D7_DOC+D7_SERIE³±±
±±³              ³        ³      ³+D7_FORNECE+D7_LOJA ao inves do D7_CHAVE ³±±
±±³ Lucas        ³16.04.00³      ³Eliminar tratamento do MV_BORRFAT.       ³±±
±±³ Lucas        ³16.04.00³16280A³Mostar Get da Natureza/Modalidad na A520 ³±±
±±³              ³        ³      ³Visual(),controle de exclusao de Remitos ³±±
±±³              ³        ³      ³chamada da funcao ESldRemSai(),tratam.de ³±±
±±³              ³        ³      ³Clientes Consignados e Exportacao        ³±±
±±³ Humberto Kas.³22.05.00³      ³Posicionamento da TES correta p/impostos ³±±
±±³              ³        ³      ³e retirada da funcao MOD p/ aliquotas.   ³±±
±±³ Bruno        ³09.06.00³      ³Ajuste no tratamento de reservas (Loc.)  ³±±
±±³ Fernando M.  ³14/07/00³XXXXXX³Filtro para nao selecionar NC's e ND's   ³±±
±±³              ³        ³      ³(Loc. Chile)                             ³±±
±±³ Claudia C.   ³08/08/00³XXXXXX³Rotina de Integracao com o EEC           ³±±
±±³ Lucas        ³27/08/00³Melhor³Tratamento para multi-moedas, alteracao  ³±±
±±³              ³        ³      ³GETS e SAYS, exclusao dos titulos de Re- ³±±
±±³              ³        ³      ³tencao, incializacao do lancamento padrao³±±
±±³              ³        ³      ³527 (Estornar Lancto de Retencao), subst.³±±
±±³              ³        ³      ³Picture fixas por PesqPict(,,,).         ³±±
±±³ Norbert Waage³16/05/07³125161³Atualizacao do status do orcamento do    ³±±
±±³              ³        ³      ³Televendas(SIGATMK), apos exclusao da NF.³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
FUNCTION Mata520(aRotAuto)

Local aRegSd2   := {}
Local aRegSe1   := {}
Local aRegSe2   := {}
Local lCarteira		:= .F.  //Default do Faturamento

If aRotAuto == Nil
	Mata521A()
Else
	aChave := {"F2_DOC","F2_SERIE"}
	aRotAuto := SF2->(MSArrayXDB(aRotAuto,,5,,aChave))
	If !( Len(aRotAuto) > 0 )
		Return .T.
	EndIf

	/* Integração RISK - TOTVS Mais Negócios
	 Para o processo Mais Negócios ao excluir a NFS, o pedido de venda deve 
	 ficar sempre em carteira para geração de um novo ticket de crédito. 
	 Essa configuração é necessária para evitar o faturamento de ticket vencido. */
	If lFindRskAct == Nil
		lFindRskAct := FindFunction( "RskIsActive" )
	EndIf
	
	If lFindRskAct .And. RskIsActive()
		lCarteira := .T. 
	EndIf 

	If MaCanDelF2("SF2",SF2->(RecNo()),@aRegSD2,@aRegSE1,@aRegSE2,,,,lCarteira)
		PcoIniLan("000102")
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Estorna o documento de saida                                   ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ					
		SF2->(MaDelNFS(aRegSD2,aRegSE1,aRegSE2,.F.,.F.,.T., lCarteira ))
		PcoFinLan("000102")
	EndIf
EndIf

TCInternal(5,"*OFF")   // Desliga Refresh no Lock do Top

Return( .T. )