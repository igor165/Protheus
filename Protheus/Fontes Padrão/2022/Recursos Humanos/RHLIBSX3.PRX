#INCLUDE "PROTHEUS.CH" 

/*                                                                                           
ээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммммкмммммммямммммммммммммммммммммммкммммммяммммммммммммммммм╩╠╠
╠╠╨Programa  Ё RHLIBSX3   ЁAutor  ЁEquipe RH			  Ё Data Ё      09/11/2009 ╨╠╠
╠╠лддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддаддддддддддддддддд╧╠╠
╠╠╨Descri┤┘o Ё Biblioteca de funcoes para atualizacao de dicionario				   ╨╠╠
╠╠лддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╧╠╠
╠╠╨Sintaxe   Ё RHLIBSX3()													       ╨╠╠
╠╠лддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╧╠╠
╠╠╨Uso       Ё Generico                                                            ╨╠╠
╠╠лддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╧╠╠
╠╠╨         ATUALIZACOES SOFRIDAS DESDE A CONSTRU─AO INICIAL.                      ╨╠╠
╠╠лддддддддддддддбддддддддддбдддддддддддбдддддддддддддддддддддддддддддддддддддддддд╧╠╠
╠╠╨Programador   Ё Data     Ё FNC       Ё  Motivo da Alteracao                     ╨╠╠
╠╠гддддддддддддддеддддддддддедддддддддддедддддддддддддддддддддддддддддддддддддддддд╤╠╠
╠╠ЁTiago Malta   Ё24/08/2015ЁPCREQ-4824 ЁAjustes no controle de alteraГУes         Ё╠╠
╠╠Ё			     Ё		    Ё	   		Ёdicionarios para utilizaГЦo na versЦo 12. Ё╠╠
╠╠Ё		         Ё		    Ё	        ЁChangeset 307885 Data 11/06/2015          Ё╠╠
╠╠хммммммммммммммоммммммммммомммммммммммомммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ*/

/*/
зддддддддддбддддддддддддддбддддддбдддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁInRhLibSx3ExecЁAutor ЁMarinaldo de Jesus   Ё Data Ё14/05/2003Ё
цддддддддддеддддддддддддддаддддддадддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁExecutar Funcoes Dentro de RHLIBSX3                          Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   ЁInRhLibSx3Exec( cExecIn , aFormParam )						 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁuRet                                                 	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁGenerico 													 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды/*/
Function InRhLibSx3Exec( cExecIn , aFormParam )
         
Local uRet

DEFAULT cExecIn		:= ""
DEFAULT aFormParam	:= {}

IF !Empty( cExecIn )
	cExecIn	:= BldcExecInFun( cExecIn , aFormParam )
	uRet	:= __ExecMacro( cExecIn )
EndIF

Return( uRet )

/*/
зддддддддддбддддддддддддддддбдддддбдддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁCpoUsado		ЁAutorЁMarinaldo de Jesus Ё Data Ё24/04/2004Ё
цддддддддддеддддддддддддддддадддддадддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o ЁVerifica se um Campo do Dicionario de Dados esta em Uso     Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁGenerico                  	                                Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды/*/
Function CpoUsado( cCpo , lMsGoto )

Local lUsado	:= .F.

Local cX3Usado
Local nX3Order
Local nX3Recno

Begin Sequence

	IF Empty( cCpo )
		Break
	EndIF

	nX3Order := SX3->( IndexOrd() )
	DEFAULT lMsGoto := .F.
	IF ( lMsGoto )
		nX3Recno	:= SX3->( Recno() )
	EndIF

	cX3Usado	:= GetSx3Cache( cCpo , "X3_USADO" )

	SX3->( dbSetOrder( nX3Order ) )
	IF ( lMsGoto )
		SX3->( MsGoTo( nX3Recno ) )
	EndIF	

	IF ( cX3Usado == NIL )
		Break
	EndIF

	lUsado := X3Uso( cX3Usado )

End Sequence

Return( lUsado )

/*/
зддддддддддбддддддддддддддддбдддддбдддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁCpoChkNivel		ЁAutorЁMarinaldo de Jesus Ё Data Ё09/09/2004Ё
цддддддддддеддддддддддддддддадддддадддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o ЁVerifica o Nivel do campo em Relacao ao Usuario             Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁGenerico                  	                                Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды/*/
Function CpoChkNivel( cCpo , lMsGoto )

Local lNivelOk	:= .F.

Local cX3Nivel
Local nX3Order
Local nX3Recno

Begin Sequence

	IF Empty( cCpo )
		Break
	EndIF

	nX3Order := SX3->( IndexOrd() )
	DEFAULT lMsGoto := .F.
	IF ( lMsGoto )
		nX3Recno	:= SX3->( Recno() )
	EndIF

	cX3Nivel	:= GetSx3Cache( cCpo , "X3_NIVEL" )

	SX3->( dbSetOrder( nX3Order ) )
	IF ( lMsGoto )
		SX3->( MsGoTo( nX3Recno ) )
	EndIF	

	IF ( cX3Nivel == NIL )
		Break
	EndIF

	lNivelOk := ( cNivel >= cX3Nivel )

End Sequence

Return( lNivelOk )

/*/
зддддддддддбддддддддддддддддбдддддбдддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁCpoObrigat		ЁAutorЁMarinaldo de Jesus Ё Data Ё10/08/2004Ё
цддддддддддеддддддддддддддддадддддадддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o ЁVerifica se um Campo do Dicionario de Dados eh Obrigatorio  Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁGenerico                  	                                Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды/*/
Function CpoObrigat( cCpo )

Local lCpoObrigat := .F.

Local cSx3Obrigat
Local cSx3Reserv

Begin Sequence

	IF ( ( cSx3Obrigat := GetSx3Cache( cCpo , "X3_OBRIGAT" ) ) == NIL )
		Break
	EndIF

	lCpoObrigat := (;
						(;
							CpoUsado( cCpo );
							.and.;
							( X3Obrigat( cSx3Obrigat ) );
						);	
						.or.;
						(;
							cSx3Reserv	:= GetSx3Cache( cCpo , "X3_RESERV" ),;
							VerByte( cSx3Reserv , 7 );
						);
					)	

End Sequence

Return( lCpoObrigat )

/*/
зддддддддддбддддддддддддддбддддддбдддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁAliasCpo	  ЁAutor ЁMarinaldo de Jesus   Ё Data Ё20/10/2004Ё
цддддддддддеддддддддддддддаддддддадддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁRetorna Alias conforme cCpo                         		 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁcAlias														 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁGenerico 													 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды/*/
Function AliasCpo( cCpo )

Local cAlias := GetSx3Cache( cCpo , "X3_ARQUIVO" )

Local nAt_	
Local nFieldPos

Begin Sequence

	IF ( cAlias <> NIL )
		Break
	EndIF

	nAt_ := At( "_" , cCpo )
	IF ( nAt_ == 0 )
		cAlias := ""
		Break
	EndIF

	cAlias := SubStr( cCpo , 1 , ( nAt_ - 1 ) )
	
	IF ( Len( cAlias ) == 2 )
		cAlias := ( "S" + cAlias )
	EndIF

	IF (;
			!CheckExecForm( { || nFieldPos := ( cAlias )->( FieldPos( cCpo ) ) } );
			.or.;
			( nFieldPos == 0 );
		)
		cAlias := ""
	EndIF

End Sequence

cAlias := Upper( cAlias )

Return( cAlias )

/*/
зддддддддддбддддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁCposInitWhenЁ Autor ЁMarinaldo de Jesus    Ё Data Ё06/08/2002Ё
цддддддддддеддддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁHabilitar a Execucao do When para campos do SX3              Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   ЁCposInitWhen( lInit )									 	 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁlInitWhen	-> .T. Habilita .F. Desabilita                 	 Ё
Ё          ЁlRetInit 	-> .T. Se When Habilitado ou Nao ou .T.			 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁlRet                                                 	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁX3_VALID de Todos os arquivos que possuem mais de 1 When     Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды/*/
Function CposInitWhen( lInitWhen , lRetInit )

Local lRet	:= .T.

Static lCposInitWhen

DEFAULT lInitWhen		:= .T.
DEFAULT lRetInit		:= .F.
DEFAULT lCposInitWhen	:= .T.

lInitWhen := IF( !( ValType( lInitWhen ) == "L" ) , .T. , lInitWhen )

IF !( lRetInit )
	IF !( lCposInitWhen == lInitWhen )
		lCposInitWhen := lInitWhen
	EndIF
EndIF

lRet := IF( lRetInit , lCposInitWhen , lRet )

Return( lRet )     

/*/
зддддддддддбддддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁfDescSX5    Ё Autor ЁRaquel Hager          Ё Data Ё16/03/2012Ё
цддддддддддеддддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁVerificacao de idioma para escolha correta de descricao.     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   ЁfDescSX5()           									 	 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁnTip -> 1 para retorno conteudo					             Ё  
Ё		   ЁnTip -> 2 para retorno campo				               	 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁcDesc                                               	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       Ёcsaa080, csar050                                             Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды/*/   
Function fDescSX5( nTip )    
Local cAuxDes	:= ""
Local nPos      := 0
Local aLang     := {}
Local cIdioma	:= FWRetIdiom()        //Retorna Idioma Atual

If nTip == 2
	If cIdioma == "pt-br" 
		cAuxDes := "X5_DESCRI"
	ElseIf cIdioma == "es"
		cAuxDes := "X5_DESCSPA"
	ElseIf cIdioma == "en" .Or. cIdioma == "ru"
		cAuxDes := "X5_DESCENG"
	EndIf
ElseIf nTip == 1
	cAuxDes := SX5->(X5DESCRI())
Endif

Return ( cAuxDes )        

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддддбдддддддбдддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o    Ё AlteraSX     Ё Autor Ё Andreia dos SantosЁ Data Ё 11.10.01 Ё╠╠
╠╠цддддддддддеддддддддддддддадддддддадддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Verifica os campos do SX3 incluindo-os ou Alterando-os     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   ЁAlteraSX(cSX,aRegs,cCampo,lAltera,nPos,cCpoComp,nInicio,nOrdem)Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ cSX     => Alias do SX a ser alterado                      Ё╠╠
╠╠Ё          Ё aRegs   => Array com os campos a serer alterados           Ё╠╠
╠╠Ё          Ё cCampo  => Campo a ser Buscado no SX3                      Ё╠╠
╠╠Ё          Ё lAltera => Define se o registro sera alterado ou incluido  Ё╠╠
╠╠Ё          Ё nPos    => Posicao no array onde se encontra o campo a ser Ё╠╠
╠╠Ё          Ё            comparado para ver se havera alteracao.         Ё╠╠
╠╠Ё          Ё cCpoComp=> Campo do arquivo a ser comparado para ver se    Ё╠╠
╠╠Ё          Ё            havera alteracao.                               Ё╠╠
╠╠Ё          Ё nInicio => Posicao na estrutura do campo a ser alterado.   Ё╠╠
╠╠Ё          Ё nOrdem  => Ordem do arquivo.                               Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso      Ё                                                            Ё╠╠
╠╠цддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ*/
Function AlteraSX(cSX,aRegs,cCampo,lAltera,nPos,cCpoComp,nInicio,nOrdem)

Local nSXOrder
Local lVerFalso
Local lCondicao := .T.
Local nX
Local nY

lAltera   := If(lAltera == NIL, .F., lAltera)
lVerFalso := If(lAltera, .F., .T.)

nSXOrder := (cSX)->(IndexOrd())
(cSX)->(dbSetOrder(nOrdem))

For nX:=1 to Len(aRegs)
	If lAltera
		lCondicao := ( (cSX)->(dbSeek(cCampo)) .And. &cCpoComp # aRegs[nX,nPos] )
	Else
		lCondicao := ( !(cSX)->(dbSeek(cCampo)) )
	EndIf
	If lCondicao
		RecLock(cSX,lVerFalso)
		For nY:=1 to FCount()
			If nY <= Len(aRegs[nX])
				(cSX)->(FieldPut(nInicio,aRegs[nX,nY]))
			EndIf                         
			nInicio++
		Next nY
		MsUnlock()
	EndIf
Next nX

(cSX)->(dbSetOrder(nSXOrder))
Return
