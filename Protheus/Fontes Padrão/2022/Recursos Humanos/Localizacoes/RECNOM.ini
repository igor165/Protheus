/*RECNOM.INI V1.2 - Modelo 2014 (LEMP) 20/03/2014*/
[XXX POSICIONAMENTOS]

[XXX INICIALIZACION]   
(PRE) SRVPD->(DbSetOrder(1)) 
(PRE) _aTotal[072] := SRA->RA_FILIAL
(PRE) _aTotal[073] := SRA->RA_MAT
(PRE) _aTotal[074] := ""
(PRE) _aTotal[075] := CFDCarEsp(Alltrim(SM0->M0_NOMECOM))
(PRE) _aTotal[076] := StrZero(Year(Date()),4) + "-" + StrZero(Month(Date()),2) + "-" + StrZero(Day(Date()),2) + "T" + Time() 
(PRE) _aTotal[077] := Alltrim(MV_PAR01)+Alltrim(MV_PAR02)+Alltrim(MV_PAR03)+Alltrim(MV_PAR04)
(PRE) _aTotal[078] := Alltrim(SRA->RA_MAT)+Alltrim(SRA->RA_FILIAL)
(PRE) _aTotal[098] := "|"
(PRE) _aTotal[099] := "||"
(PRE) _aTotal[100] := "" 

//CADENA  ORIGINAL
[SRA CADENAORIGINAL_SELLO]

(PRE) cCadOrig := _aTotal[099]
//COMPROBANTE
//version
(PRE) cCadOrig += "3.2" + _aTotal[098]
//:Serie
//(PRE) cCadOrig += Alltrim(_aTotal[078]) + _aTotal[098]
//Folio
//(PRE) cCadOrig += Alltrim(_aTotal[077]) + _aTotal[098]
//Fecha
(PRE) cCadOrig += Alltrim(_aTotal[076]) + _aTotal[098]
//tipoDeComprobante
(PRE) cCadOrig += Alltrim("egreso") + _aTotal[098]
//forma de pago
(PRE) cCadOrig += CFDCarEsp("Pago en una sola exhibicion")+ _aTotal[098]
//subtotal
(PRE) cCadOrig += Alltrim(STR(nTotPGrav+nTotPExen)) + _aTotal[098]  
//descuento
(PRE) cCadOrig += Alltrim(Str((nTotDGrav+nTotDExen)-nImpReten)) + _aTotal[098]
//total
(PRE) cCadOrig += Alltrim(STR(nTotPGrav+nTotPExen-(nTotDGrav+nTotDExen))) + _aTotal[098]
//metodo de pago
//(PRE) cCadOrig += if(Empty(ALLTRIM(SRA->RA_CTDEPSA)),"Transferencia","Deposito en cuenta bancaria") + _aTotal[098]
(PRE) cCadOrig += if(Empty(ALLTRIM(SRA->RA_CTDEPSA)),"No Identificado","No identificado") + _aTotal[098] 
//lugar de expedición
(PRE) cCadOrig += CFDCarEsp(AllTrim(RGC->RGC_CIDADE))+","+CFDCarEsp(AllTrim(RGC->RGC_ESTADO)) + _aTotal[098] 

//COMPROBANTE:EMISOR
//:RFC
(PRE) cCadOrig += Alltrim(SM0->M0_CGC) + _aTotal[098]
//:Nombre
(PRE) cCadOrig += Alltrim(SM0->M0_NOMECOM) + _aTotal[098]
//:Domicilio Fiscal
//:Calle
(PRE) cCadOrig += Alltrim(SM0->M0_ENDCOB) + _aTotal[098] 
//:Colonia
(PRE) cCadOrig += Alltrim(SM0->M0_BAIRCOB) + _aTotal[098]
//:Municipio
(PRE) cCadOrig += AllTrim(SM0->M0_CIDCOB) + _aTotal[098]
//:Estado
(PRE) cCadOrig += AllTrim(SM0->M0_ESTCOB) + _aTotal[098]
//:Pais
(PRE) cCadOrig += "MEXICO" + _aTotal[098]
//:Codigo postal
(PRE) cCadOrig += AllTrim(SM0->M0_CEPCOB) + _aTotal[098]
//regimen fiscal
(PRE) cCadOrig += If( !Empty(SM0->M0_DSCCNA), CFDCarEsp(Alltrim(SM0->M0_DSCCNA)), "REGIMEN GENERAL DE LEY PERSONAS MORALES" ) + _aTotal[098]
 
//COMPROBANTE:RECEPTOR
//:RFC
(PRE) cCadOrig += CFDCarEsp(AllTrim(SRA->RA_CIC)) + _aTotal[098]
//:Nombre
(PRE) cCadOrig += CFDCarEsp(Alltrim(SRA->RA_NOME)) + _aTotal[098]
//:Domicilio Fiscal
//Calle
(PRE) cCadOrig += CFDCarEsp(Alltrim(SRA->RA_ENDEREC))  + _aTotal[098]
//:Colonia
(PRE) cCadOrig += CFDCarEsp(Alltrim(SRA->RA_BAIRRO)) + _aTotal[098]
//Municipio
(PRE) DBSELECTAREA("CC2")
(PRE) CC2->( DBGoTop() )
(PRE) cCadOrig += AllTrim(POSICIONE("CC2",3,xFilial("CC2") + ALLTRIM(SRA->RA_MUNICIP), "CC2_MUN")) + _aTotal[098]
//Estado                                                                                      
(PRE) cCadOrig += AllTrim(POSICIONE("SX5",1,xFilial("SX5") + "12" + SRA->RA_ESTADO, "X5_DESCSPA")) + _aTotal[098]  
//Pais
(PRE) cCadOrig += AllTrim(POSICIONE("SX5",1,xFilial("SX5") + "BH" + SRA->RA_PAIS, "X5_DESCSPA"))  + _aTotal[098]
//Codigo postal
(PRE) cCadOrig += AllTrim(SRA->RA_CEP) + _aTotal[098]

//COMPROBANTE:CONCEPTOS
//:Cantidad
(PRE) cCadOrig += Alltrim("1")+ _aTotal[098]
//:Unidad de medida
(PRE) cCadOrig += Alltrim("Servicio")+ _aTotal[098]
//:Descripcion
(PRE) cCadOrig += AllTrim(POSICIONE("SRY",1,xFilial("SRY") + cRoteiro, "RY_DESC")) + _aTotal[098]
//:valorUnitario
(PRE) cCadOrig += Alltrim(Str(nTotPGrav+nTotPExen)) + _aTotal[098]
//Importe
(PRE) cCadOrig += Alltrim(Str(nTotPGrav+nTotPExen)) + _aTotal[098]

//COMPROBANTE:IMPUESTOS
(PRE) (Iif ((Alltrim(SRVPD->RV_TIPO) =="3"),.T.,.F.)) 
//:Impuesto
(PRE) (cCadOrig += Alltrim(SRVPD->RV_DESCDET) + _aTotal[098],.T.)
//:Importe
(PRE) (cCadOrig += Alltrim(Str(SRVPD->RC_VALOR)) + _aTotal[098],.T.)
//:totalImpuestosRetenidos
(PRE) cCadOrig += AllTrim(Str(nImpReten)) + _aTotal[098]
//totalImpuestosTrasladados
(PRE) cCadOrig += "0" + _aTotal[098]

//DATOS DEL EMPLEADO: 
//a. Informacion del nodo nomina 
//:Version
(PRE) cCadOrig += "1.1" + _aTotal[098]
//:RegistroPatronal  
(PRE) cCadOrig += Alltrim(cRegPatr) + _aTotal[098]
//:NumEmpleado
(PRE) cCadOrig += Alltrim(SRA->RA_MAT) + _aTotal[098]
//:CURP
(PRE) cCadOrig += Alltrim(SRA->RA_CURP) + _aTotal[098]
//:TipoRegimen 
(PRE) cCadOrig += Alltrim(SRA->RA_TIPREG) + _aTotal[098]
//:NumSeguridadSocial
(PRE) cCadOrig += Alltrim(SRA->RA_RG) + _aTotal[098]
//:FechaPago 
(PRE) cCadOrig += Alltrim(STR(YEAR(dFchPag)))+"-"+ STRZERO(MONTH(dFchPag),2) +"-"+STRZERO(DAY(dFchPag),2) + _aTotal[098]
//:FechaInicialPago
(PRE) cCadOrig += Alltrim(STR(YEAR(dFchInPag)))+"-"+ STRZERO(MONTH(dFchInPag),2) +"-"+STRZERO(DAY(dFchInPag),2) + _aTotal[098]
//:FechaFinalPago
(PRE) cCadOrig += Alltrim(STR(YEAR(dFchFiPag)))+"-"+ STRZERO(MONTH(dFchFiPag),2) +"-"+STRZERO(DAY(dFchFiPag),2) + _aTotal[098]
//:NumDiasPagados
(PRE) cCadOrig += Alltrim(Str(nDiasPag)) + _aTotal[098]
//:Departamento
(PRE) cCadOrig += Alltrim(cDeptoIm) + _aTotal[098]
//:CLABE
(PRE) cCadOrig += Alltrim(SRA->RA_CLABE) + _aTotal[098]   
//:BANCO
(PRE) cCadOrig += Alltrim(cBcoCfdi) + _aTotal[098]
//:FechaInicioRelLaboral
(PRE) cCadOrig += Alltrim(STR(YEAR(dFchInLab)))+"-"+ STRZERO(MONTH(dFchInLab),2) +"-"+STRZERO(DAY(dFchInLab),2) + _aTotal[098]
//:Antiguedad 
(PRE) cCadOrig += Alltrim(Str(nAntigue)) + _aTotal[098]
//:Puesto
(PRE) cCadOrig += Alltrim(cPuesCfdi) + _aTotal[098]
//:TipoContrato  
(PRE) cCadOrig += CFDCarEsp(Alltrim(fDescRCC("S028",SRA->RA_TIPCON, 1,2,3,50))) + _aTotal[098]
//:TipoJornada
(PRE) cCadOrig += Alltrim(cTipJorn) + _aTotal[098]
//:PeriodicidadPago
(PRE) cCadOrig += CFDCarEsp(Alltrim(fDescRCC("S029",cPerCFDi,1,2,3,100)))+ _aTotal[098]
//:SalarioBaseCotApor
(PRE) cCadOrig += Alltrim(Str(SRA->RA_SALINT)) + _aTotal[098]  
//:RiesgoPuesto
(PRE) cCadOrig += Alltrim(SRJ->RJ_RIESGO) + _aTotal[098]     
//:SalarioDiarioIntegrado
(PRE) cCadOrig += Alltrim(Str(SRA->RA_SALINT)) + _aTotal[098]           

//b. Informacion del nodo Percepciones
//:TotalGravado
(PRE) cCadOrig += Iif(nTotPGrav+nTotPExen!=0 .Or. nConsPer!=0,Alltrim(Str(nTotPGrav)) + _aTotal[098],"")
//:TotalExento
(PRE) cCadOrig += Iif(nTotPGrav+nTotPExen!=0 .Or. nConsPer!=0,Alltrim(Str(nTotPExen)) + _aTotal[098],"")

//c. Informacion del nodo Percepcion (Nota:Esta secuencia debera ser repetida por cada nodo Percepcion relacionado)
//Arma cadena: 1-Percepciones (SRVPD)
(PRE) VldCadena("1")

//d. Informacion del nodo Deducciones
//:TotalGravado
(PRE) cCadOrig += Iif(nTotDGrav+nTotDExen!=0 .Or. nConsDed!=0,Alltrim(Str(nTotDGrav)) + _aTotal[098],"")
//:TotalExento
(PRE) cCadOrig += Iif(nTotDGrav+nTotDExen!=0 .Or. nConsDed!=0,Alltrim(Str(nTotDExen)) + _aTotal[098],"")

//e. Informacion del nodo Deduccion (Nota:Esta secuencia debera ser repetida por cada nodo Deduccion relacionado)
//Arma cadena: 2-Deducciones (SRVPD)
(PRE) VldCadena("2")

//f. Informacion del nodo Incapacidad (Nota:Esta secuencia debera ser repetida por cada nodo Incapacidad relacionado)
//Arma cadena: 3-Incapacidades (SRCIN)
(PRE) VldCadena("3")  

//g. Informacion del nodo Horas Extra (Nota:Esta secuencia debera ser repetida por cada nodo Horas Extra relacionado)
//Arma cadena: 4-Horas Extra (SRCEX)
(PRE) VldCadena("4") 
 
(PRE) cCadOrig += _aTotal[098]
(POS) _aTotal[074] := ENCODEUTF8(cCadOrig)
(POS) cCadOrig := ENCODEUTF8(cCadOrig)
//Sello
(POS) _aTotal[100] := LjHex2Asc(SHA1(cCadOrig,2))
(POS) _aTotal[100] := PrivSignRSA(&(SuperGetMv("MV_CFDDIRS",,""))+SuperGetMv("MV_CFDI_KP",,""),_aTotal[100],2,"assinatura")
(POS) _aTotal[100] := ENCODE64(_aTotal[100])

//                                          C O N F I G U R A C I O N    D E L    A R C H I V O :    R E C N O M . INI
[XXX CABECERA]
Linha1     C 041 0 Chr(239) + Chr(187) + Chr(191) + '<?xml version="1.0" encoding="UTF-8"?>'

//CFDI:  CFDI:COMPROBANTE
[XXX CFDI]

//Certificado
//aaa010101aaa__csd_01c.pem AAA010101AAA - pruebas SAT
(PRE) cCert01 := "MIIEdDCCA1ygAwIBAgIUMjAwMDEwMDAwMDAxMDAwMDU4NjcwDQYJKoZIhvcNAQEF"
(PRE) cCert01 += "BQAwggFvMRgwFgYDVQQDDA9BLkMuIGRlIHBydWViYXMxLzAtBgNVBAoMJlNlcnZp"
(PRE) cCert01 += "Y2lvIGRlIEFkbWluaXN0cmFjacOzbiBUcmlidXRhcmlhMTgwNgYDVQQLDC9BZG1p"
(PRE) cCert01 += "bmlzdHJhY2nDs24gZGUgU2VndXJpZGFkIGRlIGxhIEluZm9ybWFjacOzbjEpMCcG"
(PRE) cCert01 += "CSqGSIb3DQEJARYaYXNpc25ldEBwcnVlYmFzLnNhdC5nb2IubXgxJjAkBgNVBAkM"
(PRE) cCert01 += "HUF2LiBIaWRhbGdvIDc3LCBDb2wuIEd1ZXJyZXJvMQ4wDAYDVQQRDAUwNjMwMDEL"
(PRE) cCert01 += "MAkGA1UEBhMCTVgxGTAXBgNVBAgMEERpc3RyaXRvIEZlZGVyYWwxEjAQBgNVBAcM"
(PRE) cCert01 += "CUNveW9hY8OhbjEVMBMGA1UELRMMU0FUOTcwNzAxTk4zMTIwMAYJKoZIhvcNAQkC"
(PRE) cCert01 += "DCNSZXNwb25zYWJsZTogSMOpY3RvciBPcm5lbGFzIEFyY2lnYTAeFw0xMjA3Mjcx"
(PRE) cCert01 += "NzAyMDBaFw0xNjA3MjcxNzAyMDBaMIHbMSkwJwYDVQQDEyBBQ0NFTSBTRVJWSUNJ"
(PRE) cCert01 += "T1MgRU1QUkVTQVJJQUxFUyBTQzEpMCcGA1UEKRMgQUNDRU0gU0VSVklDSU9TIEVN"
(PRE) cCert01 += "UFJFU0FSSUFMRVMgU0MxKTAnBgNVBAoTIEFDQ0VNIFNFUlZJQ0lPUyBFTVBSRVNB"
(PRE) cCert01 += "UklBTEVTIFNDMSUwIwYDVQQtExxBQUEwMTAxMDFBQUEgLyBIRUdUNzYxMDAzNFMy"
(PRE) cCert01 += "MR4wHAYDVQQFExUgLyBIRUdUNzYxMDAzTURGUk5OMDkxETAPBgNVBAsTCFVuaWRh"
(PRE) cCert01 += "ZCAxMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC2TTQSPONBOVxpXv9wLYo8"
(PRE) cCert01 += "jezBrb34i/tLx8jGdtyy27BcesOav2c1NS/Gdv10u9SkWtwdy34uRAVe7H0a3VMR"
(PRE) cCert01 += "LHAkvp2qMCHaZc4T8k47Jtb9wrOEh/XFS8LgT4y5OQYo6civfXXdlvxWU/gdM/e6"
(PRE) cCert01 += "I2lg6FGorP8H4GPAJ/qCNwIDAQABox0wGzAMBgNVHRMBAf8EAjAAMAsGA1UdDwQE"
(PRE) cCert01 += "AwIGwDANBgkqhkiG9w0BAQUFAAOCAQEATxMecTpMbdhSHo6KVUg4QVF4Op2IBhiM"
(PRE) cCert01 += "aOrtrXBdJgzGotUFcJgdBCMjtTZXSlq1S4DG1jr8p4NzQlzxsdTxaB8nSKJ4KEMg"
(PRE) cCert01 += "IT7E62xRUj15jI49qFz7f2uMttZLNThipunsN/NF1XtvESMTDwQFvas/Ugig6qwE"
(PRE) cCert01 += "fSZc0MDxMpKLEkEePmQwtZD+zXFSMVa6hmOu4M+FzGiRXbj4YJXn9Myjd8xbL/c+"
(PRE) cCert01 += "9UIcrYoZskxDvMxc6/6M3rNNDY3OFhBK+V/sPMzWWGt8S1yjmtPfXgFs1t65AZ2h"
(PRE) cCert01 += "cTwTAuHrKwDatJ1ZPfa482ZBROAAX1waz7WwXp0gso7sDCm2/yUVww=="

(PRE) if (SM0->M0_CODIGO == '01', cCert := cCert01,cCert := cCert01)

(PRE) _aTotal[001] := '<cfdi:Comprobante'
(PRE) _aTotal[001] += ' xmlns:cfdi="http://www.sat.gob.mx/cfd/3"'
(PRE) _aTotal[001] += ' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'
(PRE) _aTotal[001] += ' xsi:schemaLocation="http://www.sat.gob.mx/cfd/3 http://www.sat.gob.mx/sitio_internet/cfd/3/cfdv32.xsd"'
(PRE) _aTotal[001] += ' version="3.2"'
(PRE) _aTotal[001] += ' serie="' + _aTotal[078] + '"'
(PRE) _aTotal[001] += ' folio="' + _aTotal[077] + '"'
(PRE) _aTotal[001] += ' fecha="' + _aTotal[076]+ '"'  
(PRE) _aTotal[001] += ' sello="' + Alltrim(_aTotal[100]) + '"'
(PRE) _aTotal[001] += ' formaDePago="' + CFDCarEsp("Pago en una sola exhibicion")+ '"'
(PRE) _aTotal[001] += ' noCertificado="' + SuperGetMv("MV_CFDI_CS",,"") + '"'   
(PRE) _aTotal[001] += ' certificado="' + cCert + '"'
(PRE) _aTotal[001] += ' subTotal="' + Alltrim(STR(nTotPGrav+nTotPExen)) + '"'
(PRE) _aTotal[001] += ' total="' + Alltrim(STR(nTotPGrav+nTotPExen-(nTotDGrav+nTotDExen))) + '"'
(PRE) _aTotal[001] += ' descuento="' + Alltrim(Str((nTotDGrav+nTotDExen)-nImpReten)) + '"'
(PRE) _aTotal[001] += ' tipoDeComprobante="' + Alltrim("egreso") + '"'
//(PRE) _aTotal[001] += ' metodoDePago="' + if(Empty(ALLTRIM(SRA->RA_CTDEPSA)),"Transferencia","Deposito en cuenta bancaria") + '"'
(PRE) _aTotal[001] += ' metodoDePago="' + if(Empty(ALLTRIM(SRA->RA_CTDEPSA)),"No Identificado","No identificado") + '"'
(PRE) _aTotal[001] += ' LugarExpedicion="' + CFDCarEsp(AllTrim(RGC->RGC_CIDADE))+","+CFDCarEsp(AllTrim(RGC->RGC_ESTADO)) + '"'
(PRE) _aTotal[001] += '>'
(PRE) _aTotal[001] := ENCODEUTF8(_aTotal[001])
(PREREG) _aTotal[001]

//COMPROBANTE:  CFDI:EMISOR
[XXX EMISOR]
(PRE) _aTotal[001] := '    <cfdi:Emisor'
(PRE) _aTotal[001] += ' rfc="' + CFDCarEsp(Alltrim(SM0->M0_CGC)) + '"'
(PRE) _aTotal[001] += ' nombre="' + _aTotal[075] + '"'
(PRE) _aTotal[001] += '>'
(PRE) _aTotal[001] := ENCODEUTF8(_aTotal[001])
(PRE) _aTotal[002] := '        <cfdi:DomicilioFiscal' 
(PRE) _aTotal[002] += ' calle="' + CFDCarEsp(Alltrim(SM0->M0_ENDCOB)) + '"'
(PRE) _aTotal[002] += ' colonia="' + CFDCarEsp(Alltrim(SM0->M0_BAIRCOB)) + '"'
(PRE) _aTotal[002] += ' municipio="' + CFDCarEsp(AllTrim(SM0->M0_CIDCOB)) + '"'
(PRE) _aTotal[002] += ' estado="' + CFDCarEsp(AllTrim(SM0->M0_ESTCOB)) + '"'
(PRE) _aTotal[002] += ' pais="' + "MEXICO" + '"'
(PRE) _aTotal[002] += ' codigoPostal="' + AllTrim(SM0->M0_CEPCOB) + '"'
(PRE) _aTotal[002] += '/>'
(PRE) _aTotal[002] := ENCODEUTF8(_aTotal[002])
(PRE) _aTotal[003] := '        <cfdi:RegimenFiscal' 
(PRE) _aTotal[003] += ' Regimen="' + If( !Empty(SM0->M0_DSCCNA), CFDCarEsp(Alltrim(SM0->M0_DSCCNA)), "REGIMEN GENERAL DE LEY PERSONAS MORALES" ) + '"'
(PRE) _aTotal[003] += '/>'
(PRE) _aTotal[003] := ENCODEUTF8(_aTotal[003])
(PREREG) _aTotal[001]
(PREREG) _aTotal[002]
(PREREG) _aTotal[003]
EMISOR     C 018 0 ENCODEUTF8(XMLConv("",,,"cfdi:Emisor",.F.,.T.,4))

//COMPROBANTE:  CFDI:RECEPTOR
[XXX RECEPTOR]
(PREREG) (_aTotal[001] := '    <cfdi:Receptor' , .T.)
(PREREG) (_aTotal[001] += ' rfc="' + CFDCarEsp(AllTrim(SRA->RA_CIC)) + '"' , .T.)
(PREREG) (_aTotal[001] += ' nombre="' + CFDCarEsp(Alltrim(SRA->RA_NOME)) + '"' , .T.)
(PREREG) (_aTotal[001] += '>' ,.T.)
(PREREG) (_aTotal[001] := ENCODEUTF8(_aTotal[001]) , .T.)
(PREREG) (_aTotal[002] := '        <cfdi:Domicilio' , .T.)
(PREREG) (_aTotal[002] += ' calle="' + CFDCarEsp(Alltrim(SRA->RA_ENDEREC)) + '"' , .T.)
(PREREG) (_aTotal[002] += ' colonia="' + CFDCarEsp(Alltrim(SRA->RA_BAIRRO)) + '"' , .T.)
(PREREG) (_aTotal[002] += ' municipio="' + AllTrim(POSICIONE("CC2",3,xFilial("CC2") + ALLTRIM(SRA->RA_MUNICIP), "CC2_MUN")) + '"' , .T.)
(PREREG) (_aTotal[002] += ' estado="' + AllTrim(POSICIONE("SX5",1,xFilial("SX5") + "12" + SRA->RA_ESTADO, "X5_DESCSPA")) + '"' , .T.)
(PREREG) (_aTotal[002] += ' pais="' + AllTrim(POSICIONE("SX5",1,xFilial("SX5") + "BH" + SRA->RA_PAIS, "X5_DESCSPA")) + '"' , .T.)
(PREREG) (_aTotal[002] += ' codigoPostal="' + AllTrim(SRA->RA_CEP) + '"' , .T.)
(PREREG) (_aTotal[002] += '/>' , .T.)
(PREREG) (_aTotal[002] := ENCODEUTF8(_aTotal[002]) , .T.)
(PREREG) _aTotal[001]
(PREREG) _aTotal[002]
RECEPTOR   C 020 0 ENCODEUTF8(XMLConv("",,,"cfdi:Receptor",.F.,.T.,4))

//COMPROBANTE:  CFDI:COCEPTOS
[XXX CONCEPTOS]
CONCEPTOS  C 021 0 ENCODEUTF8(XMLConv("",,,"cfdi:Conceptos",.T.,.F.,4))

[XXX CONCEPTO]
(PREREG) (_aTotal[002] := '        <cfdi:Concepto',.T.)
(PREREG) (_aTotal[002] += ' cantidad="' + Alltrim("1") + '"',.T.)
(PREREG) (_aTotal[002] += ' unidad="' + Alltrim("Servicio") + '"',.T.)
(PREREG) (_aTotal[002] += ' descripcion="' + AllTrim(POSICIONE("SRY",1,xFilial("SRY") + cRoteiro, "RY_DESC")) + '"',.T.)
(PREREG) (_aTotal[002] += ' valorUnitario="' + Alltrim(Str(nTotPGrav+nTotPExen)) + '"',.T.)
(PREREG) (_aTotal[002] += ' importe="' + Alltrim(Str(nTotPGrav+nTotPExen)) + '"',.T.)
(PREREG) (_aTotal[002] += '/>',.T.)
(PREREG) (_aTotal[078] ++,.T.)
(PREREG) ENCODEUTF8(_aTotal[002])

[XXX CONCEPTOS]
CONCEPTOS  C 021 0 ENCODEUTF8(XMLConv("",,,"cfdi:Conceptos",.F.,.T.,4))

[XXX IMPUESTOS]  
(PRE) _aTotal[001] := '<cfdi:Impuestos'
(PRE) _aTotal[001] += ' totalImpuestosRetenidos="' + AllTrim(Str(nImpReten)) + '" '
(PRE) _aTotal[001] += ' totalImpuestosTrasladados="' + AllTrim(Str(0)) + '" >'
(PRE) _aTotal[001] := ENCODEUTF8(_aTotal[001])
(PREREG) _aTotal[001] 
 
[XXX RETENCIONS]
(PRE) _aTotal[001] := '<cfdi:Retenciones >'
(PRE) _aTotal[001] := ENCODEUTF8(_aTotal[001])
(PREREG) _aTotal[001]

[SRVPD RETENIDOS]
(PRE) SRVPD->(DbGotop ())
(PREREG) ( Iif ((Alltrim(SRVPD->RV_TIPO) =="3" ),.T.,.F.))
(PREREG) (_aTotal[002] := ' <cfdi:Retencion impuesto="' + Alltrim(SRVPD->RV_DESCDET) + '"',.T.)
(PREREG) (_aTotal[002] += ' importe="' + Alltrim(Str(SRVPD->RC_VALOR)) + '"',.T.)
(PREREG) (_aTotal[002] += '/>',.T.)
(PREREG) ENCODEUTF8(_aTotal[002]) 

[XXX RETENCIONES]
RETENCIONS C 030 0 ENCODEUTF8(XMLConv("",,,"cfdi:Retenciones",.F.,.T.,4)) 

[XXX IMPUESTOS]
IMPUESTOS  C 021 0 ENCODEUTF8(XMLConv("",,,"cfdi:Impuestos",.F.,.T.,4))

//COMPLEMENTO:  CFDI:COMPLEMENTO
[XXX COMPLEM]
COMPLEM    C 023 0 ENCODEUTF8(XMLConv("",,,"cfdi:Complemento",.T.,.F.,4))

//COMPLEMENTO:  NOMINA:NOMINA
[XXX NOMINA]
(PRE) _aTotal[001] := '<nomina:Nomina '      
(PRE) _aTotal[001] += ' xmlns:cfdi="http://www.sat.gob.mx/cfd/3"'
(PRE) _aTotal[001] += ' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" '
(PRE) _aTotal[001] += ' xmlns:nomina="http://www.sat.gob.mx/nomina"'
(PRE) _aTotal[001] += ' xsi:schemaLocation="http://www.sat.gob.mx/cfd/3 http://www.sat.gob.mx/sitio_internet/cfd/3/cfdv3.xsd http://www.sat.gob.mx/nomina http://www.sat.gob.mx/sitio_internet/cfd/nomina/nomina11.xsd"'
(PRE) _aTotal[001] += ' Version="1.1"' 
(PRE) _aTotal[001] += ' RegistroPatronal="' + Alltrim(cRegPatr) +'" '
(PRE) _aTotal[001] += ' NumEmpleado="' + Alltrim(SRA->RA_MAT) +'" '
(PRE) _aTotal[001] += ' CURP="' + Alltrim(SRA->RA_CURP) + '" '
(PRE) _aTotal[001] += ' TipoRegimen="' + Alltrim(SRA->RA_TIPREG) + '" '
(PRE) _aTotal[001] += ' NumSeguridadSocial="' + Alltrim(SRA->RA_RG) +'" '
(PRE) _aTotal[001] += ' FechaPago="' + Alltrim(STR(YEAR(dFchPag)))+"-"+ STRZERO(MONTH(dFchPag),2) +"-"+STRZERO(DAY(dFchPag),2)+ '" '        
(PRE) _aTotal[001] += ' FechaInicialPago="' + Alltrim(STR(YEAR(dFchInPag)))+"-"+ STRZERO(MONTH(dFchInPag),2) +"-"+STRZERO(DAY(dFchInPag),2)+ '" '
(PRE) _aTotal[001] += ' FechaFinalPago="' + Alltrim(STR(YEAR(dFchFiPag)))+"-"+ STRZERO(MONTH(dFchFiPag),2) +"-"+STRZERO(DAY(dFchFiPag),2)+ '" '
(PRE) _aTotal[001] += ' NumDiasPagados="' + Alltrim(Str(nDiasPag)) + '" '
(PRE) _aTotal[001] += ' Departamento="' + Alltrim(cDeptoIm) + '" '
//(PRE) _aTotal[001] += ' CLABE="' + Alltrim(SRA->RA_CLABE) + '" '
(PRE) _aTotal[001] += ' Banco="' + Alltrim(cBcoCfdi) + '" '
(PRE) _aTotal[001] += ' CLABE="' + IF((SRY->RY_CALCULO="19"),Alltrim(SRA->RA_CLABEVA),Alltrim(SRA->RA_CLABE)) + '" '
//(PRE) _aTotal[001] += ' Banco="' + if((SRY->RY_CALCULO="19"),Alltrim(SRA->RA_BANVAL),Alltrim(cBcoCfdi)) + '" '

(PRE) _aTotal[001] += ' FechaInicioRelLaboral="' + Alltrim(STR(YEAR(dFchInLab)))+"-"+ STRZERO(MONTH(dFchInLab),2) +"-"+STRZERO(DAY(dFchInLab),2) + '" '
(PRE) _aTotal[001] += ' Antiguedad="' + Alltrim(Str(nAntigue)) + '" '
(PRE) _aTotal[001] += ' Puesto="' + Alltrim(cPuesCfdi) + '" '
(PRE) _aTotal[001] += ' TipoContrato="' + CFDCarEsp(Alltrim(fDescRCC("S028",SRA->RA_TIPCON,1,2,3,50))) + '" '
(PRE) _aTotal[001] += ' TipoJornada="' + Alltrim(cTipJorn) + '" '   
(PRE) _aTotal[001] += ' PeriodicidadPago="' + CFDCarEsp(Alltrim(fDescRCC("S029",cPerCFDi,1,2,3,100))) + '" '
(PRE) _aTotal[001] += ' SalarioBaseCotApor="' + Alltrim(Str(SRA->RA_SALINT)) + '" '
(PRE) _aTotal[001] += ' RiesgoPuesto="' + Alltrim(SRJ->RJ_RIESGO) + '" '
(PRE) _aTotal[001] += ' SalarioDiarioIntegrado="' + Alltrim(Str(SRA->RA_SALINT)) + '" '
(PRE) _aTotal[001] += '>'
(PRE) _aTotal[001] := ENCODEUTF8(_aTotal[001])
(PREREG) _aTotal[001]

//COMPLEMENTO:  NOMINA:PERCEPCIONES
[XXX PERCEPCION]    
(PRE) SRVPD->(DbGotop())
(PREREG) ( Iif ((Alltrim(SRVPD->RV_TIPO) =="1"),.T.,.F.))
(PRE) _aTotal[002] := '<nomina:Percepciones'
(PRE) _aTotal[002] += ' TotalGravado="' + Alltrim(Str(nTotPGrav)) + '" '
(PRE) _aTotal[002] += ' TotalExento="' + Alltrim(Str(nTotPExen)) + '"  >'
(PRE) _aTotal[002] := ENCODEUTF8(_aTotal[002])
(PREREG) _aTotal[002]

[SRVPD PERCEPCION]
(PRE) SRVPD->(DbGotop())
(PREREG) ( Iif ((Alltrim(SRVPD->RV_TIPO) =="1"),.T.,.F.))
(PREREG) (_aTotal[002] := ' <nomina:Percepcion',.T.)
(PREREG) (_aTotal[002] += ' TipoPercepcion="' + Alltrim(Substr(SRVPD->RV_TIPSAT,1,3)) + '"',.T.)
(PREREG) (_aTotal[002] += ' Clave="' + Alltrim(SRVPD->RV_COD) + '"',.T.)
(PREREG) (_aTotal[002] += ' Concepto="' + Alltrim(SRVPD->RV_DESCDET) + '"',.T.)
(PREREG) (_aTotal[002] += ' ImporteGravado="' + Alltrim(Str(SRVPD->RC_VALORGV)) + '"',.T.)
(PREREG) (_aTotal[002] += ' ImporteExento="' + Alltrim(Str(SRVPD->RC_VALOREX)) + '"',.T.)
(PREREG) (_aTotal[002] += '/>',.T.)
(PREREG) ENCODEUTF8(_aTotal[002])   

[XXX PERCEPCION] 
(PRE) SRVPD->(DbGotop())
(PREREG) ( Iif ((Alltrim(SRVPD->RV_TIPO) =="1"),.T.,.F.))
PERCEPCION C 030 0 ENCODEUTF8(XMLConv("",,,"nomina:Percepciones",.F.,.T.,8))

//COMPLEMENTO:  NOMINA:DEDUCCIONES
[XXX DEDUCCIONS]
(PRE) DBSELECTAREA("SRVPD")
(PRE) SRVPD->(DbGotop()) 
(PRE) DbSeek(_aTotal[072]+_aTotal[073]+"2") 
(PREREG) ( Iif ((Alltrim(SRVPD->RV_TIPO) =="2"),.T.,.F.))
(PRE) _aTotal[002] := '<nomina:Deducciones'
(PRE) _aTotal[002] += ' TotalGravado="' + Alltrim(Str(nTotDGrav)) + '" '
(PRE) _aTotal[002] += ' TotalExento="' + Alltrim(Str(nTotDExen)) + '" >'
(PRE) _aTotal[002] := ENCODEUTF8(_aTotal[002])
(PREREG) _aTotal[002]

[SRVPD DEDUCCION]  
(PREREG) ( Iif ((Alltrim(SRVPD->RV_TIPO) =="2"),.T.,.F.))
(PREREG) (_aTotal[002] := ' <nomina:Deduccion',.T.)
(PREREG) (_aTotal[002] += ' TipoDeduccion="' + Alltrim(Substr(SRVPD->RV_TIPSAT,1,3)) + '"',.T.)
(PREREG) (_aTotal[002] += ' Clave="' + Alltrim(SRVPD->RV_COD) + '"',.T.)
(PREREG) (_aTotal[002] += ' Concepto="' + Alltrim(SRVPD->RV_DESCDET) + '"',.T.)
(PREREG) (_aTotal[002] += ' ImporteGravado="' + Alltrim(Str(SRVPD->RC_VALORGV)) + '"',.T.)
(PREREG) (_aTotal[002] += ' ImporteExento="' + Alltrim(Str(SRVPD->RC_VALOREX)) + '"',.T.)
(PREREG) (_aTotal[002] += '/>',.T.)
(PREREG) ENCODEUTF8(_aTotal[002]) 

[XXX DEDUCCIONS] 
(PRE) DBSELECTAREA("SRVPD")
(PRE) SRVPD->(DbGotop()) 
(PRE) DbSeek(_aTotal[072]+_aTotal[073]+"2")  
(PREREG) ( Iif ((Alltrim(SRVPD->RV_TIPO) =="2"),.T.,.F.))
DEDUCCIONS C 030 0 ENCODEUTF8(XMLConv("",,,"nomina:Deducciones",.F.,.T.,8))

[XXX INCAPACIDS] 
(PRE) SRCIN->(DbGotop()) 
(PREREG) Iif(!SRCIN->(Eof()),.T.,.F. )
(PRE) _aTotal[001] := '<nomina:Incapacidades>'
(PRE) _aTotal[001] := ENCODEUTF8(_aTotal[001])
(PREREG) _aTotal[001]

//COMPLEMENTO:  NOMINA:INCAPACIDAD
[SRCIN INCAPACIDAD]
(PRE) SRCIN->(DbGotop())
(PREREG) (_aTotal[002] := ' <nomina:Incapacidad',.T.)
(PREREG) (_aTotal[002] += ' DiasIncapacidad="' + Alltrim(Str(SRCIN->RC_HORAS)) + '"',.T.)
(PREREG) (_aTotal[002] += ' TipoIncapacidad="' + Alltrim(SRCIN->RCM_TIPSAT) + '"',.T.)
(PREREG) (_aTotal[002] += ' Descuento="' + Alltrim(Str(SRCIN->RC_VALOR)) + '"',.T.)
(PREREG) (_aTotal[002] += '/>',.T.)
(PREREG) ENCODEUTF8(_aTotal[002])

[XXX INCAPACIDAD]  
(PRE) SRCIN->(DbGotop()) 
(PREREG) Iif(!SRCIN->(Eof()),.T.,.F. )
INCAPACIDAD C 030 0 ENCODEUTF8(XMLConv("",,,"nomina:Incapacidad",.F.,.T.,8))

[XXX INCAPACIDS] 
(PRE) SRCIN->(DbGotop()) 
(PREREG) Iif(!SRCIN->(Eof()),.T.,.F. )
INCAPACIDS C 031 0 ENCODEUTF8(XMLConv("",,,"nomina:Incapacidades",.F.,.T.,8))

[XXX HREXTRA]     
(PRE) SRCEX->(DbGotop()) 
(PREREG) Iif(!SRCEX->(Eof()),.T.,.F. )
(PRE) _aTotal[001] := '<nomina:HorasExtras>'
(PRE) _aTotal[001] := ENCODEUTF8(_aTotal[001])
(PREREG) _aTotal[001]

//COMPLEMENTO:  NOMINA:HORASEXTRA
[SRCEX HORASEXTRAS]
(PRE) SRCEX->(DbGotop())
(PREREG) (_aTotal[002] := ' <nomina:HorasExtra',.T.)
(PREREG) (_aTotal[002] += ' Dias="' + Alltrim(Str(SRCEX->RGB_DUM)) + '"',.T.)
(PREREG) (_aTotal[002] += ' TipoHoras="' + Alltrim(SRCEX->RV_CODFOL) + '"',.T.)
(PREREG) (_aTotal[002] += ' HorasExtra="' + Alltrim(Str(SRCEX->RC_HORAS)) + '"',.T.)
(PREREG) (_aTotal[002] += ' ImportePagado="' + Alltrim(Str(SRCEX->RC_VALOR)) + '"',.T.)
(PREREG) (_aTotal[002] += '/>',.T.)
(PREREG) ENCODEUTF8(_aTotal[002])    

[XXX HORASEXTRAS]
(PRE) SRCEX->(DbGotop ()) 
(PREREG) Iif(!SRCEX->(Eof()),.T.,.F. )    
HORASEXTRAS C 030 0 ENCODEUTF8(XMLConv("",,,"nomina:HorasExtra",.F.,.T.,8))  

[XXX HREXTRA]
(PRE) SRCEX->(DbGotop ()) 
(PREREG) Iif(!SRCEX->(Eof()),.T.,.F. )                                    
HREXTRA    C 032 0 ENCODEUTF8(XMLConv("",,,"nomina:HorasExtras",.F.,.T.,8))

[XXX NOMINA]  
NOMINA     C 021 0 ENCODEUTF8(XMLConv("",,,"nomina:Nomina",.F.,.T.,4))

[XXX COMPLEM]  
COMPLEM    C 023 0 ENCODEUTF8(XMLConv("",,,"cfdi:Complemento",.F.,.T.,4))  

[XXX ADDENDA]
ADDENDA    C 019 0 ENCODEUTF8(XMLConv("",,,"cfdi:Addenda",.T.,.F.,4))

[XXX ADDENDA1]
(PREREG) (_aTotal[003] := '        <cfdi:t_obs',.T.)
(PREREG) (_aTotal[003] += ' CadenaOrig="' + Alltrim(_aTotal[074]) + '"',.T.)
(PREREG) (_aTotal[003] += ' Sucursal="' + SRA->RA_FILIAL + '"',.T.)
(PREREG) (_aTotal[003] += '/>',.T.)
(PREREG) _aTotal[003]  
(POS) DelAreaTrab()

[XXX ADDENDA]
ADDENDA    C 019 0 ENCODEUTF8(XMLConv("",,,"cfdi:Addenda",.F.,.T.,4))

[XXX CFDI]
CFDI       C 019 0 ENCODEUTF8(XMLConv("",,,"cfdi:Comprobante",.F.,.T.,0))