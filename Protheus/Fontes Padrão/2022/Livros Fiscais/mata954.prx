#INCLUDE "MATA954.CH"
#INCLUDE "PROTHEUS.CH"

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³MATA954   ³ Autor ³Eduardo José Zanardo   ³ Data ³17/09/2002 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±ºDesc.     ³Apuracao do ISS                                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                             ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MATA954(lAutomato,nOpcApur)

Local cCadastro := STR0001 //"Apuracao de ISS"

Local aSays		:= {}
Local aButtons	:= {}
Local nOpca 	:= 0
Local aCAP		:= {STR0002,STR0003,STR0004} //"Confirma"###"Abandona"###"Parƒmetros"
Local cPerg		:= "MTA954"
Local cTitulo	:= STR0001 //"Apuracao de ISS"
Local cText1	:= STR0005 //"Este programa faz a Apura‡„o de ISS, conforme parƒmetros "
Local cText2	:= STR0006 //"informados pelo usu rio."
Local cArq		:= ""

Default lAutomato := .F.
Default nOpcApur  := 2

PRIVATE aRotina   := {	{ OemToAnsi(STR0005),"AxPesqui" ,0,1},; //"Pesquisar"
						{ OemToAnsi(STR0006),"AxAlter"  ,0,2},; //"Visual"
						{ OemToAnsi(STR0007),"AxInclui" ,0,3},; //"Incluir"
						{ OemToAnsi(STR0008),"AxAlter"  ,0,4},; //"Alterar"
						{ OemToAnsi(STR0009),"AxAlter"  ,0,5},; //"Exclusao"
						{ OemToAnsi(STR0046),"AxVisual" ,0,6} } //"Visual"

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Inicializa grupo de perguntas.        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Pergunte(cPerg,.F., NIL , NIL, NIL, NIL, NIL, NIL, NIL, .F.)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Janela Principal                                             ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
AADD(aSays,OemToAnsi( ctext1 ) )
AADD(aSays,OemToAnsi( cText2 ) )
AADD(aButtons, { 1,.T.,{|o| nOpca:= 1,o:oWnd:End()}} )
AADD(aButtons, { 2,.T.,{|o| o:oWnd:End() }} )
AADD(aButtons, { 5,.T.,{|| Pergunte(cPerg, !lAutomato, NIL, NIL, NIL, NIL, NIL, NIL, NIL, .F.) } } )
If !lAutomato
	FormBatch( cCadastro, aSays, aButtons )
	If nOpca ==1
		FwMsgRun(,{|oSay|a954Processa()},STR0001) //"Apuracao de ISS"
	EndIf
Else
	Pergunte(cPerg, .F., NIL, NIL, NIL, NIL, NIL, NIL, NIL, .F.)
	Processa({||a954Processa(.T.,nOpcApur)})
EndIf

RETURN
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±ºFuncao    ³A954processaºAutor  ³Eduardo José Zanardo   º Data ³ 17/09/2002º±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±ºDesc.     ³Apuracao do ISS                                                º±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                               ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function a954Processa(lAutomato,nOpcApur)

Local cCadastro := STR0001 //"Apuracao de ISS"
Local aPosObj   := {}
Local aObjects  := {}
Local aSize     := MsAdvSize()
Local aArea     := GetArea()
Local aTitles   := {}
Local aRecTit   := {}
Local nGd1      := 0
Local nGd2      := 0
Local nGd3      := 0
Local nGd4      := 0
Local oGetDad1
Local oGetDad2
Local oGetDad3
Local oGetDad5
Local oGetDad6
Local oGetDad7
Local oDlg
Local cImp		:= "IS"
Local cImposto	:= "ISS"
Local nPosRecPR := 0
Local nS        := 0
Local nY        := 0
Local nX        := 0
Local cLcPadTit := "750"
Local cLcPadExt := "751"
Local cProgram  := "MATA954"
Local aDadIS    := {}
Local aUsrdem   := {}

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Variaveis utilizadas para parametros                             ³
//³ mv_par01  // Mes de Apuracao                                     ³
//³ mv_par02  // Ano da Apuracao                                     ³
//³ mv_par03  // Livro Selecionado                                   ³
//³ mv_par04  // Apuracao(Decendial/Mensal/Quinzenal/Semestral/Anual ³
//³ mv_par05  // Periodo (1o./2o./3o.)                               ³
//³ mv_par06  // Arquivo do Perido Anterior                          ³
//³ mv_par07  // Moeda do Titulo                                     ³
//³ mv_par08  // Gera Titulo ( Sim/Nao )                             ³
//³ mv_par09  // Exibir Lancamento Contabil( Sim/Nao )               ³
//³ mv_par10  // Considera Filiais( Sim/Nao )                        ³
//³ mv_par11  // Da Filial                                           ³
//³ mv_par12  // Ate a Filial                                        ³
//³ mv_par13  // Gera Guia de Rec.( Sim/Nao )                        ³
//³ mv_par14  // Utiliza Tabela Progressiva.( Sim/Nao )              ³
//³ mv_par15  // Seleciona Filiais? ( Sim/Nao )                      ³
//³ mv_par16  // Valida seleção por CNPJ+IM? ( Sim/Nao )             ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

Local nMes		:= mv_par01
Local nAno		:= mv_par02
Local cNrLivro	:= mv_par03
Local nApuracao	:= mv_par04
Local nPeriodo	:= mv_par05
Local nMoedTit	:= If(Trim(Str(mv_par07))$"12345",mv_par07,1)
Local lTitulo	:= (mv_par08==1)
Local lContab	:= (mv_par09==1)
Local nConsFil	:= mv_par10
Local cFilDe	:= mv_par11
Local cFilAte	:= mv_par12
Local lGuiaRec  := If(mv_par13==1,.T.,.F.)
Local aDatas	:= DetDatas(nMes,nAno,nApuracao,nPeriodo)
Local dDtIni	:= aDatas[1]
Local dDtFim	:= aDatas[2]
Local dDtVenc	:= DataValida(aDatas[2]+1,.t.)
Local cArqApur 	:= NmArqApur(cImp,nAno,nMes,nApuracao,nPeriodo,cNrLivro)
Local cOrgArrec := Space(30)
Local cObserv   := ""
Local cNumero   := ""
Local nCtd002	:= 0
Local lGeraSubEmp	:= .T.
Local lLoadDesc	:= .F.
Local dDataIni	:= FirstDay(dDtIni)
Local dDataFim	:= LastDay(dDtFim)
Local nLinTel	:= 0
Local aCombo1	:= {STR0093,;	//0- Cancelamento de nota fiscal;
						STR0094,;	//1- Glosa de valor faturado;
						STR0095,;	//2- Erro de preenchimento de valor faturado;
						STR0096,;	//3- Erro de preenchimento de valor faturado na declaração;
						STR0097,;	//4- Erro de preenchimento de valor de dedução da base de cálculo;
						STR0098,;	//5- Erro de preenchimento de valor de ISS retido;
						STR0099}	//9- Outros
Local cTipComp := "0"
Local cTipCom1 := "0"
Local nVlrCred := 0
Local nVlrComp := 0
Local cPerServ := space(6)
Local nVlrResu := 0
Local cComObse := ""
Local aFilsCalc:= {}
Local nCont    := 0
Local aApurMun := {} // guarda os titulos de apuração de ISS por municipio
Local nContMun := 0
Local cUfGNRE  := ""
Local cNrGnre  := ""
Local nSeqGnre := 0
Local lApurOK  := .F.
Local nDiaVencto := 0
Local dDtVencCC2 := StoD("//")
Local cMsg     := ""
Local nPosMun  := 0
Local cMunSgmt := Iif(Len(Alltrim(SM0->M0_CODMUN)) < 7,UfCodIBGE(SM0->M0_ESTENT)+SM0->M0_CODMUN,SM0->M0_CODMUN)
Local cForISS  := ""
Local aFornISS := {{cMunSgmt,PadR(SuperGetMV("MV_MUNIC",.F.,""),TamSX3("A2_COD")[1]),PadR("00",TamSX3("A2_LOJA")[1])}}
Local nTamGnre := TamSx3("F6_NUMERO")[1]
Local aGnre    := {}
Local cLojISS  := ""
Local aAuto    := {}
Local lCodMun  := .F.

Default lAutomato := .F.
Default nOpcApur  := 2

PRIVATE aHeader1:= {}
PRIVATE aCols1	:= {}
PRIVATE aAlter1	:= {}
PRIVATE aHeader2:= {}
PRIVATE aCols2	:= {}
PRIVATE aAlter2	:= {}
PRIVATE aHeader3:= {}
PRIVATE aCols3	:= {}
PRIVATE aAlter3	:= {}
PRIVATE aHeader5:= {}
PRIVATE aCols5	:= {}
PRIVATE aAlter5	:= {}
PRIVATE aHeader6:= {}
PRIVATE aCols6	:= {}
PRIVATE aAlter6	:= {}
PRIVATE aHeader7:= {}
PRIVATE aCols7	:= {}
PRIVATE aAlter7	:= {}
PRIVATE oFolder
PRIVATE nVlrTitulo := 0
PRIVATE aMVFXFAT01 := &(GetNewPar("MV_FXFAT01","{0.01,10000,2,0}")) // vlr.minimo/vlr.maximo/aliquota/desconto
PRIVATE aMVFXFAT02 := &(GetNewPar("MV_FXFAT02","{10000.01,15000,3,100}")) // vlr.minimo/vlr.maximo/aliquota/desconto
PRIVATE aMVFXFAT03 := &(GetNewPar("MV_FXFAT03","{15000.01,20000,4,250}")) // vlr.minimo/vlr.maximo/aliquota/desconto
PRIVATE aMVFXFAT04 := &(GetNewPar("MV_FXFAT04","{20000.01,0,5,450}")) // vlr.minimo/vlr.maximo/aliquota/desconto
PRIVATE lTabProg   := If(mv_par14==1,.T.,.F.) // Tabela Progressiva
PRIVATE nFat       := 0
PRIVATE lApurTab   := GetNewPar("MV_APURTAB",.F.) // Utiliza Apuracao Especifica p/ Municipio de Sorocaba
PRIVATE cCodMun    := Alltrim(SM0->M0_CODMUN)
PRIVATE lFiliais   := If(mv_par15==1,.T.,.F.)
PRIVATE aPedISS    := {}

lCodMun := FCodMun(cCodMun)

If lFiliais // Seleciona Filiais
	nConsFil:= 1
	If MV_PAR16==1
		aFilsCalc := MatFilCalc(lFiliais,,,MV_PAR16==1 .And. lFiliais,,2)
	Else
		aFilsCalc := MatFilCalc(lFiliais)
	Endif
Else
	If nConsFil == 1 // Considera Filiais
		// Se não preencheu nenhuma das filiais considero somente a filial logada.
		If Empty(cFilDe) .And. Empty(cFilAte)
			cFilDe := cFilAte := cFilAnt
		EndIf
	Else
		cFilDe := cFilAte := cFilAnt
	EndIf
EndIf

If lCodMun
	aTitles := {STR0007,STR0008,"Demonstrativos",STR0009,STR0046,STR0055,STR0060} //"ISS-Saidas"/"Apuracao-ISS"/"Demonstrativos"/"Informacoes Complementares"/"Tabela Progressiva"/"Por Município - Saídas"/"Ajuste"
Else
	aTitles := {STR0007,STR0008,"Demonstrativos",STR0009,STR0046,STR0055} //"ISS-Saidas"/"Apuracao-ISS"/"Demonstrativos"/"Informacoes Complementares"/"Tabela Progressiva"/"Por Município - Saídas"
Endif

//Utilizo o valor da receita bruta somente se estiver habilitado a Tabela Progressiva e for Apuracao Especifica p/ Municipio de Sorocaba
If lTabProg .And. lApurTab
	nFat := CalcRB(dDataIni,dDataFim,0,.T.) // Retorna Receita Bruta
EndIf

If ExistBlock("A954VCTO")
	dDtVenc := ExecBlock("A954VCTO",.F.,.F.,{dDtVenc})
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Verifica se ja foi feita apuracao para este periodo   ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If CheckApur(cImp,nAno,nMes,nApuracao,nPeriodo,cNrLivro,cImposto,@aDadIS,;
				nMoedTit,cLcPadExt,cArqApur,{},cProgram,@aUsrdem,,,,,nOpcApur,lAutomato)

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Montagem do aCols (2) - Resumo da Apuracao - ICMS     ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	AADD(aCOLS2,{"   ","          ","                                              ","",.F.})
	AADD(aCOLS2,{"   ","          ",STR0010,"",.F.}) //"            DEBITO DO IMPOSTO                 "
	AADD(aCOLS2,{"   ","          ","                                              ","",.F.})
	AADD(aCOLS2,{"001","          ",STR0011,0,.F.}) //"Por Saidas/Prestacoes com debito do Imposto   "
	AADD(aCOLS2,{"002","002.00    ",STR0021,0,.F.}) //"Serv. executados por Terc. c/ret. de Imposto  "

	For nX:=1 to Len(aDadIS)

		If aDadIS[nX][1]=="002"
			nCtd002++
			If (STR0045$aDadIS[nX][2])	//Se a linha ja existir no TXT contido no sigaadv so atualizo os valores ou a excluo na funcao a954Apura
				lGeraSubEmp	:=	.F.
				AADD(aCols2,{"002",aDadIS[nX][4],aDadIS[nX][2],0,.F.}) //Importanto do IS*
			Else
				AADD(aCols2,{"002",aDadIS[nX][4],aDadIS[nX][2],aDadIS[nX][3],.F.}) //Importanto do IS*            
			EndIf
		EndIf

		If aDadIS[nX][1]=="500" //Linhas ref. as informacoes de compensacao de ISS
			If Alltrim(aDadIS[nX][2]) == "TIPO"
				cTipCom1 := aDadIS[nX][3]
			ElseIf Alltrim(aDadIS[nX][2]) == "PERIODO"
				cPerServ := IIf(!Empty(AllTrim(aDadIS[nX][3])),aDadIS[nX][3], Space(6))
			ElseIf Alltrim(aDadIS[nX][2]) == "CREDITO"
				nVlrCred := aDadIS[nX][3]
			ElseIf Alltrim(aDadIS[nX][2]) == "COMPENSADO"
				nVlrComp := aDadIS[nX][3]
			ElseIf Alltrim(aDadIS[nX][2]) == "RESULTADO"
				nVlrResu := aDadIS[nX][3]
			ElseIf Alltrim(aDadIS[nX][2]) == "OBSERVACAO"
				cComObse += aDadIS[nX][3] + Chr(13) + Chr(10)
			EndIf
		EndIf

	Next nX

	//A linha de subempreitada devera sair sempre que houver valor no F3_ISSSUB no periodo apurado, 
	//portanto incluo esta linha no acols e na funcao a954Apura verifico se devo mantela com os valores atualizadaos ou a excluo.

	If lGeraSubEmp
		AADD(aCols2,{"002", "002."+StrZero (nCtd002+1, 2), STR0045, 0,.F.}) //"Texto do usuario
	EndIf

	AADD(aCOLS2,{"003","003.00    ",STR0012,0,.F.}) //"Outros Debitos

	For nX:=1 to Len(aDadIS)
		If aDadIS[nX][1]=="003"
			AADD(aCols2,{"003",aDadIS[nX][4],aDadIS[nX][2],aDadIS[nX][3],.F.}) //"Texto do usuario
		EndIf
	Next nX

	AADD(aCOLS2,{"004","          ",STR0013,0,.F.}) //"Sub-Total                                     "
	AADD(aCOLS2,{"   ","          ","                                              ","",.F.})
	AADD(aCOLS2,{"   ","          ",STR0014,"",.F.})//"            CREDITO DO IMPOSTO                "
	AADD(aCOLS2,{"005","005.00    ",STR0015,0,.F.}) //"Estorno de Debitos                            "

	For nX:=1 to Len(aDadIS)
		IF aDadIS[nX][1]=="005"
			AADD(aCols2,{"005",aDadIS[nX][4],aDadIS[nX][2],aDadIS[nX][3],.F.}) //"Texto do usuario
		Endif
	Next nX

	AADD(aCOLS2,{"006","006.00    ",STR0022,0,.F.}) //"Outros Credito                                "

	For nX:=1 to Len(aDadIS)
		IF aDadIS[nX][1]=="006"
			AADD(aCols2,{"006",aDadIS[nX][4],aDadIS[nX][2],aDadIS[nX][3],.F.}) //"Texto do usuario
		Endif
	Next nX

	AADD(aCOLS2,{"007","          ",STR0013,0,.F.}) //"Sub-Total                                     "
	AADD(aCOLS2,{"008","          ",STR0028,0,.F.}) //"Saldo Credor do Periodo Anterior              "
	AADD(aCOLS2,{"009","          ",STR0020,0,.F.}) //"Total                                         "
	AADD(aCOLS2,{"   ","          ","                                              ","",.F.})
	AADD(aCOLS2,{"   ","          ",STR0016,"",.F.}) //"            APURACAO DO SALDO                 "
	AADD(aCOLS2,{"   ","          ","                                              ","",.F.})

	If lApurTab .And. lTabProg
		AADD(aCOLS2,{"010","          ",STR0052,0,.F.}) //"Saldo Devedor(Decreto 14.122 - Municip. Sorocaba)          "
	Else
		AADD(aCOLS2,{"010","          ",STR0017,0,.F.}) //"Saldo Devedor( Debito menos Credito)          "
	EndIf

	AADD(aCOLS2,{"011","011.00    ",STR0018,0,.F.}) //"Deducoes                                      "

	If lTabProg
		AADD(aCOLS2,{"011","011.01",STR0051,0,.F.}) //Desconto - Tabela Progressiva
	EndIf

	AADD(aCOLS2,{"011","011.02",STR0053,0,.F.}) //Imposto retido pelo tomador do servico
	AADD(aCOLS2,{"011","011.03",STR0054,0,.F.}) //Imposto a recolher em outros municípios

	If lCodMun
		AADD(aCOLS2,{"011","011.04",STR0069,0,.F.}) //Total dos AJustes
	EndIf

	AADD(aCOLS2,{"011","011001",STR0056,0,.F.}) //"Ded. Abatim. Trib. Federais - IRRF - LC 185/07"
	AADD(aCOLS2,{"011","011002",STR0057,0,.F.}) //"Ded. Abatim. Trib. Federais - PIS - LC 185/07"
	AADD(aCOLS2,{"011","011003",STR0058,0,.F.}) //"Ded. Abatim. Trib. Federais - Cofins - LC 185/07"
	AADD(aCOLS2,{"011","011004",STR0059,0,.F.}) //"Ded. Abatim. Trib. Federais - CSLL - LC 185/07"

	For nX:=1 to Len(aDadIS)
		If aDadIS[nX][1]=="011"
			If (aDadIS[nX][4]=="011.01") .And. (nPos := aScan (aCols2, {|x| x[2]=="011.01"}))<>0
				aCols2[nPos][4]	+=	aDadIS[nX][3]
			ElseIf (aDadIS[nX][4]=="011.02") .And. (nPos := aScan (aCols2, {|x| x[2]=="011.02"}))<>0
				aCols2[nPos][4]	+=	aDadIS[nX][3]
			ElseIf (aDadIS[nX][4]=="011.03") .And. (nPos := aScan (aCols2, {|x| x[2]=="011.03"}))<>0
				aCols2[nPos][4]	+=	aDadIS[nX][3]
			ElseIf (aDadIS[nX][4]=="011.04") .And. (nPos := aScan (aCols2, {|x| x[2]=="011.04"}))<>0
				aCols2[nPos][4]	+=	aDadIS[nX][3]
			ElseIf (aDadIS[nX][4]=="011001") .And. (nPos := aScan (aCols2, {|x| x[2]=="011001"}))<>0
				aCols2[nPos][4]	+=	aDadIS[nX][3]
			ElseIf (aDadIS[nX][4]=="011002") .And. (nPos := aScan (aCols2, {|x| x[2]=="011002"}))<>0
				aCols2[nPos][4]	+=	aDadIS[nX][3]
			ElseIf (aDadIS[nX][4]=="011003") .And. (nPos := aScan (aCols2, {|x| x[2]=="011003"}))<>0
				aCols2[nPos][4]	+=	aDadIS[nX][3]
			ElseIf (aDadIS[nX][4]=="011004") .And. (nPos := aScan (aCols2, {|x| x[2]=="011004"}))<>0
				aCols2[nPos][4]	+=	aDadIS[nX][3]
			ElseIf (aDadIS[nX][4]<>"011.01" .And. aDadIS[nX][4]<>"011.02")
				AADD(aCols2,{"011",aDadIS[nX][4],aDadIS[nX][2],aDadIS[nX][3],.F.}) //"Texto do usuario
			EndIf
		Endif
	Next nX

	AADD(aCOLS2,{"012","          ",STR0019,0,.F.}) //"Imposto a Recolher                            "
	AADD(aCOLS2,{"013","          ",STR0024,0,.F.}) //"Saldo Credor ( Credito menos Debito)          "

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Demonstrativos³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	AADD(aCOLS3,{"   ","          ","                                              ","",.F.})
	AADD(aCOLS3,{"   ","          ","DESCRICAO","",.F.})
	AADD(aCOLS3,{"   ","          ","                                              ","",.F.})
	AADD(aCOLS3,{"000","000.00    ","Itens",0,.F.})

	For nX:=1 to Len(aUsrdem)
        IF aUsrdem[nX][1]=="000"
           AADD(aCols3,{"000",aUsrdem[nX][4],aUsrdem[nX][2],aUsrdem[nX][3],.F.}) //"Texto do usuario
           If !lLoadDesc
              If "ALUGUEL MENSAL"$aUsrdem[nX][2]
                  lLoadDesc	:=.T.
              Endif
           Endif
        Endif
	Next nX

	If GetMv("MV_ESTADO")=="DF" .And. !lLoadDesc
		AADD(aCOLS3,{"000","001.00    ","ALUGUEL MENSAL",0,.F.})
		AADD(aCOLS3,{"000","001.00    ","AGUA, ENERGIA, TELEFONE",0,.F.})
		AADD(aCOLS3,{"000","001.00    ","RETIRADA PRO-LABORE",0,.F.})
		AADD(aCOLS3,{"000","001.00    ","PAGAMENTO DE EMPREGADO",0,.F.})
		AADD(aCOLS3,{"000","001.00    ","PREVIDENCIA SOCIAL",0,.F.})
		AADD(aCOLS3,{"000","001.00    ","DEMAIS DESPESAS",0,.F.})
		AADD(aCOLS3,{"000","001.00    ","ISS PROPRIO",0,.F.})
		AADD(aCOLS3,{"000","001.00    ","ISS RETIDO/SUBCONTRATACAO",0,.F.})
		AADD(aCOLS3,{"000","001.00    ","ORGAO PUBLICO",0,.F.})
	Endif

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Tabela Progressiva  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	AADD(aCOLS5,{"     ","I, II, III e IV"   ,"Ate "+Alltrim(Transform(aMVFXFAT01[2],"@E 999,999,999.99")),Alltrim(Transform(aMVFXFAT01[3],"@ 999999"))+"%",aMVFXFAT01[4],.F.})
	AADD(aCOLS5,{"     ","II, III e IV"      ,"De  "+Alltrim(Transform(aMVFXFAT02[1],"@E 999,999,999.99"))+" ate "+Alltrim(Transform(aMVFXFAT02[2],"@E 999,999,999.99")),Alltrim(Transform(aMVFXFAT02[3],"@ 999999"))+"%",aMVFXFAT02[4],.F.})
	AADD(aCOLS5,{"     ","III e IV"          ,"De  "+Alltrim(Transform(aMVFXFAT03[1],"@E 999,999,999.99"))+" ate "+Alltrim(Transform(aMVFXFAT03[2],"@E 999,999,999.99")),Alltrim(Transform(aMVFXFAT03[3],"@ 999999"))+"%",aMVFXFAT03[4],.F.})
	AADD(aCOLS5,{"     ","IV"                ,"Acima de "+Alltrim(Transform(aMVFXFAT04[1],"@E 999,999,999.99")),Alltrim(Transform(aMVFXFAT04[3],"@ 999999"))+"%",aMVFXFAT04[4],.F.})

	//ÚÄÄÄÄÄÄÄ¿
	//³Ajuste ³
	//ÀÄÄÄÄÄÄÄÙ
	If lCodMun
		AADD(aCOLS7,{"   ","          ","DESCRICAO","","","","","","",.F.})
		AADD(aCOLS7,{"   ","          ","                                              ","","","","","","",.F.})
		AADD(aCOLS7,{"111","111.00    ",STR0067,Space(05),Space(03),Space(09),Space(05),Space(03),0,.F.})
		AADD(aCOLS7,{"112","          ",STR0068,Space(05),Space(03),Space(09),Space(05),Space(03),0,.F.})
		AADD(aCOLS7,{"113","          ",STR0069,Space(05),Space(03),Space(09),Space(05),Space(03),0,.F.})
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Montagem do aHeader (1) - Op. Proprias - Saida        ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	AADD(aHeader1,{STR0029,"F3_CODISS"	,"@ 99999999"			,09,0,".t." ,"û" ,"C"," "," " }) //"Codigo do Serviço"
	AADD(aHeader1,{STR0030,"F3_VALCONT"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"Valor Contabil"
	AADD(aHeader1,{STR0031,"F3_BASEICM"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"Base de Calculo"
	AADD(aHeader1,{STR0032,"F3_VALICM"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"Imposto Debitado"
	AADD(aHeader1,{STR0106,"nImpRet"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"Imposto Retido"
	AADD(aHeader1,{STR0107,"nImpDev"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"Imposto Devido"
	AADD(aHeader1,{STR0033,"F3_ISENICM"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"Isentas"
	AADD(aHeader1,{STR0034,"F3_OUTRICM"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"Outras"

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Montagem do aHeader (2) Resumo da Apuracao - ISS      ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	AADD(aHeader2,{STR0035,"cLinha"		,"@E 999"				,03,0,".t." ,"û" ,"C"," "," " }) //"Linha"
	AADD(aHeader2,{STR0036,"cCodigo"	,"@!"					,10,0,"a954Codigo()" ,"û" ,"C"," "," " }) //"Codigo"
	AADD(aHeader2,{STR0037,"cDescr"		,"@!"					,47,0,".t." ,"û" ,"C"," "," " }) //"Descricao"
	AADD(aHeader2,{STR0038,"nValor"		,"@E 999,999,999.99"	,15,2,"a954Saldo(.F.)" ,"û" ,"N"," "," " }) //"Valor"

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Montagem do aHeader (3) Resumo da Apuracao - ISS      ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	AADD(aHeader3,{STR0035,"cLinha"		,"@E 999"				,03,0,".t." ,"û" ,"C"," "," " }) //"Linha"
	AADD(aHeader3,{STR0036,"cCodigo"	,"@!"					,10,0,""    ,"û" ,"C"," "," " }) //"Codigo"
	AADD(aHeader3,{STR0037,"cDescr"		,"@!"					,47,0,".t." ,"û" ,"C"," "," " }) //"Descricao"
	AADD(aHeader3,{STR0038,"nValor"		,"@E 999,999,999.99"	,15,2,"a954Saldo2(.F.)" ,"û" ,"N"," "," " }) //"Valor"

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Montagem do aHeader (5) Tabela Progressiva            ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	AADD(aHeader5,{"     ","cBMP"		,"@BMP"					,02,0,".t." ,"û" ,"C"," "," " }) //BMP
	AADD(aHeader5,{STR0047,"cAtiv"		,"@!"					,10,0,".t." ,"û" ,"C"," "," " }) //"Atividades - Itens Art.22"
	AADD(aHeader5,{STR0048,"cFat"		,"@!"					,08,0,""    ,"û" ,"C"," "," " }) //"Faixa Faturamento Mensal (em R$)"
	AADD(aHeader5,{STR0049,"cAliq"		,"@!"					,03,0,".t." ,"û" ,"C"," "," " }) //"Aliquota"
	AADD(aHeader5,{STR0050,"nDesc"		,"@E 999,999,999.99"	,08,2,""    ,"û" ,"N"," "," " }) //"Desconto (em R$)"

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Montagem do aHeader (6) - Op. por Municipio - Saida        ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	AADD(aHeader6,{STR0100,"cISSMun"	,"@!"					,TamSx3("A1_COD_MUN")[1]+2,0,".t." ,"û" ,"C"," "," " }) //"MUNICIPIO"
	AADD(aHeader6,{STR0101,"cISSMun"	,"@!"					,TamSx3("A1_MUN")[1],0,".t." ,"û" ,"C"," "," " }) //"MUNICIPIO"
	AADD(aHeader6,{STR0030,"F3_VALCONT"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"Valor Contabil"
	AADD(aHeader6,{STR0031,"F3_BASEICM"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"Base de Calculo"
	AADD(aHeader6,{STR0032,"F3_VALICM"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"Imposto Debitado"
	AADD(aHeader6,{STR0106,"nTotRet"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"Imposto Retido"
	AADD(aHeader6,{STR0107,"nTotDev"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"Imposto Devido"
	AADD(aHeader6,{STR0033,"F3_ISENICM"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"Isentas"
	AADD(aHeader6,{STR0034,"F3_OUTRICM"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"Outras"
	AADD(aHeader6,{STR0070,"F3_ISSMAT"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"Material Empregado"
	AADD(aHeader6,{STR0071,"F3_ISSSUB"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"SubEmpreitada"
	AADD(aHeader6,{STR0072,"nTotAbt"	,"@E 999,999,999.99"	,15,2,".t." ,"û" ,"N"," "," " }) //"Total de Deduções"

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Montagem do aHeader (7) - Ajuste ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lCodMun
		AADD(aHeader7,{STR0035,"cLinha"		,"@E 999"			,03,0,".t." ,"û" ,"C"," "," " }) //"Linha"
		AADD(aHeader7,{STR0036,"cCodigo"	,"@!"				,10,0,""    ,"û" ,"C"," "," " }) //"Codigo"
		AADD(aHeader7,{STR0037,"cDescr"		,"@!"				,47,0,".t." ,"û" ,"C"," "," " }) //"Descricao"
		AADD(aHeader7,{STR0061,"cEspecie"	,"@!"				,05,0,".t." ,"û" ,"C"," "," " }) //"Especie"
		AADD(aHeader7,{STR0062,"cSerie"		,"!!!"				,03,0,".t." ,"û" ,"C"," "," " }) //"Serie"
		AADD(aHeader7,{STR0063,"cNumero"	,"@!"				,09,0,".t." ,"û" ,"C"," "," " }) //"Numero"	
		AADD(aHeader7,{STR0064,"cCfps"		,"@9"				,05,0,".t." ,"û" ,"C"," "," " }) //"CFPS"
		AADD(aHeader7,{STR0065,"CCst"		,"@!"				,03,0,".t." ,"û" ,"C"," "," " }) //"CST"
		AADD(aHeader7,{STR0066,"nValor"		,"@E 999,999,999.99",14,2,"a954Saldo3(.F.)","û" ,"N"," "," " }) //"Compensação"
	Endif

	// EFETUA APURACAO DE ISS
	lApurOK := a954Apura(cImp,dDtIni,dDtFim,cNrLivro,nConsFil,cFilDe,cFilAte,aFilsCalc,cMunSgmt,@aFornISS,lAutomato,lCodMun)

	a954Saldo(.T.) // Operacoes Proprias
	a954Saldo2(.T.) // Demonstrativos

	If lCodMun
		a954Saldo3(.T.) // Ajuste
	Endif

	aObjects := {}
	AAdd( aObjects, {60, 100, .t., .t. } )

	aInfo := { aSize[ 1 ], aSize[ 2 ], aSize[ 3 ], aSize[ 4 ], 3, 3 }
	aPosObj := MsObjSize( aInfo, aObjects )

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Montagem da Tela                                      ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If !lAutomato
		DEFINE MSDIALOG oDlg TITLE cCadastro From aSize[7],00 To aSize[6],aSize[5] OF oMainWnd PIXEL

		oFolder := TFolder():New(aPosObj[1,1],aPosObj[1,2],aTitles,{"","",""},oDlg,,,,.T.,.F.,aPosObj[1,4]-aPosObj[1,2],aPosObj[1,3]-aPosObj[1,1])

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Define as posicoes da Getdados a partir do folder    ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		nOpcx := 4
		nOpca := 1
		nGd1  := 2
		nGd2  := 2
		nGd3  := aPosObj[1,3]-aPosObj[1,1]-15
		nGd4  := aPosObj[1,4]-aPosObj[1,2]-4

		oFolder:aDialogs[4]:oFont := oDlg:oFont

		nLinTel	:=	nGd1
		@ nLinTel ,nGd1	TO (nGd3/3)+2,nGd4 LABEL '' OF oFolder:aDialogs[4] PIXEL

		nLinTel	+=	20
		@ nLinTel,   020 SAY OemToAnsi(STR0026) Of oFolder:aDialogs[4] PIXEL SIZE 100,08  //"Data de Vencimento do Imposto:"
		@ nLinTel-2, 120 MSGET dDtVenc VALID (dDtVenc>=dDtFim) OF oFolder:aDialogs[4] PIXEL SIZE 52,08 

		nLinTel	+=	15
		@ nLinTel,   020 SAY OemToAnsi(STR0027)Of oFolder:aDialogs[4] PIXEL	SIZE 60,08  //"Org„o Arrecadador      :"
		@ nLinTel-2, 120 MSGET cOrgArrec PICTURE "@!" OF oFolder:aDialogs[4] PIXEL SIZE 80 ,9

		nLinTel	+=	15
		@ nLinTel,   020 SAY OemToAnsi(STR0028) Of oFolder:aDialogs[4] PIXEL 	SIZE 80,08  //"Observacoes :"
		@ nLinTel-2, 120 GET cObserv  MEMO OF oFolder:aDialogs[4] PIXEL  SIZE nGd4/2,(nGd3/6)       //3

		nLinTel	+=	(nGd3 / 4) + 1

		//COMPENSACAO ISS (REG B465 COTEPE35)
		If GetMv("MV_ESTADO")=="DF"
			@ nLinTel,002	TO nLinTel+145,nGd4 LABEL STR0086 OF oFolder:aDialogs[4] PIXEL      //COMPENSAÇÃO ISS (REG465 COTEPE35)

			@ nLinTel+=	15, 020	SAY OemToAnsi(STR0087) Of oFolder:aDialogs[4] PIXEL SIZE 80,08  //Tipo de Compensação
			@ nLinTel-2, 120  MSCOMBOBOX oCombo1 VAR cTipComp ITEMS aCombo1 SIZE 210,50 OF oFolder:aDialogs[4] PIXEL 
			oCombo1:nAT := IIf(Val(cTipCom1)<Len(oCombo1:aItems),Val(cTipCom1)+1,Len(oCombo1:aItems))

			@ nLinTel+=	15, 020	SAY OemToAnsi(STR0090)Of oFolder:aDialogs[4] PIXEL	SIZE 60,08   //Período prestação serviço
			@ nLinTel-2, 120	MSGET cPerServ PICTURE "@r 99/9999" OF oFolder:aDialogs[4] PIXEL SIZE 80 ,9

			@ nLinTel+=	15, 020	SAY OemToAnsi(STR0088)Of oFolder:aDialogs[4] PIXEL	SIZE 60,08   //Valor do crédito
			@ nLinTel-2, 120	MSGET nVlrCred PICTURE "@e 999,999,999,999.99" OF oFolder:aDialogs[4] PIXEL SIZE 80 ,9

			@ nLinTel+=	15, 020	SAY OemToAnsi(STR0089)Of oFolder:aDialogs[4] PIXEL	SIZE 60,08   //Valor da compensação
			@ nLinTel-2, 120	MSGET nVlrComp PICTURE "@e 999,999,999,999.99" OF oFolder:aDialogs[4] PIXEL SIZE 80 ,9

			@ nLinTel+=	15, 020	SAY OemToAnsi(STR0091)Of oFolder:aDialogs[4] PIXEL	SIZE 60,08   //Valor da resultante
			@ nLinTel-2, 120	MSGET nVlrResu PICTURE "@e 999,999,999,999.99" OF oFolder:aDialogs[4] PIXEL SIZE 80 ,9

			@ nLinTel+=	15, 020	SAY OemToAnsi(STR0092) Of oFolder:aDialogs[4] PIXEL SIZE 80,08  //Comentários e observações
			@ nLinTel-2, 120	GET cComObse MEMO OF oFolder:aDialogs[4] PIXEL SIZE 160 ,42
		Endif

		If lCodMun
			aHeader  := aClone(aHeader7)
			aCols    := aClone(aCols7)
			oGetDad7 := MSGetDados():New(nGd1,nGd2,nGd3,nGd4,nOpcx,"a954lin7Ok","AlwaysTrue","",nOpcx!=2,aAlter7,,,len(aCols7),,,,"a954Del7Col",oFolder:aDialogs[7])
			oGetDad7 :oBrowse:lDisablePaint := .T.
			oGetDad7 :oBrowse:bDrawSelect := {|| a954Cpo5Alt(oGetDad7:oBrowse)} 
		Endif

		aHeader  := aClone(aHeader6)
		aCols    := aClone(aCols6)
		oGetDad6 := MSGetDados():New(nGd1,nGd2,nGd3,nGd4,nOpcx,"AlwaysTrue","AlwaysTrue","",nOpcx!=2,aAlter6,,,len(aCols6),,,,,oFolder:aDialogs[6])
		oGetDad6:oBrowse:BLDBLCLICK := {|| a954DbC6Ok()}
		oGetDad6:oBrowse:lDisablePaint := .T.

		aHeader  := aClone(aHeader5)
		aCols    := aClone(aCols5)
		oGetDad5 := MSGetDados():New(nGd1,nGd2,nGd3,nGd4,nOpcx,"AlwaysTrue","AlwaysTrue","",nOpcx!=2,aAlter5,3,,len(aCols5),,,,,oFolder:aDialogs[5])
		oGetDad5 :oBrowse:lDisablePaint := .T.

		aHeader  := aClone(aHeader3)
		aCols    := aClone(aCols3)
		oGetDad3 := MSGetDados():New(nGd1,nGd2,nGd3,nGd4,nOpcx,"a954lin5Ok","AlwaysTrue","",nOpcx!=2,aAlter3,3,,len(aCols3),,,,"a954Del5Col",oFolder:aDialogs[3])
		oGetDad3 :oBrowse:lDisablePaint := .T.
		oGetDad3 :oBrowse:bDrawSelect := {|| a954Cpo5Alt(oGetDad3:oBrowse)}

		aHeader  := aClone(aHeader2)
		aCols    := aClone(aCols2)
		oGetDad2 := MSGetDados():New(nGd1,nGd2,nGd3,nGd4,nOpcx,"a954lin5Ok","AlwaysTrue","",nOpcx!=2,aAlter2,3,,len(aCols2),,,,"a954Del5Col",oFolder:aDialogs[2])
		oGetDad2 :oBrowse:lDisablePaint := .T.
		oGetDad2 :oBrowse:bDrawSelect := {|| a954Cpo5Alt(oGetDad2:oBrowse)}

		aHeader  := aClone(aHeader1)
		aCols    := aClone(aCols1)
		oGetDad1 := MSGetDados():New(nGd1,nGd2,nGd3,nGd4,nOpcx,"AlwaysTrue","AlwaysTrue","",nOpcx!=2,aAlter1,,,len(aCols1),,,,,oFolder:aDialogs[1])
		oGetDad1 :oBrowse:lDisablePaint := .T.

		If lCodMun
			oFolder:bSetOption:={|nAtu| Ft954Fld(nAtu,oFolder:nOption,oFolder,{oGetDad1,oGetDad2,oGetDad3,,oGetDad5,oGetDad6,oGetDad7},lCodMun)}
		Else
			oFolder:bSetOption:={|nAtu| Ft954Fld(nAtu,oFolder:nOption,oFolder,{oGetDad1,oGetDad2,oGetDad3,,oGetDad5,oGetDad6},lCodMun)}
		EndIf

		If ( nOpcx!=2 )

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Ao confirmar, simula a mudanca de folder para atualizar os arrays necessarios ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If lCodMun
				If !lAutomato
					ACTIVATE MSDIALOG oDlg ON INIT ( Ft954Refre({oGetDad1,oGetDad2,oGetDad3,,oGetDad5,oGetDad6}),;
					EnchoiceBar(oDlg,{||nopca:=If(Ft954Fld(oFolder:nOption,oFolder:nOption,oFolder,{oGetDad1,oGetDad2,oGetDad3,,oGetDad5,oGetDad6,oGetDad7}).And.;
													Ft954Ok({oGetDad1,oGetDad2,oGetDad3,,oGetDad5,oGetDad6,oGetDad7},;
											oFolder:nOption),1,0),If(nOpcA==1,oDlg:End(),Nil)},{||nOpcA:=0,oDlg:End()},,{{"BMPINCLUIR",{|| If(oFolder:nOption <= 3 .OR. oFolder:nOption ==5 .OR. oFolder:nOption ==7 ,AddAcols(If(oFolder:nOption==2,oGetDad2,If(oFolder:nOption==3,oGetDad3,Iif(oFolder:nOption==5,oGetDad5,Iif(oFolder:nOption==6,oGetDad6,oGetDad7))))),.F.)},STR0025,STR0044},;
											{"BMPVISUAL",{|| ProcLogView()},'Vizualização do LOG de processamento multi-thread',"Log MThread"}})) //"Inclui Linhas"
				Else
					nOpcA := If(Ft954Fld(oFolder:nOption,oFolder:nOption,oFolder,{oGetDad1,oGetDad2,oGetDad3,,oGetDad5,oGetDad6,oGetDad7}).And.;
					Ft954Ok({oGetDad1,oGetDad2,oGetDad3,,oGetDad5,oGetDad6,oGetDad7},oFolder:nOption),1,0)
				EndIf
			Else
				If !lAutomato
					ACTIVATE MSDIALOG oDlg ON INIT ( Ft954Refre({oGetDad1,oGetDad2,oGetDad3,,oGetDad5,oGetDad6}),;
					EnchoiceBar(oDlg,{||nopca:=If(Ft954Fld(oFolder:nOption,oFolder:nOption,oFolder,{oGetDad1,oGetDad2,oGetDad3,,oGetDad5,oGetDad6}).And.;
													Ft954Ok({oGetDad1,oGetDad2,oGetDad3,,oGetDad5,oGetDad6},;
								oFolder:nOption),1,0),If(nOpcA==1,oDlg:End(),Nil)},{||nOpcA:=0,oDlg:End()},,{{"BMPINCLUIR",{|| If(oFolder:nOption <= 3 .OR. oFolder:nOption ==5 ,AddAcols(If(oFolder:nOption==2,oGetDad2,If(oFolder:nOption==3,oGetDad3,Iif(oFolder:nOption==5,oGetDad5,oGetDad6)))),.F.)},STR0025,STR0044},;
								{"BMPVISUAL",{|| ProcLogView()},'Vizualização do LOG de processamento multi-thread',"Log MThread"}})) //"Inclui Linhas"
				Else
					nOpcA := If(Ft954Fld(oFolder:nOption,oFolder:nOption,oFolder,{oGetDad1,oGetDad2,oGetDad3,,oGetDad5,oGetDad6}).And.;
					Ft954Ok({oGetDad1,oGetDad2,oGetDad3,,oGetDad5,oGetDad6},oFolder:nOption),1,0)
				EndIf

			Endif
		EndIf
	Else
		nOpcx := 4
		nOpca := 1
	EndIf
	If ( nOpcx!=2 )
		If ( nOpcA == 1 )
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Apaga arquivo de apuracao        ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			IiF(File(cArqApur),Ferase(cArqApur),.F.)

			Begin Transaction

				For nS:= 1 to Len(aCOLS3)
					If aCOLS3[nS,1]="000" .and. aCOLS3[nS,4] >0
						AADD(aCOLS2,{aCOLS3[nS,1],aCOLS3[nS,2],aCOLS3[nS,3],aCOLS3[nS,4],.F.})
					Endif
				Next nS

				For nS:= 1 to Len(aCOLS7)
					AADD(aCOLS2,{aCOLS7[nS,1],aCOLS7[nS,2],aCOLS7[nS,3],aCOLS7[nS,4],aCOLS7[nS,5],aCOLS7[nS,6],aCOLS7[nS,7],aCOLS7[nS,8],aCOLS7[nS,9],.F.})
				Next nS

				If GetMv("MV_ESTADO")=="DF"
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³ Armazena linhas da COMPENSACAO ISS                           ³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					AADD(aCOLS2,{"500","TIPO      ",cTipComp,,.F.})
					AADD(aCOLS2,{"500","PERIODO   ",cPerServ,,.F.})
					AADD(aCOLS2,{"500","CREDITO   ",Transform(nVlrCred,"99999999999.99"),,.F.})
					AADD(aCOLS2,{"500","COMPENSADO",Transform(nVlrComp,"99999999999.99"),,.F.})
					AADD(aCOLS2,{"500","RESULTADO ",Transform(nVlrResu,"99999999999.99"),,.F.})
					For nY :=1 to MLCount(cComObse)
						If Len(Alltrim(MemoTran(MemoLine(cComObse,,nY),"")))>0
							AADD(aCols2,{"500","OBSERVACAO",MemoTran(MemoLine(cComObse,,nY)),,,})
						Endif
					Next
				EndIf

				nPosRecPR  := Ascan(aCols2,{|x|x[1]=="012"}) //imposto a recolher
				nVlrTitulo := aCols2[nPosRecPR,4]

				// Se houver valor a recolher para o proprio municipio, devo gerar titulo e guia p/ este valor com base no aCols2.
				// Ao gerar os outros títulos (aCols6), devo ignorar o proprio municipio para não gerar titulos em duplicidade.

				dbSelectArea("CC2")
				CC2->(dbSetOrder(1))

				If nVlrTitulo > 0
					nSeqGnre += 1

					cNrGnre := cValtoChar(Year(dDtIni)) + StrZero(Month(dDtIni),2) + StrZero(nSeqGnre, 3)

					cUfGNRE := SubStr(cMunSgmt, 1, 2)
					cUfGNRE := AllTrim(UfCodIBGE(cUfGNRE))

					// Data de vencimento de acordo com a CC2 - Se Preenchido.
					If CC2->(MsSeek(xFilial("CC2")+cUfGNRE+ SubStr(cMunSgmt, 3, 5))) .And. CC2->CC2_DTRECO > 0
						nDiaVencto := CC2->CC2_DTRECO

						// Calculando nova data de vencimento.
						dDtVencCC2 := CtoD(StrZero(nDiaVencto, 2) +"/"+ StrZero(Month(MonthSum(aDatas[2], 1)),2) + "/" + cValToChar(Year(MonthSum(aDatas[2], 1))))

						// Validando data calculada.
						dDtVenc := DataValida(dDtVencCC2, .T.)
					EndIf

					// cForIss será utilizada na GravaTit - Fornecedor do titulo.
					nPosMun := AScan(aFornISS, {|x| AllTrim(x[1]) == AllTrim(cMunSgmt)})
					If nPosMun > 0
						cForIss := aFornISS[nPosMun][2]
						cLojISS := aFornISS[nPosMun][3]
					EndIf
					GravaTit(lTitulo,nVlrTitulo,cImposto,cImp,cLcPadTit,dDtIni,dDtFim,;
							  dDtVenc,nMoedTit,lGuiaRec,nMes,nAno,nVlrTitulo,;
							  0,"MATA954",lContab,@cNumero,@aGnre,,,Iif(!Empty(cUfGNRE),cUfGNRE,NIL),,,.T.,cNrGnre,@aRecTit,,,,,,,,,,,,,,,cForISS,cLojISS,,,,lAutomato)
					If lTitulo
						AADD(aApurMun,{"TIT","",cNumero+" "+Dtoc(dDtVenc)+" "+cOrgArrec,nVlrTitulo,.F.})
					EndIf
				EndIf

				// Validando municipios antes da geracao dos titulos.
				// Nao gerar titulos e guias se o municipio nao foi corretamente apurado.
				For nCont := 1 to Len(aCols6)
					If Empty(aCols6[nCont, 1])

						nVlrTitulo := aCols6[nCont, 7]

						If (nVlrTitulo > 0 .And. (lGuiaRec .Or. lTitulo))
							cMsg += STR0102 + AllTrim(Transform(nVlrTitulo,"@E 999,999,999.99")) // "O valor de "
							cMsg += STR0103 + Chr(13) + Chr(10) // " não será recolhido para nenhum município."
							cMsg += STR0104 + Chr(13) + Chr(10) // "Não serão gerados títulos e/ou guias de recolhimento para este valor."
							cMsg += STR0105 // "Verificar o preenchimento da tabela CE1 ou do parâmetro MV_FPADISS."

							ApMsgAlert(cMsg)
						EndIf

					EndIf
				Next nCont

				// Gerando titulos/guias dos demais municipios.
				For nCont := 1 to Len(aCols6)

					If !Empty(aCols6[nCont, 1]) .And. !Alltrim(aCols6[nCont, 2])$" |."
					
						cUfGNRE := SubStr(aCols6[nCont, 1], 1, 2)
						cUfGNRE := AllTrim(UfCodIBGE(cUfGNRE))
						cForIss := ""
						cLojIss := ""

						If AllTrim(aCols6[nCont, 1]) <> AllTrim(cMunSgmt)
							nVlrTitulo := aCols6[nCont, 7]
							If nVlrTitulo > 0
								nSeqGnre += 1

								cNrGnre := cValtoChar(Year(dDtIni)) + StrZero(Month(dDtIni),2) + StrZero(nSeqGnre, 3)

								// Data de vencimento de acordo com a CC2 - Se Preenchido.
								If CC2->(MsSeek(xFilial("CC2")+cUfGNRE+ SubStr(aCols6[nCont, 1], 3, 5))) .And. CC2->CC2_DTRECO > 0
									nDiaVencto := CC2->CC2_DTRECO

									// Calculando nova data de vencimento.
									dDtVencCC2 := CtoD(StrZero(nDiaVencto, 2) +"/"+ StrZero(Month(MonthSum(aDatas[2], 1)),2) + "/" + cValToChar(Year(MonthSum(aDatas[2], 1))))

									// Validando data calculada.
									dDtVenc := DataValida(dDtVencCC2, .T.)
								EndIf

								// cForIss será utilizada na GravaTit - Fornecedor para gerar o titulo.
								nPosMun := AScan(aFornISS, {|x| AllTrim(x[1]) == AllTrim(aCols6[nCont, 1]) })
								If nPosMun > 0
									cForIss := aFornISS[nPosMun][2]
									cLojISS := aFornISS[nPosMun][3]
								EndIf
								GravaTit(lTitulo,nVlrTitulo,cImposto,cImp,cLcPadTit,dDtIni,dDtFim,;
							  dDtVenc,nMoedTit,lGuiaRec,nMes,nAno,nVlrTitulo,;
							  0,"MATA954",lContab,@cNumero,@aGnre,,,Iif(!Empty(cUfGNRE),cUfGNRE,NIL),,,.T.,cNrGnre,@aRecTit,,,,,,,,,,,,,,,cForIss,cLojISS,,,,lAutomato,,CC2->CC2_CODMUN)
								If lTitulo
									AADD(aApurMun,{"TIT","",cNumero+" "+Dtoc(dDtVenc)+" "+cOrgArrec,nVlrTitulo,.F.})
								EndIf
							EndIf
						EndIf
					EndIf

				Next nCont

				AADD(aCOLS2,{"IND","",Transform(xMoeda(1,nMoedTit,1,dDataBase),"9.999"),0,.F.})

				// Adicionando informacoes das GNREs geradas no aCols2 para gerar no arquivo .is0
				For nContMun := 1 to Len(aGnre)
					If aGnre[nContMun,3] > 0 .And. lGuiaRec
						AADD(aApurMun,{"GNR","",PadR(aGnre[nContMun,1],nTamGnre) + aGnre[nContMun,5] + " " + Dtoc(aGnre[nContMun,2]),aGnre[nContMun,3],.F.})
					EndIf
				Next nContMun

				// Adicionando informacoes dos titulos gerados no aCols2 para gerar no arquivo .is0	
				For nContMun := 1 to Len(aApurMun)
					If aApurMun[nContMun,4] > 0// .And. lTitulo
						AADD(aCOLS2,aApurMun[nContMun])
					EndIf
				Next nContMun

				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Exibe os titulos gerados dos impostos a pagar pela apuracao ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If SuperGetMv("MV_TITAPUR",.F.,.F.)
					For nX := 1 To Len(aRecTit)
						If aRecTit[nX][01] <> 0
							dbSelectArea("SE2")
							MsGoto(aRecTit[nX][01])
							cCadastro := aRecTit[nX][02]
							// Titulo contabilizado - apos consulta com lider da CONTROLADORIA/FINANCEIRO,
							// foi estipulado retirar a verificacao e manter a chamada do FINA050
							ALTERA  := .T.
							INCLUI  := .F.
							EXCLUI  := .F.
							lRefresh:= .F.
							nMoeda  := 1
							pergunte("FIN050",.F.)

							If lAutomato
								aAuto := {}
								AADD(aAuto,{"E2_FILIAL" ,xFilial("SE2"),  NIL } )
								AADD(aAuto,{"E2_PREFIXO",SE2->E2_PREFIXO, NIL } )
								AADD(aAuto,{"E2_NUM"    ,SE2->E2_NUM,     NIL } )
								AADD(aAuto,{"E2_PARCELA",SE2->E2_PARCELA, NIL } )
								AADD(aAuto,{"E2_TIPO"   ,SE2->E2_TIPO,    NIL } )
								AADD(aAuto,{"E2_NATUREZ",SE2->E2_NATUREZ, NIL } )
								AADD(aAuto,{"E2_FORNECE",SE2->E2_FORNECE, NIL } )
								AADD(aAuto,{"E2_LOJA"   ,SE2->E2_LOJA,    NIL } )
								AADD(aAuto,{"E2_EMISSAO",SE2->E2_EMISSAO, NIL } )
								AADD(aAuto,{"E2_VENCTO" ,SE2->E2_VENCTO,  NIL } )
								AADD(aAuto,{"E2_VALOR"  ,SE2->E2_VALOR,   NIL } )
							EndIf

							FINA050(If(lAutomato,aAuto,Nil),,4,'FA050Alter("SE2",SE2->(RECNO()),2)')

							If lAutomato
								Pergunte("MTA954",.F.)
							EndIf
							
						EndIf
					Next nX
				Endif

				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Armazena linhas de observacao                                ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				For nY :=1 to MLCount(cObserv)
					If Len(Alltrim(MemoTran(MemoLine(cObserv,,nY),"")))>0
						AADD(aCols2,{"OBS","",MemoTran(MemoLine(cObserv,,nY)),})
					Endif
				Next nY

				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Gravação do arquivo .IS0                                     ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				FisApur(cImp,nAno,nMes,nApuracao,nPeriodo,cNrLivro,.t.,aCOLS2,nMoedTit,.F.,"",aHeader2[3,4])

			End Transaction
		EndIf
	EndIf
EndIf
Return
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±ºFuncao    ³Ft954Refre  ºAutor  ³Microsiga              º Data ³ 08/07/2001º±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±ºDesc.     ³ Atualiza os folders                                           º±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpA1: Array com as getdados                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function Ft954Refre(aGetDad,lVizu)

Local nLoop := 0 // nao entra se for aGetDad = 4 , pois nao existe.

DEFAULT lVizu := .T. // somente para refresh da tela, ao tentar incluir linha

For nLoop := 1 To Len(aGetDad)
	If nLoop == 6
		aCols := aClone(aCols6)
		aHeader := aClone(aHeader6)
	EndIf
	If (nLoop <> 4 .And. nLoop <> 1) .Or. (nLoop == 1 .And. lVizu)
		aGetDad[nLoop]:oBrowse:lDisablePaint := .F.
		aGetDad[nLoop]:oBrowse:Refresh(.T.)
	EndIf
	If nLoop == 6
		aCols := aClone(aCols1)
		aHeader := aClone(aHeader1)
	EndIf
Next nLoop
Return( .T. )

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³Ft954Fld  ³ Autor ³Andreia dos Santos     ³ Data ³08.08.2001³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Funcao de Tratamento dos Folders                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Folder de Destino                                    ³±±
±±³          ³ExpN2: Folder Atual                                         ³±±
±±³          ³ExpO3: Objeto do Folder                                     ³±±
±±³          ³ExpA4: Array com as getdados.                               ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function Ft954Fld(nFldDst,nFldAtu,oFolder,aGetDad,lCodMun)

Local lRetorno:= .F.
Local nPosAcols2 := 0
Local nPosACols7 := 0

Default lCodMun := FCodMun(cCodMun)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Efetua a Validacao da GetDados                        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If nFldAtu <= 3 .Or. nFldAtu == 5 .Or. nFldAtu == 6 .Or. (nFldAtu == 7 .And. lCodMun)
	If ( aGetDad[nFldAtu]:TudoOk() )
		lRetorno := .T.
		aGetDad[nFldAtu]:oBrowse:lDisablePaint := .T.
		Do Case
			Case ( nFldAtu == 1 )
				aCols1  := aClone(aCols)
				aHeader1:= aClone(aHeader)
			Case ( nFldAtu == 2 )
				aCols2  := aClone(aCols)
				aHeader2:= aClone(aHeader)
			Case ( nFldAtu == 3 )
				aCols3  := aClone(aCols)
				aHeader3:= aClone(aHeader)
			Case ( nFldAtu == 5 )
				aCols5  := aClone(aCols)
				aHeader5:= aClone(aHeader)
			Case ( nFldAtu == 6 )
				aCols6  := aClone(aCols)
				aHeader6:= aClone(aHeader)
			Case ( nFldAtu == 7 )
				aCols7   := aClone(aCols)
				aHeader7 := aClone(aHeader)
		EndCase

		If lCodMun
			nPosAcols2 := ascan(aCols2,{|x|x[1] == "011" .And. x[2]=="011.04"})
			nPosACols7 := ascan(aCols7,{|x|x[1] == "113"})
			aCols2[nPosAcols2,4] := aCols7[nPosACols7,09]
			a954Saldo(.T.)
		Endif

		If nFldDst <= 3 .Or. nFldDst == 5 .Or. nFldDst == 6 .Or. (nFldDst == 7 .And. lCodMun)
			N := Max(aGetDad[nFldDst]:oBrowse:nAt,1)
			Do Case
				Case ( nFldDst == 1 )
					aCols   := aClone(aCols1)
					aHeader := aClone(aHeader1)
				Case ( nFldDst == 2 )
					aCols   := aClone(aCols2)
					aHeader := aClone(aHeader2)
				Case ( nFldDst == 3 )
					aCols   := aClone(aCols3)
					aHeader := aClone(aHeader3)
				Case ( nFldDst == 5 )
					aCols   := aClone(aCols5)
					aHeader := aClone(aHeader5)
				Case ( nFldDst == 6 )
					aCols   := aClone(aCols6)
					aHeader := aClone(aHeader6)
				Case ( nFldDst == 7 ) 
					aCols   := aClone(aCols7)
					aHeader := aClone(aHeader7)
			EndCase
			aGetDad[nFldDst]:oBrowse:lDisablePaint := .F.
			aGetDad[nFldDst]:oBrowse:Refresh(.T.)
		EndIf
	EndIf
ElseIf nFldDst <= 3 .Or. nFldDst == 5 .Or. nFldDst == 6 .Or. (nFldDst == 7 .And. lCodMun)
	If ( aGetDad[nFldDst]:TudoOk() )
		lRetorno := .T.
		aGetDad[nFldDst]:oBrowse:lDisablePaint := .T.
		N := Max(aGetDad[nFldDst]:oBrowse:nAt,1)
		Do Case
			Case ( nFldDst == 1 )
				aCols   := aClone(aCols1)
				aHeader := aClone(aHeader1)
			Case ( nFldDst == 2 )
				aCols   := aClone(aCols2)
				aHeader := aClone(aHeader2)
			Case ( nFldDst == 3 )
				aCols   := aClone(aCols3)
				aHeader := aClone(aHeader3)
			Case ( nFldDst == 5 )
				aCols   := aClone(aCols5)
				aHeader := aClone(aHeader5)
			Case ( nFldDst == 6 )
				aCols   := aClone(aCols6)
				aHeader := aClone(aHeader6)
			Case ( nFldDst == 7 )
				aCols   := aClone(aCols7)
				aHeader := aClone(aHeader7)
		EndCase
		aGetDad[nFldDst]:oBrowse:lDisablePaint := .F.
		aGetDad[nFldDst]:oBrowse:Refresh(.T.)
	EndIf
Else
	lRetorno := If(nFldDst == 4 .and. nFldAtu == 4,.T.,.F.)
EndIf
Return(lRetorno)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³Ft954Ok   ³ Autor ³Eduardo Riera          ³ Data ³13.01.2000³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Funcao de validacao da Getdados                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpA1: Array com as getdados                                ³±±
±±³          ³ExpN2: Folder atual.                                        ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function Ft954Ok(aGetDad,nAtu)

Local lRetorno := .F.
Local aSavHead := aClone(aHeader)
Local aSavCols := aClone(aCols)
Local nSavN    := N

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Valida todas as getdados                                     ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ aCols e aHeader 1 e 2 nao coincidem com folder 1 e 2 devido  ³
//³ a um erro na classe folder ( nao alterar )                   ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ( nAtu == 2 )
	aHeader := aClone(aSavHead)
	aCols   := aClone(aSavCols)
	N       := nSavN
Else
	aHeader := aClone(aHeader1)
	aCols   := aClone(aCols1)
	N       := Max(aGetDad[1]:oBrowse:nAT,1)
EndIf
If ( aGetDad[1]:TudoOk() )
	If ( nAtu == 1 )
		aHeader := aClone(aSavHead)
		aCols   := aClone(aSavCols)
		N       := nSavN
	Else
		aHeader := aClone(aHeader2)
		aCols   := aClone(aCols2)
		N       := Max(aGetDad[2]:oBrowse:nAT,1)
	EndIf
	If ( aGetDad[2]:TudoOk() )
		lRetorno := .T.
	EndIf
EndIf

aHeader := aClone(aSavHead)
aCols   := aClone(aSavCols)
N       := nSavN

Return(lRetorno)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±ºFuncao    ³a954Saldo ºAutor  ³Andreia dos Santos     º Data ³ 13/08/01 º±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±ºDesc.     ³ Apura o saldo do ISS operacoes proprias					  º±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Primeira vez que apura o saldo quando monta o aCols  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function a954Saldo(lFirst)

Local n001	:= 0
Local n002	:= 0
Local n003	:= 0
Local n004	:= 0
Local n005	:= 0
Local n006	:= 0
Local n007	:= 0
Local n008	:= 0
Local n009	:= 0
Local n010	:= 0
Local n011	:= 0
Local n012 	:= 0
Local n013	:= 0
Local n11	:= 0
Local n112	:= 0
Local n113	:= 0
Local nLin001 := 0
Local nLin002 := 0
Local nLin003 := 0
Local nLin005 := 0
Local nLin006 := 0
Local nLin011 := 0
Local nLin112 := 0
Local nLi00201:= 0
Local n1101   := 0
Local n1102   := 0
Local n1103   := 0
Local n1104   := 0

Local nPosRecPR := 0

n001	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[1]=="001"}) //por saidas com debito do imposto
n002	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[1]=="002"}) //Serv. executados por Terc. c.ret. de imposto
n00201	:= Ascan(if(lFirst,aCols2,aCols),{|x|STR0045 $ x[3]})//total das subempreitadas
n003	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[1]=="003"}) //outros debitos
n004	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[1]=="004"}) //Sub-Total
n005	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[1]=="005"}) //estorno de debitos
n006	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[1]=="006"}) //outros creditos
n007	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[1]=="007"}) //Sub-total
n008	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[1]=="008"}) //Saldo credor do periodo anterior
n009	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[1]=="009"}) //Total
n010	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[1]=="010"}) //Saldo devedor
n011	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[1]=="011"}) //Deducoes
n11		:= Ascan(if(lFirst,aCols2,aCols),{|x|x[2]=="011.01"}) //Desconto - Tabela Progressiva
n112	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[2]=="011.02"}) //Imposto retido pelo tomador do servico
n113	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[2]=="011.03"}) //Imposto a recolher em outros municípios
n1101	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[2]=="011001"}) //"Ded. Abatim. Trib. Federais - IRRF - LC 185/07"
n1102	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[2]=="011002"}) //"Ded. Abatim. Trib. Federais - PIS - LC 185/07"
n1103	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[2]=="011003"}) //"Ded. Abatim. Trib. Federais - Cofins - LC 185/07"
n1104	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[2]=="011004"}) //"Ded. Abatim. Trib. Federais - CSLL - LC 185/07"
n012 	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[1]=="012"}) //imposto a recolher
n013	:= Ascan(if(lFirst,aCols2,aCols),{|x|x[1]=="013"}) //Saldo Credor

If n001 > 0
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Totalizacao das linhas expandidas³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	a954TotLin(n002,"002",lFirst,aCols2)
	a954TotLin(n003,"003",lFirst,aCols2)
	a954TotLin(n005,"005",lFirst,aCols2)
	a954TotLin(n006,"006",lFirst,aCols2)
	a954TotLin(n011,"011",lFirst,aCols2)

	If !lFirst
		If ReadVar() =="M->NVALOR"
			nLin001 := if(aCols[n,1]==aCols[n001,1],M->NVALOR,aCols[n001,4])
			nLin004 := if(aCols[n,1]==aCols[n004,1],M->NVALOR,aCols[n004,4])
			nLin008 := if(aCols[n,1]==aCols[n008,1],M->NVALOR,aCols[n008,4])
		Elseif empty(ReadVar())
			nLin001 := aCols[n001,4]
			nLin004 := aCols[n004,4]
			nLin008 := aCols[n008,4]
		Endif	
		nLin002 := aCols[n002,4]
		nLin003 := aCols[n003,4]
		nLin005 := aCols[n005,4]
		nLin006 := aCols[n006,4]
		nLin011 := aCols[n011,4] //deducoes
		nLi00201 := 0
		//se houver valor de subempreitada, pego o valor
		If n00201 > 0
			nLi00201 := aCols[n00201,4]
		Endif
		aCols[n004,04] := nLin001+nLin003+nLin002-nLi00201 //total saidas 
		aCols[n007,04] := nLin005+nLin006 //sub-total entradas
		aCols[n009,04] := aCols[n007,4]+nLin008 //total entradas
		aCols[n010,04] := if(aCols[n004,4]-aCols[n009,4]>=0,aCols[n004,4]-aCols[n009,4],0) //Saldo Devedor( 004-009 )
		aCols[n012,04] := if(aCols[n010,4]-nLin011>=0,aCols[n010,4]-nLin011,0) //Imposto a recolher( 010-011 )
		aCols[n013,04] := if(aCols[n009,4]-nLin004>=0,aCols[n009,4]-nLin004,0) //Saldo Credor( 009-004 )
		nVlrTitulo := aCols[n012,4]
	Else
		aCols2[n004,04]:= aCols2[n001,4]+aCols2[n003,4]+aCols2[n002,4] //total saidas
		//Valor de subempreitada deve ser excluído do total de saidas
		If n00201 > 0
			aCols2[n004,04] -= aCols2[n00201,4]
		Endif
		aCols2[n007,04] := aCols2[n005,4]+aCols2[n006,4] //sub-total entradas
		aCols2[n009,04] := aCols2[n007,4]+aCols2[n008,4] //total entradas
		aCols2[n010,04] := if(aCols2[n004,4]-aCols2[n009,4]>=0,aCols2[n004,4]-aCols2[n009,4],0) //Saldo Devedor( 004-009 )
		If lTabProg .And. aCols2[n010,04] >0 .And. nFat >0 .And. lApurTab
			If nFat >=aMVFXFAT01[1] .And. nFat <=aMVFXFAT01[2] // Faixa 1
				aCols2[n11,04] := aMVFXFAT01[4]
				aCols5[1,1]    := "LBTIK"
			Elseif nFat >=aMVFXFAT02[1] .And. nFat <=aMVFXFAT02[2] // Faixa 2
				aCols2[n11,04] := aMVFXFAT02[4]
				aCols5[2,1]    := "LBTIK"
			Elseif	nFat >=aMVFXFAT03[1] .And. nFat <=aMVFXFAT03[2] // Faixa 3
				aCols2[n11,04] := aMVFXFAT03[4]
				aCols5[3,1]    := "LBTIK"
			Else // Faixa 4
				aCols2[n11,04] := aMVFXFAT04[4]
				aCols5[4,1]    := "LBTIK"
			Endif
		Endif
		a954TotLin(n011,"011",lFirst,aCols2)
		aCols2[n012,04] := if(aCols2[n010,4]-aCols2[n011,4]>=0,aCols2[n010,4]-aCols2[n011,4],0) //Saldo Devedor-Deducao-Desconto
		aCols2[n013,04] := if(aCols2[n009,4]-aCols2[n004,4]>=0,aCols2[n009,4]-aCols2[n004,4],0) //Saldo Credor( 009-004 )
		nVlrTitulo := aCols2[n012,4]
	Endif
Endif
Return(.t. )

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±ºFuncao    ³a954Saldo2ºAutor  ³Andreia dos Santos     º Data ³ 13/08/01 º±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±ºDesc.     ³ Apura o saldo do ISS referente Demonstrativos              º±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Primeira vez que apura o saldo quando monta o aCols  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function a954Saldo2(lFirst)

Local n000 := 0

n000 := Ascan(if(lFirst,aCols3,aCols),{|x|x[1]=="000"})
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Totalizacao das linhas expandidas³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
a954TotLin(n000,"000",lFirst,aCols3)
aCols3[n000,04] := aCols3[n000,4]
Return(.t. )

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±ºFuncao    ³a954Saldo3ºAutor  ³Natalia Antonucci      º Data ³ 15/07/11 º±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±ºDesc.     ³ Apura o valor do ISS a recuperar referente ao              º±±
±±º	 	   	 ³ Quadro de Ajuste                 						  º±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Primeira vez que apura o valor quando monta o aCols  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function a954Saldo3(lFirst)

Local n111	:= 0
Local n112	:= 0
Local n113	:= 0
Local nRecebe := 0
Local nLin111 := 0
Local nLin112 := 0
Local nLin113 := 0


n111 := Ascan(if(lFirst,aCols7,aCols),{|x|x[1]=="111"})
n112 := Ascan(if(lFirst,aCols7,aCols),{|x|x[1]=="112"})
n113 := Ascan(if(lFirst,aCols7,aCols),{|x|x[1]=="113"})

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Totalizacao das linhas expandidas³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

a954TotLi7(n111,"111",lFirst,@aCols7)
nRecebe := a954Ret(.F.,"",mv_par01,mv_par02)
aCols7[n112,9]:= nRecebe[1]
nLin112	:= nRecebe[1]

If !lFirst
	If ReadVar() == "M->NVALOR"
		nLin113 := if(aCols[n,1]==aCols[n113,1],M->NVALOR,aCols[n113,9])
	ElseIf Empty(ReadVar())
		nLin113 := aCols[n113,9]
	EndIf

	nLin111 := aCols[n111,9]
	aCols[n113,09] := nLin111+nLin112
Else
	aCols7[n113,09]:= aCols7[n111,9]+aCols7[n112,9]
Endif

Return(.T.)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±ºFunction  ³AddCols   ºAutor  ³Andreia dos Santos     º Data ³  13/08/01º±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±ºDesc.     ³ Adiciona linha no acols para "outros Debitos","outros crediº±±
±±º          ³tos","Estorno de debitos","Estorno de debitos" e "Deducoes" º±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: GetDados                                             ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function AddAcols(oGetDad)
Local i, nPos
Local cTipo

If oGetDad <> NIL
	If aCols[n][1] == "000" .and. alltrim(aCols[n][2]) =="000.00"
		nPos := n-1
		Aeval(aCols,{|x| if(x[1]=="000" .and. x[5]==.F.,nPos++,)}) 
		nPos++
		aCols := Asize(aCols,Len(aCols)+1)
		aCols := Ains(aCols,nPos)
		aCols[nPos] := Array(Len(aHeader)+1)

		For i := 1 To Len(aHeader)
			cTipo := aHeader[i][8]
			If cTipo $ "CM"
				aCols[nPos][i] := Space(aHeader[i][4])
			ElseIf cTipo == "N"
				aCols[nPos][i] := 0
			ElseIf cTipo == "L"
				aCols[nPos][i] := .F.
			ElseIf cTipo == "D"
				aCols[nPos][i] := Ctod("")
			EndIf
		Next
		aCols[nPos][1] := "000"
		aCols[nPos][Len(aHeader)+1] := .F.
		oGetDad:GOTO(nPos)
		Eval(oGetDad:obrowse:bDrawSelect)
	ElseIf aCols[n][1] == "002" .and. alltrim(aCols[n][2]) =="002.00" .And. oFolder:nOption == 2
		nPos := n-1
		Aeval(aCols,{|x| if(x[1]=="002" .and. x[5]==.F.,nPos++,)})
		nPos++
		aCols := Asize(aCols,Len(aCols)+1)
		aCols := Ains(aCols,nPos)
		aCols[nPos] := Array(Len(aHeader)+1)

		For i := 1 To Len(aHeader)
			cTipo := aHeader[i][8]
			If cTipo $ "CM"
				aCols[nPos][i] := Space(aHeader[i][4])
			ElseIf cTipo == "N"
				aCols[nPos][i] := 0
			ElseIf cTipo == "L"
				aCols[nPos][i] := .F.
			ElseIf cTipo == "D"
				aCols[nPos][i] := Ctod("")
			EndIf
		Next
		aCols[nPos][1] := "002"
		aCols[nPos][Len(aHeader)+1] := .F.
		oGetDad:GOTO(nPos)
		Eval(oGetDad:obrowse:bDrawSelect)
	ElseIf aCols[n][1] == "003" .and. alltrim(aCols[n][2]) =="003.00" .And. oFolder:nOption == 2
		nPos := n-1
		Aeval(aCols,{|x| if(x[1]=="003" .and. x[5]==.F.,nPos++,)})
		nPos++
		aCols := Asize(aCols,Len(aCols)+1)
		aCols := Ains(aCols,nPos)
		aCols[nPos] := Array(Len(aHeader)+1)
	
		For i := 1 To Len(aHeader)
			cTipo := aHeader[i][8]
			If cTipo $ "CM"
				aCols[nPos][i] := Space(aHeader[i][4])
			ElseIf cTipo == "N"
				aCols[nPos][i] := 0
			ElseIf cTipo == "L"
				aCols[nPos][i] := .F.
			ElseIf cTipo == "D"
				aCols[nPos][i] := Ctod("")
			EndIf
		Next
		aCols[nPos][1] := "003"
		aCols[nPos][Len(aHeader)+1] := .F.
		oGetDad:GOTO(nPos)
		Eval(oGetDad:obrowse:bDrawSelect)
	ElseIf aCols[n][1] == "005" .and. alltrim(aCols[n][2]) =="005.00" .And. oFolder:nOption == 2
		nPos := n-1
		Aeval(aCols,{|x| if(x[1]=="005" .and. x[5]==.F.,nPos++,)})
		nPos++
		aCols := Asize(aCols,Len(aCols)+1)
		aCols := Ains(aCols,nPos)
		aCols[nPos] := Array(Len(aHeader)+1)
	
		For i := 1 To Len(aHeader)
			cTipo := aHeader[i][8]
			If cTipo $ "CM"
				aCols[nPos][i] := Space(aHeader[i][4])
			ElseIf cTipo == "N"
				aCols[nPos][i] := 0
			ElseIf cTipo == "L"
				aCols[nPos][i] := .F.
			ElseIf cTipo == "D"
				aCols[nPos][i] := Ctod("")
			EndIf
		Next
		aCols[nPos][1] := "005"
		aCols[nPos][Len(aHeader)+1] := .F.
		oGetDad:GOTO(nPos)
		Eval(oGetDad:obrowse:bDrawSelect)
	ElseIf aCols[n][1] == "006" .and. alltrim(aCols[n][2]) =="006.00" .And. oFolder:nOption == 2
		nPos := n-1
		Aeval(aCols,{|x| if(x[1]=="006" .and. x[5]==.F.,nPos++,)})
		nPos++
		aCols := Asize(aCols,Len(aCols)+1)
		aCols := Ains(aCols,nPos)
		aCols[nPos] := Array(Len(aHeader)+1)

		For i := 1 To Len(aHeader)
			cTipo := aHeader[i][8]
			If cTipo $ "CM"
				aCols[nPos][i] := Space(aHeader[i][4])
			ElseIf cTipo == "N"
				aCols[nPos][i] := 0
			ElseIf cTipo == "L"
				aCols[nPos][i] := .F.
			ElseIf cTipo == "D"
				aCols[nPos][i] := Ctod("")
			EndIf
		Next
		aCols[nPos][1] := "006"
		aCols[nPos][Len(aHeader)+1] := .F.
		oGetDad:GOTO(nPos)
		Eval(oGetDad:obrowse:bDrawSelect)
	ElseIf aCols[n][1] == "011" .and. alltrim(aCols[n][2]) =="011.00" .And. oFolder:nOption == 2
		nPos := n-1
		Aeval(aCols,{|x| if(x[1]=="011" .and. x[5]==.F.,nPos++,)}) 
		nPos++
		aCols := Asize(aCols,Len(aCols)+1)
		aCols := Ains(aCols,nPos)
		aCols[nPos] := Array(Len(aHeader)+1)

		For i := 1 To Len(aHeader)
			cTipo := aHeader[i][8]
			If cTipo $ "CM"
				aCols[nPos][i] := Space(aHeader[i][4])
			ElseIf cTipo == "N"
				aCols[nPos][i] := 0
			ElseIf cTipo == "L"
				aCols[nPos][i] := .F.
			ElseIf cTipo == "D"
				aCols[nPos][i] := Ctod("")
			EndIf
		Next
		aCols[nPos][1] := "011"
		aCols[nPos][Len(aHeader)+1] := .F.
		oGetDad:GOTO(nPos)
		Eval(oGetDad:obrowse:bDrawSelect)
	ElseIf aCols[n][1] == "111" .and. alltrim(aCols[n][2]) =="111.00" .And. oFolder:nOption == 7
		nPos := n-1
		Aeval(aCols,{|x| if(x[1]=="111" .and. x[10]==.F.,nPos++,)})
		nPos++
		aCols := Asize(aCols,Len(aCols)+1)
		aCols := Ains(aCols,nPos)
		aCols[nPos] := Array(Len(aHeader)+1)
		For i := 1 To Len(aHeader)
			cTipo := aHeader[i][8]
			If cTipo $ "CM"
				aCols[nPos][i] := Space(aHeader[i][4])
			ElseIf cTipo == "N"
				aCols[nPos][i] := 0
			ElseIf cTipo == "L"
				aCols[nPos][i] := .F.
			ElseIf cTipo == "D"
				aCols[nPos][i] := Ctod("")
			EndIf
		Next
		aCols[nPos][1] := "111"
		aCols[nPos][Len(aHeader)+1] := .F.
		oGetDad:GOTO(nPos)
		Eval(oGetDad:obrowse:bDrawSelect)
	EndIf

	Ft954Refre({oGetDad},.F.)
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±ºFuncao    ³a954CPO5ALT³Autor  ³Andreia dos Santos    ³ Data ³13/08/2001³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±ºDesc.     ³Atualiza os campos que podem ser alterados a cada troca de  ³±±
±±º          ³folder( para a apuracao das operacoes proprias)             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: GetDados                                             ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
function a954CPO5ALT(oGetDad)

If oFolder:nOption <> 7
	If empty(aCols[oGetDad:nAt][1]).or. aCols[oGetDad:nAt][1]$"004#008#009#010#012#013"
		oGetDad:aAlter := {}
		oGetDad:oMother:aAlter := {}
	ElseIf aCols[oGetDad:nAt][1]$"000#002#003#005#006#011"
		if alltrim(aCols[oGetDad:nAt][2])$"002.00#003.00#005.00#006.00#011.00"
			oGetDad:aAlter := {}
			oGetDad:oMother:aAlter := {}
		else
			oGetDad:aAlter :={"cCodigo","cDescr","nValor"}
			oGetDad:oMother:aAlter :={"cCodigo","cDescr","nValor"}
		EndIf
	Else
		oGetDad:aAlter := {"nValor"}
		oGetDad:oMother:aAlter := {"nValor"}
	EndIf
Else
	If Empty(aCols[oGetDad:nAt][1]).or. aCols[oGetDad:nAt][1]$"112#113"
		oGetDad:aAlter := {}
		oGetDad:oMother:aAlter := {}
	ElseIf aCols[oGetDad:nAt][1]$"111"
		If alltrim(aCols[oGetDad:nAt][2])$"111.00"
			oGetDad:aAlter := {}
			oGetDad:oMother:aAlter := {}
		Else
			oGetDad:aAlter :={"cCodigo","cDescr","cEspecie","cSerie","cNumero","cCfps","CCst","nValor" }
			oGetDad:oMother:aAlter :={"cCodigo","cDescr","cEspecie","cSerie","cNumero","cCfps","CCst","nValor" }
		EndIf
	Else
		oGetDad:aAlter := {"nValor"}
		oGetDad:oMother:aAlter := {"nValor"}
	EndIf
Endif
return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±ºFuncao    ³a954TotLin ³Autor  ³Andreia dos Santos    ³ Data ³ 15/08/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±ºDesc.     ³Totaliza as linhas que podem ser expandidas                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Posicao da linha totalizadora                        ³±±
±±³          ³ExpN2: Numero da linha que sera totalizada                  ³±±
±±³          ³ExpN3: primeira vez que apura o saldo na montagem do aCols  ³±±
±±³          ³ExpN4: aCols                                                ³±±
±±³          ³ExpN5: indica se a funcao foi chamada a partir da delecao da³±±
±±³          ³       linha                                                ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function a954TotLin(nPos,cLin,lFirst,aColun)
If nPos > 0
   If !lFirst
      aCols[nPos,4] := 0
      Aeval(aCols,{|x,y| if(x[1]==cLin .and. x[5]==.F. .and. y<>n ,aCols[nPos,4]+=x[4],)})
      If !empty(ReadVar()) .And. Type('N') == "N"
         aCols[nPos,4] += if(aCols[n,1]==aCols[nPos,1].and. aCols[n,5]==.F.,M->NVALOR,0)
      Endif
   Else
      aColun[nPos,4] := 0
      Aeval(aColun,{|x| if(x[1]==cLin .and. x[5]==.F.,aColun[nPos,4]+=x[4],)})
      If !empty(ReadVar()) .And. Type('N') == "N"
	     aColun[nPos,4] += if(aColun[n,1]==aColun[nPos,1].and. aColun[n,5]==.F.,M->NVALOR,0)
      Endif
   Endif
Endif
Return
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±ºFuncao    ³a954TotLi7 ³Autor  ³Natalia Antonucci     ³ Data ³ 15/07/11 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±ºDesc.     ³Totaliza as linhas que podem ser expandidas do              ³±±
±±º		     ³Quadro de Ajuste 											  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Posicao da linha totalizadora                        ³±±
±±³          ³ExpN2: Numero da linha que sera totalizada                  ³±±
±±³          ³ExpN3: primeira vez que apura o saldo na montagem do aCols  ³±±
±±³          ³ExpN4: aCols                                                ³±±
±±³          ³ExpN5: indica se a funcao foi chamada a partir da delecao da³±±
±±³          ³       linha                                                ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function a954TotLi7(nPos,cLin,lFirst,aColun)
If nPos > 0
   If !lFirst
      aCols[nPos,9] := 0
      Aeval(aCols,{|x,y| if(x[1]==cLin .and. x[10]==.F. .and. y<>n ,aCols[nPos,9]+=x[9],)})
      If !empty(ReadVar()) .And. Type('N') == "N"
         aCols[nPos,9] += if(aCols[n,1]==aCols[nPos,1].and. aCols[n,10]==.F.,M->nValor,0)
      Endif
   Else
      aColun[nPos,9] := 0
      Aeval(aColun,{|x| if(x[1]==cLin .and. x[10]==.F.,aColun[nPos,9]+=x[9],)})
      If !empty(ReadVar()) .And. Type('N') == "N"
	     aColun[nPos,9] += if(aColun[n,1]==aColun[nPos,1].and. aColun[n,10]==.F.,M->nValor,0)
      Endif
   Endif
Endif
Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³a954Del5Col³Autor  ³Andreia dos Santos    ³ Data ³ 16/08/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Desc.     ³Verifica se a linha pode ser deletada( aCols 2)             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function a954Del5Col()
Local lRet := .F.

If !(alltrim(aCols[n,1])$"000" .And. alltrim(aCols[n,2])=="000.00" .Or.;
     alltrim(aCols[n,1])$"001" .And. alltrim(aCols[n,2])=="" .Or. ;
     alltrim(aCols[n,1])$"002" .And. alltrim(aCols[n,2])=="002.00" .Or. ;
     alltrim(aCols[n,1])$"003" .And. alltrim(aCols[n,2])=="003.00" .Or. ;
     alltrim(aCols[n,1])$"004" .And. alltrim(aCols[n,2])=="" .Or. ;
     alltrim(aCols[n,1])$"005" .And. alltrim(aCols[n,2])=="005.00" .Or. ;
     alltrim(aCols[n,1])$"006" .And. alltrim(aCols[n,2])=="006.00" .Or. ;
     alltrim(aCols[n,1])$"007" .And. alltrim(aCols[n,2])=="" .Or. ;
     alltrim(aCols[n,1])$"008" .And. alltrim(aCols[n,2])=="" .Or. ;
     alltrim(aCols[n,1])$"009" .And. alltrim(aCols[n,2])=="" .Or. ;
     alltrim(aCols[n,1])$"010" .And. alltrim(aCols[n,2])=="" .Or. ;
     alltrim(aCols[n,1])$"011" .And. alltrim(aCols[n,2])=="011.00" .Or. ;
     alltrim(aCols[n,1])$"012" .And. alltrim(aCols[n,2])=="" .Or. ;
     alltrim(aCols[n,1])$"013" .And. alltrim(aCols[n,2])=="" .Or. ;
     alltrim(aCols[n,1])=="" .And. alltrim(aCols[n,2])=="")
   lRet := .T.
   aCols[n,4] :=0
EndIf

If lRet .And. aCols[n,1] $"000"
	a954Saldo2(.F.)
Else
	a954Saldo(.F.)
EndIf

Return( lRet )

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³a954Del7Col³Autor  ³Natalia Antonucci     ³ Data ³ 15/07/11 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Desc.     ³Verifica se a linha pode ser deletada( aCols 7)             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function a954Del7Col()
Local lRet := .F.

If ! (alltrim(aCols[n,1])$"111" .And. alltrim(aCols[n,2])=="111.00" .Or. ;
     alltrim(aCols[n,1])$"112" .Or. ;
     alltrim(aCols[n,1])$"113" .Or. ;
     alltrim(aCols[n,1])=="")
   lRet := .T.
   aCols[n,9] :=0
EndIf

If lRet
	a954Saldo3(.F.)
EndIf

Return( lRet )
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³A954Lin5Ok ³Autor  ³Andreia dos Santos    ³ Data ³ 17/08/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Desc.     ³Verifica se os campos obrigatorios da Apuracao de ICMS pro- ³±±
±±³          ³prio estao preenchidos                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/

Function A954Lin5Ok()
Local lRet := .T.
If aCols[n,1] $"002#003#005#006#011" .and. !(alltrim(aCols[n,2])$"002.00#003.00#005.00#006.00#011.00") .and.;
	aCols[n,5] == .F.
	if empty(aCols[n,3]) .or. aCols[n,4]==0
		lRet := .F.
	EndIf
Endif

Return( lRet )

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³A954Lin7Ok ³Autor  ³Natalia Antonucci     ³ Data ³ 17/08/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Desc.     ³Verifica se os campos obrigatorios da Apuracao do Quadro    ³±±
±±³          ³de Ajute estao preenchidos              					  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/

Function A954Lin7Ok()
Local lRet := .T.

If aCols[n,1] $"111" .and. !(alltrim(aCols[n,2])$"111.00") .and. aCols[n,10] == .F.
	If (empty(aCols[n,2]) .OR. empty(aCols[n,3]) .OR.;
		empty(aCols[n,4]) .OR. empty(aCols[n,5]) .OR.;
		empty(aCols[n,6]) .OR. empty(aCols[n,7]) .OR.;
		empty(aCols[n,8]) .OR. 	aCols[n,9]==0)
		lRet := .F.
	EndIf
Endif

Return( lRet )

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³A954Codigo ³Autor  ³Andreia dos Santos    ³ Data ³ 06/09/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Desc.     ³ Valida codigo digitado.                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function a954Codigo()
Local lRet := .T.
If  alltrim(M->cCodigo)$"002.00#003.00#005.00#006.00#007.00#011.00" .And. aCols[n,5] == .F.
	lRet := .F.
Endif

Return( lRet )

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³A954Apura  ³Autor  ³Andreia dos Santos    ³ Data ³ 20/08/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Desc.     ³ Apura os valores do ICMS do periodo e distribui nos folders³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function a954Apura(cImp,dDtIni,dDtFim,cNrLivro,nConsFil,cFilDe,cFilAte,aFilsCalc,cMunSgmt,aFornISS,lAutomato,lCodMun)

Local aApuracao 	:= {}
Local aApurMun		:= {}
Local cArqAnt		:= mv_par06
Local nPos			:= 0
Local nPos5			:= 0
Local nI 			:= 0
Local nPosDed		:= 0
Local nVlrOutMun	:= 0
Local nBaseISS		:= 0
Local nPosAcols2 	:= 0
Local nPosACols7	:= 0
Local nValIrf		:= 0
Local nValPis		:= 0
Local nValCof		:= 0
Local nValCsl		:= 0
Local nValRet   := 0
Local lRet := .F.
Local nTamCod := TamSX3("A2_COD")[1]
Local nTamLoj := TamSX3("A2_LOJA")[1]
//Local cTpAbISS := SuperGetMv("MV_TPABISS",.F.)

Default lAutomato := .F.
Default lCodMun   := FCodMun(cCodMun)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Carrega apuracao do SF3                                      ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Processa({||aApuracao:=ResumeF3(cImp,dDtIni,dDtFim,cNrLivro,.t.,.t.,1,.F.,nConsFil,cFilDe,cFilAte,{},{},,,,,,,,,,,,,,,,,,,aFilsCalc,@aApurMun,,,,,,,,,,,,,,,lAutomato)})

lRet := Len(aApuracao) > 0

For nI := 1 to Len(aApuracao)

	//Zero as variaveis
	nBaseISS	:= 0
	nValIrf		:= 0
	nValPis		:= 0
	nValCof		:= 0
	nValCsl		:= 0

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Montagem do aCols (1)  - Op. Proprias Saida           ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nPos :=  Ascan(aCOLS1,{|x|x[1]==aApuracao[nI,1]})
	If nPos==0
		AADD(aCOLS1,Array(09))
		nPos			:=	Len(aCOLS1)
		aCOLS1[nPos,01]	:=	aApuracao[nI,1]
		aCOLS1[nPos,9] := .F.
		Aeval(aCOLS1[nPos],{|x,nI|aCOLS1[nPos,nI]:=0},2,7)
	Endif

	aCOLS1[nPos,2] += aApuracao[nI,11] //Valor Contabil
	aCOLS1[nPos,3] += aApuracao[nI,03] //Base do ISS

	nPos5 := Ascan(aCols2,{|x|x[1]=="001"})

	If lTabProg .And. lApurTab
		If nFat >=aMVFXFAT01[1] .And. nFat <=aMVFXFAT01[2]  // Faixa 1
			aCOLS1[nPos,4] += (aApuracao[nI,11]*aMVFXFAT01[3]/100)//Valor do ISS
			aCols2[nPos5,04] += (aApuracao[nI,11]*aMVFXFAT01[3]/100)//Valor do ISS
		Elseif nFat >=aMVFXFAT02[1] .And. nFat <=aMVFXFAT02[2] // Faixa 2
			aCOLS1[nPos,4]+= (aApuracao[nI,11]*aMVFXFAT02[3]/100)//Valor do ISS
			aCols2[nPos5,04] += (aApuracao[nI,11]*aMVFXFAT02[3]/100)//Valor do ISS
		Elseif nFat >=aMVFXFAT03[1] .And. nFat <=aMVFXFAT03[2] // Faixa 3
			aCOLS1[nPos,4]+= (aApuracao[nI,11]*aMVFXFAT03[3]/100)//Valor do ISS
			aCols2[nPos5,04] += (aApuracao[nI,11]*aMVFXFAT03[3]/100)//Valor do ISS
		Else  // Faixa 4
			aCOLS1[nPos,4]+= (aApuracao[nI,11]*aMVFXFAT04[3]/100)//Valor do ISS
			aCols2[nPos5,04] += (aApuracao[nI,11]*aMVFXFAT04[3]/100)//Valor do ISS
		Endif
	Else
		aCOLS1[nPos,4] += aApuracao[nI,04] //Valor do ISS 
		aCols2[nPos5,04] += aApuracao[nI,04] //Valor do ISS
	Endif

	aCOLS1[nPos,5] += aApuracao[nI,132] // Retido
	aCOLS1[nPos,6] += aApuracao[nI,04] - aApuracao[nI,132] // Devido: Debitado - Retido
	aCOLS1[nPos,7] += aApuracao[nI,05] //Isentas
	aCOLS1[nPos,8] += aApuracao[nI,06] //Outras
	// Total Das Subempreitadas
	nPos5 := Ascan(aCols2,{|x| STR0045$x[3]})
	aCols2[nPos5,04] += aApuracao[nI,29]

Next nI

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Montagem do aCols (6) - ISS por Municipio             ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

For nI := 1 to Len(aApurMun)

	// Devo mostrar os valores mesmo se estiver vazio para que o cliente veja que os cadastros estão incorretos.
	/* 
	If Empty(aApurMun[nI,1])
		Loop
	EndIf*/

	nPos := Ascan(aCOLS6,{|x|x[1] == aApurMun[nI,1]})

	If nPos == 0
		AADD(aCOLS6, Array(13))
		nPos := Len(aCOLS6)
		aCOLS6[nPos,1] := aApurMun[nI,1]
		aCOLS6[nPos,2] := aApurMun[nI,2]

		Aeval(aCOLS6[nPos],{|x,nI|aCOLS6[nPos,nI] := 0},3,10) // Zerando as posicoes 3 a 11.

		aCOLS6[nPos,13] := .F.
	EndIf

	aCOLS6[nPos,3] += aApurMun[nI,3] //Valor Contabil
	aCOLS6[nPos,4] += aApurMun[nI,4] //Base do ISS

	nPos5 := Ascan(aCols2,{|x|x[1] == "001"})

	If lTabProg .And. lApurTab
		If nFat >= aMVFXFAT01[1] .And. nFat <=aMVFXFAT01[2]  // Faixa 1
			aCOLS6[nPos,5] += (aApurMun[nI,3]*aMVFXFAT01[3]/100)//Valor do ISS
		ElseIf nFat >= aMVFXFAT02[1] .And. nFat <=aMVFXFAT02[2] // Faixa 2
			aCOLS6[nPos,5] += (aApurMun[nI,3]*aMVFXFAT02[3]/100)//Valor do ISS
		ElseIf nFat >= aMVFXFAT03[1] .And. nFat <=aMVFXFAT03[2] // Faixa 3
			aCOLS6[nPos,5] += (aApurMun[nI,3]*aMVFXFAT03[3]/100)//Valor do ISS
		Else  // Faixa 4
			aCOLS6[nPos,5] += (aApurMun[nI,3]*aMVFXFAT04[3]/100)//Valor do ISS
		EndIf
	Else
		aCOLS6[nPos,5] += aApurMun[nI,5]

		If Alltrim(cMunSgmt) <> Alltrim(aApurMun[nI,1])
			nVlrOutMun += aApurMun[nI,5] - aApurMun[nI,11] //Valor do ISS Debitado - Valor do ISS Retido 
		EndIf
	EndIf

	aCOLS6[nPos,6] += aApurMun[nI,11] // Retido
	aCOLS6[nPos,7] += aApurMun[nI,5] - aApurMun[nI,11] // ISS Devido: Valor do ISS Debitado - Valor do ISS Retido 

	aCOLS6[nPos,8] += aApurMun[nI,6] //Isentas
	aCOLS6[nPos,9] += aApurMun[nI,7] //Outras

	//Abatimentos
	aCOLS6[nPos,10] += aApurMun[nI,8] //Abat. Materiais
	aCOLS6[nPos,11] += aApurMun[nI,9] //Abat. Servicos

	aCOLS6[nPos,12] += aApurMun[nI,8] + aApurMun[nI,9] //Total de Abatimanetos

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Montagem do array com os fornecedores de cada municipio para geracao dos titulos a pagar  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

	// Validacao necessaria para que o fornecedor do proprio municipio seja sobreposto
	// caso haja prestacao de servico realizada dentro do municipio.

	// Se nao houver, o fornecedor será o informado no MV_MUNIC (que já está no array).
	nPosForIss := AScan(aFornISS, {|x| AllTrim(x[1]) == Alltrim(aApurMun[nI,1])})
	If nPosForIss == 0
		If Len(aApurMun[nI]) >= 12
			aAdd(aFornISS,{Alltrim(aApurMun[nI,1]), PadR(AllTrim(aApurMun[nI,10]),nTamCod), PadR(AllTrim(aApurMun[nI,12]), nTamLoj)})
		Else
			aAdd(aFornISS,{Alltrim(aApurMun[nI,1]), PadR(AllTrim(aApurMun[nI,10]),nTamCod)})
		EndIf
	Else
		aFornISS[nPosForIss][2] := PadR(AllTrim(aApurMun[nI,10]),nTamCod)
		If Len(aApurMun[nI]) >= 12
			aFornISS[nPosForIss][3] := PadR(AllTrim(aApurMun[nI,12]),nTamLoj)
		Else
			aFornISS[nPosForIss][3] := ""
		EndIf
	EndIf

Next nI

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Sub-Total de Creditos                                        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

nPos5 := Ascan(aCols2,{|x|x[1] == "007"})
aCols2[nPos5,4] := LoadAnt(cArqAnt,"013")

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Deducoes dos valores a serem recolhidos em outros municípios ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

nPosDed := Ascan(aCols2,{|x|x[1] == "011" .And. x[2]=="011.03"})
aCols2[nPosDed,4] := nVlrOutMun

// Se nao existirem deducoes, a linha sera excluida
If aCols2[nPosDed,4] == 0
	aDel(aCols2,nPosDed)
	aSize(aCols2,Len(aCols2)-1)
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Deducoes referentes as retencoes ja pagas pelo cliente. ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

// A funcao Mt954DedIS retorna os valores dos titulos de abatimento (IS-)
// e calcula os valores de IRRF, PIS, COFINS e CSLL, que serão deduzidos posteriormente.

// Retirada chamada desta funcao pois os valores dos tributos federais só devem ser descontados
// para o municipio de Barueri e, neste caso, a deducao deve ser feita na emissão da NF.
// Desta forma,nao é necessario debitar novamente os valores na apuracao.

//nValRet := Mt954DedIS(dDtIni,dDtFim,@nValIrf,@nValCsl,@nValPis,@nValCof)

// Quando o folder de ajustes não for exibido, gerar a linha de deducoes.
If !lCodMun
	nValRet := a954Ret(.F.,"",mv_par01,mv_par02)[1]
EndIf

nPosDed := Ascan(aCols2,{|x|x[1] == "011" .And. x[2]=="011.02"})
aCols2[nPosDed,4] := nValRet

// Se nao existirem deducoes, a linha sera excluida
If aCols2[nPosDed,4] == 0
	aDel(aCols2,nPosDed)
	aSize(aCols2,Len(aCols2)-1)
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Deducoes dos impostos federais - IRRF, PIS, COFINS e CSLL    ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

//IRRF
nPosDed := Ascan(aCols2,{|x|x[1] == "011" .And. x[2]=="011001"})
If nValIrf > 0
	aCols2[nPosDed,4] := nValIrf
Else
	aDel(aCols2,nPosDed)
	aSize(aCols2,Len(aCols2)-1)
EndIf

//PIS
nPosDed := Ascan(aCols2,{|x|x[1] == "011" .And. x[2]=="011002"})
If nValPis > 0
	aCols2[nPosDed,4] := nValPis
Else
	aDel(aCols2,nPosDed)
	aSize(aCols2,Len(aCols2)-1)	
EndIf

//COFINS
nPosDed := Ascan(aCols2,{|x|x[1] == "011" .And. x[2]=="011003"})
If nValCof > 0
	aCols2[nPosDed,4] := nValCof
Else
	aDel(aCols2,nPosDed)
	aSize(aCols2,Len(aCols2)-1)
EndIf

//CSLL
nPosDed := Ascan(aCols2,{|x|x[1] == "011" .And. x[2]=="011004"})
If nValCsl > 0
	aCols2[nPosDed,4] := nValCsl
Else
	aDel(aCols2,nPosDed)
	aSize(aCols2,Len(aCols2)-1)
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Deducoes - Total das Subempreitadas                          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

nPos5 := Ascan(aCols2,{|x| STR0045$x[3]})
If (aCols2[nPos5,04] == 0)//Se nao existir valores para esta linha, excluo-a.
	aDel ( aCols2, nPos5 )
	aSize (aCols2, Len (aCols2)-1)
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Caso os aCOLS estejam vazios, preenche uma linha zerada ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

If Len(aCOLS1) == 0
	AADD(aCOLS1,Array(09))
	aCOLS1[1,1] := Space(05)
	aCOLS1[1,9] := .F.
	Aeval(aCOLS1[1],{|x,nI|aCOLS1[1,nI]:=0},2,7)
EndIf

If Len(aCOLS6) == 0
	AADD(aCOLS6,Array(13))
	aCOLS6[1,1] := Space(07)
	aCOLS6[1,2] := Space(TamSX3("A2_MUN")[2])
	aCOLS6[1,13] := .F.
	Aeval(aCOLS6[1],{|x,nI|aCOLS6[1,nI]:=0},3,10)
EndIf

Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcion   ³Mt954DedIS³ Autor ³ Mary C. Hergert       ³ Data ³ 19/12/06 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Verifica as deducoes de ISS Retido, verificando nos titulos ³±±
±±³          ³a receber se existe o titulo IS- (abatimento), indicando    ³±±
±±³          ³a retencao.                                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Valor retido                                                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³Nenhum                                                      ³±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³Mata954                                                     º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function Mt954DedIS(dDtIni,dDtFim,nDifIrf,nDifCsl,nDifPis,nDifCof)

Local aArea			:= GetArea()
Local nValor		:= 0
Local cAliasSE1		:= "SE1"
Local lQuery 		:= .F.
Local cDedIss 		:= GetNewPar("MV_DEDISS","1") // 1-Baixa do Titulo 2-Emissao do Titulo
Local cTipo			:= ""
Local nValIrf		:= 0
Local nValPis		:= 0
Local nValCof		:= 0
Local nValCsl		:= 0
Local lMV_1DUPREF 	:= If(upper(AllTrim(GetNewPar("MV_1DUPREF",""))) == "SF2->F2_SERIE",.T.,.F.)
Local cChave        := ""

#IFDEF TOP
	Local nX	:= 0
	aStruSE1  	:= {}
	cQuery 		:= ""
#ELSE
	cIndex    	:= ""
	cCondicao 	:= ""
#ENDIF

Default nDifIrf		:= 0
Default nDifCsl		:= 0
Default nDifPis		:= 0
Default nDifCof		:= 0

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Esta funcao retorna o alias __SE1, utilizado na pesquisa dos titulos de abatimento.³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
SomaAbat ("","","","R")

dbSelectArea("SE1")
dbSetOrder(1)
ProcRegua(LastRec())
#IFDEF TOP
	If TcSrvType()<>"AS/400"

		lQuery := .T.
		cAliasSE1 := "SE1ABAT"
		aStruSE1  := SE1->(dbStruct())

		cQuery := "SELECT E1_TIPO, E1_NATUREZ, E1_VALOR, E1_PREFIXO, E1_NUM, E1_PARCELA, E1_CLIENTE, E1_LOJA, E1_EMISSAO, E1_VENCREA, E1_ISS, E1_FATURA,E1_BAIXA,E1_SERIE "
		cQuery += "FROM "+RetSqlName("SE1")+" "
		cQuery += "WHERE E1_FILIAL='"+xFilial("SE1")+"' AND "
		If cDedIss=="2"
			cQuery += "E1_EMISSAO>='"+Dtos(dDtIni)+"' AND "
			cQuery += "E1_EMISSAO<='"+Dtos(dDtFim)+"' AND "	
		Else
			cQuery += "E1_BAIXA>='"+Dtos(dDtIni)+"' AND "
			cQuery += "E1_BAIXA<='"+Dtos(dDtFim)+"' AND "
		Endif
		cQuery += "D_E_L_E_T_ = ' ' "

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³O campo E1_SCORGP eh gravado  no MATA461 de acordo com o cliente/produto.                                                                                             ³
		//³Processo para criacao/alimentacao deste campo:                                                                                                                        ³
		//³- Criar os parametros MV_A1M996 e relacionar o campo da tabela SA1 do tipo caracter, combo (1=Sim;2=Nao) que identifica bem ou servico contratado por Orgaos Publicos.³
		//³- Criar os parametros MV_B1M996 e relacionar o campo da tabela SB1 do tipo caracter, combo (1=Sim;2=Nao) que identifica bem ou servico contratado por Orgaos Publicos.³
		//³- Criar o campo na tabela SE1 (E1_SCORGP) do tipo do tipo caracter, combo (1=Sim;2=Nao) que identifica bem ou servico contratado por Orgaos Publicos.                 ³
		//³- Após as criacoes, serah gravado automaticamente na tabela SE1 quando os dois campos (SA1 e SB1) estiverem definidos como "1=Sim".                                   ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If (SE1->(FieldPos ("E1_SCORGP"))>0)
			cQuery += "AND E1_SCORGP NOT IN ('1') "	//Somente os recebidos, ou seja, sem saldo.
		EndIf

		cQuery += "ORDER BY "+SqlOrder(SE1->(IndexKey()))
		cQuery := ChangeQuery(cQuery)
		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSE1)

		For nX := 1 To len(aStruSE1)
			If aStruSE1[nX][2] <> "C" .And. FieldPos(aStruSE1[nX][1])<>0
				TcSetField(cAliasSE1,aStruSE1[nX][1],aStruSE1[nX][2],aStruSE1[nX][3],aStruSE1[nX][4])
			EndIf
		Next nX

		dbSelectArea(cAliasSE1)
	Else
#ENDIF
		cIndex    := CriaTrab(NIL,.F.)
		cCondicao := 'E1_FILIAL=="'+xFilial("SE1")+'".And.'
		If cDedIss=="2"
			cCondicao += 'DTOS(E1_EMISSAO)>="'+DTOS(dDtIni)+'".And.DTOS(E1_EMISSAO)<="'+DTOS(dDtFim)+'" '
		Else
			cCondicao += 'DTOS(E1_BAIXA)>="'+DTOS(dDtIni)+'".And.DTOS(E1_BAIXA)<="'+DTOS(dDtFim)+'" '
		Endif
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³O campo E1_SCORGP eh gravado  no MATA461 de acordo com o cliente/produto.                                                                                             ³
		//³Processo para criacao/alimentacao deste campo:                                                                                                                        ³
		//³- Criar os parametros MV_A1M996 e relacionar o campo da tabela SA1 do tipo caracter, combo (1=Sim;2=Nao) que identifica bem ou servico contratado por Orgaos Publicos.³
		//³- Criar os parametros MV_B1M996 e relacionar o campo da tabela SB1 do tipo caracter, combo (1=Sim;2=Nao) que identifica bem ou servico contratado por Orgaos Publicos.³
		//³- Criar o campo na tabela SE1 (E1_SCORGP) do tipo do tipo caracter, combo (1=Sim;2=Nao) que identifica bem ou servico contratado por Orgaos Publicos.                 ³
		//³- Após as criacoes, serah gravado automaticamente na tabela SE1 quando os dois campos (SA1 e SB1) estiverem definidos como "1=Sim".                                   ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If (SE1->(FieldPos ("E1_SCORGP"))>0)
			cCondicao += '.And. E1_SCORGP<>"1" ' //Somente os recebidos, ou seja, sem saldo.
		EndIf
		IndRegua(cAliasSE1,cIndex,SE1->(IndexKey()),,cCondicao)
		nIndex := RetIndex("SE1")
		#IFNDEF TOP
			dbSetIndex(cIndex+OrdBagExt())
		#ENDIF
		dbSelectArea("SE1")
		dbSetOrder(nIndex+1)
		dbSelectArea(cAliasSE1)
		ProcRegua(LastRec())
		dbGoTop()
#IFDEF TOP
	Endif
#ENDIF

If SE1->(FieldPos("E1_SERIE")) == 0
	lMV_1DUPREF  := .T.	
EndIf

While (cAliasSE1)->(!Eof())
	If (cAliasSE1)->E1_FATURA <> "NOTFAT"

		aAreaSE1 := GetArea()

		//Abro SE1 sem filtro para localizacao dos titulos de Pis e Cofins
		dbSelectArea("__SE1")
		__SE1->(dbSetOrder(2))  //clie_Loja+pref+Num+Parc+tipo
		
		lAchouAbat := .F.
		
		If MsSeek(xFilial("SE1")+(cAliasSE1)->(E1_CLIENTE+E1_LOJA+E1_PREFIXO+E1_NUM+E1_PARCELA))
			// Faco esta verificacao.pois tenho que considerar os titulos de retencao caso os parametros 
			// estejam como .T.. Se tiver como .F. considero apenas os titulos de IS-
			
			cTipo := MVISABT + "/"
			
			If GetNewPar("MV_ISS_IRF",.F.)
				cTipo += MVIRABT + "/"
			Endif
			
			If GetNewPar("MV_ISS_PIS",.F.)
				cTipo += MVPIABT + "/"
			Endif
			
			If GetNewPar("MV_ISS_CSL",.F.)
				cTipo += MVCSABT + "/"
			Endif
			
			If GetNewPar("MV_ISS_COF",.F.)
				cTipo += MVCFABT + "/"
			Endif

			If !(cAliasSE1)->E1_TIPO$cTipo
				(cAliasSE1)->(dbSkip())
				Loop
			Endif
			
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Nao considerar nas deducoes as notas escrituradas como "Outros" no Livro ISS       ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If lMV_1DUPREF
//				cChave :=  (cAliasSE1)->E1_PREFIXO
				cChave :=  (cAliasSE1)->E1_SERIE
			Else
				cChave := AcertoChv((cAliasSE1)->(xFilial("SE1")+E1_PREFIXO+E1_NUM +E1_PARCELA))
				If Empty(cChave)
//					cChave :=  (cAliasSE1)->E1_PREFIXO
					cChave :=  (cAliasSE1)->E1_SERIE
				EndIf
			EndIf
			
			SF3->(dbSetOrder(5))
			SF3->(MsSeek(xFilial("SF3")+(cAliasSE1)->(cChave+E1_NUM+E1_CLIENTE+E1_LOJA)))
			Do While !SF3->(Eof()) .And. xFilial("SF3") == SF3->F3_FILIAL .And.;
						SF3->(F3_SERIE+F3_NFISCAL+F3_CLIEFOR+F3_LOJA)==(cAliasSE1)->(cChave+E1_NUM+E1_CLIENTE+E1_LOJA)

				If SF3->F3_OUTRICM == 0 .And. SF3->F3_ISENICM == 0 .And. SF3->F3_TIPO == "S"

					//If (cAliasSE1)->E1_TIPO == MVISABT
						nValor += (cAliasSE1)->E1_VALOR
					//EndIf  

					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³ Verifica tributos federais para abatimento da base - LC 185 ³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If GetNewPar("MV_ISS_IRF",.F.) .And. (cAliasSE1)->E1_TIPO == MVIRABT
						nValIrf := (cAliasSE1)->E1_VALOR
						nBaseISS:= SF3->F3_BASEICM - nValIrf
						nDifIrf += SF3->F3_VALICM - ((nBaseISS * SF3->F3_ALIQICM) / 100)
					EndIf
					If GetNewPar("MV_ISS_CSL",.F.) .And. (cAliasSE1)->E1_TIPO == MVCSABT
						nValCsl := (cAliasSE1)->E1_VALOR
						nBaseISS:= SF3->F3_BASEICM - nValCsl
						nDifCsl += SF3->F3_VALICM - ((nBaseISS * SF3->F3_ALIQICM) / 100)
					EndIf
					If GetNewPar("MV_ISS_PIS",.F.) .And. (cAliasSE1)->E1_TIPO == MVPIABT
						nValPis := (cAliasSE1)->E1_VALOR
						nBaseISS:= SF3->F3_BASEICM - nValPis
						nDifPis += SF3->F3_VALICM - ((nBaseISS * SF3->F3_ALIQICM) / 100)
					EndIf
					If GetNewPar("MV_ISS_COF",.F.) .And. (cAliasSE1)->E1_TIPO == MVCFABT
						nValCof := (cAliasSE1)->E1_VALOR
						nBaseISS:= SF3->F3_BASEICM - nValCof
						nDifCof += SF3->F3_VALICM - ((nBaseISS * SF3->F3_ALIQICM) / 100)
					EndIf
				Endif

				SF3->(DbSkip())
			EndDo
		EndIf
		RestArea(aAreaSE1)
	EndIf
	(cAliasSE1)->(DbSkip())
EndDo

If lQuery
	dbSelectArea(cAliasSE1)
	dbCloseArea()
Else
	dbSelectArea("SE1")
	RetIndex("SE1")
	Set Filter to
	Ferase(cIndex+OrdBagExt())
EndIf

RestArea(aArea)

Return (Round(nValor,2))
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±ºFuncao    ³a954Ret   ºAutor  ³Natalia ANtonucci      º Data ³ 15/07/11 º±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±ºDesc.     ³ Função utilizada para obter o valor do ISS Retido          º±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³aRet                                                        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ lNotas,cNrLivro,mv_par01,mv_par02						  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function a954Ret(lNotas,cNrLivro,mv_par01,mv_par02)

Local aRet 		:= {}
Local nTotal 	:= 0
Local cIndex    := ""
Local cFiltro 	:= ""
Local cAliasSFT := "SFT"
Local dDatade 	:= CTOD("  /  /   ")
Local dDataate 	:= CTOD("  /  /   ")
Local cCampos 	:= ""

If lNotas
	dDatade :=  MV_PAR01
	dDataate := MV_PAR02
else
	dDatade :=  ctod("01/"+Alltrim(str(mv_par01))+"/"+Alltrim(str(mv_par02)))
	dDataate := LastDay(dDatade,0)
EndIf

	DbSelectArea (cAliasSFT)
	(cAliasSFT)->(DbSetOrder (2))
	#IFDEF TOP
		If (TcSrvType ()<>"AS/400")
			cAliasSFT := GetNextAlias()

			cFiltro := "%"

			If (cNrLivro<>"*")
				cFiltro += " SFT.FT_NRLIVRO = '" +%Exp:cNrLivro% +"' AND "
			EndiF
			cFiltro += "%"

			If SerieNfId("SFT",3,"FT_SERIE") == "FT_SDOC"
				cCampos := ", SFT.FT_SDOC"
			Endif

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Campos que serao adicionados a query somente se existirem na base³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If Empty(cCampos)
				cCampos := "%%"
			Else
				cCampos := "% " + cCampos + " %"
			Endif

			BeginSql Alias cAliasSFT

				COLUMN FT_ENTRADA AS DATE

				SELECT
					SFT.FT_SERIE,SFT.FT_NFISCAL,SFT.FT_CLIEFOR,SFT.FT_LOJA,SFT.FT_ENTRADA,SFT.FT_TIPOMOV,
					SFT.FT_CFOP,SFT.FT_ESPECIE,SFT.FT_TIPO,SFT.FT_DTCANC,SFT.FT_CLASFIS,SFT.FT_CFPS,SFT.FT_VALICM,
					SFT.FT_RECISS
					%Exp:cCampos%
				FROM
					%Table:SFT% SFT
				WHERE
					SFT.FT_FILIAL=%xFilial:SFT% AND
					SFT.FT_ENTRADA BETWEEN %Exp:DToS (dDataDe)% AND %Exp:DToS (dDataAte)% AND
					SFT.FT_TIPOMOV ='S'	AND
					SFT.FT_TIPO ='S'  AND
					SFT.FT_DTCANC = ' ' AND
					%Exp:cFiltro%
					SFT.%NotDel%
			EndSql
		Else
	#ENDIF
			cIndex	:= CriaTrab(NIL,.F.)
			cFiltro := 'FT_FILIAL=="'+xFilial ("SFT")+'".And.'
			cFiltro += 'DToS (FT_ENTRADA)>="'+DToS (dDataDe)+'".And.DToS (FT_ENTRADA)<="'+DToS (dDataAte)+'" '
			cFiltro += '.And. FT_TIPOMOV ="S" .And. FT_TIPO=="S" .And. FT_DTCANC = " " '
			If (cNrLivro<>"*")
				cFiltro	+=	'.And.FT_NRLIVRO ="'+cNrLivro+'" '
			EndIf
			IndRegua (cAliasSFT, cIndex, SFT->(IndexKey ()),, cFiltro)
			nIndex := RetIndex(cAliasSFT)
			#IFNDEF TOP
				DbSetIndex (cIndex+OrdBagExt ())
			#ENDIF
			DbSelectArea (cAliasSFT)
			DbSetOrder (nIndex+1)
	#IFDEF TOP
		Endif
	#ENDIF

While !(cAliasSFT)->(Eof ())

	If (cAliasSFT)->FT_RECISS <> "1"
		(cAliasSFT)->(dbskip())
		Loop
	EndIf

	If lNotas
		AADD(aRet,{(cAliasSFT)->FT_ESPECIE,SerieNfId(cAliasSFT,2,"FT_SERIE"),(cAliasSFT)->FT_NFISCAL,(cAliasSFT)->FT_CFOP,(cAliasSFT)->FT_CLASFIS,(cAliasSFT)->FT_VALICM}) 
	Else
		nTotal += (cAliasSFT)->FT_VALICM
	Endif

	(cAliasSFT)->(dbskip())

EndDo

If !lNotas
	AAdd(aRet,nTotal)
Endif
(cAliasSFT)->(DbCloseArea())
Return (aRet)
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcion   ³FCodMun   ³ Autor ³ Natalia Antonucii		³ Data ³ 20/07211 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Municipios liberados         				              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³lRet	                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³cCodMun (Codigo do Municipio valido)                        ³±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ SIGAFIS                                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function FCodMun(cCodMun)
//Inserir em cCodVal os municipios liberados
Local cCodVal := GetNewPar("MV_ISSAJU","")
Local lRet := .F.

Default cCodMun := ""

If cCodMun $ cCodVal
	lRet := .T.
Endif

Return(lRet)
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³a954DbC6Ok ³Autor  ³ Vitor Felipe         ³ Data ³10/08/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Desc.     ³Detalhe o valor das Deducoes de Materias e Servicos.        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function a954DbC6Ok()

Local lRet		:= .T.
Local cCodMun	:= ""
Local cEstMun	:= ""
Local cAliasCE2	:= "CE2"
Local aDatas	:= DetDatas(mv_par01,mv_par02,mv_par04,mv_par05)
Local dDataIni	:= FirstDay(aDatas[1])
Local dDataFim	:= LastDay(aDatas[2])
Local lIssxMun	:= SuperGetMv("MV_ISSXMUN",.F.,.F.)
Local aBrowse	:= {}
Local aHeadBrow := {STR0073,STR0074,STR0075,STR0076,STR0077,STR0078,STR0079,STR0080,STR0081,STR0082,STR0083}
Local oBrowse
Local nX		:= 0

If lIssxMun
	dbSelectArea("CC2")
	dbSetOrder(2)
	If CC2->(msSeek(xFilial("CC2")+aCols[N][1]))
		cCodMun := CC2->CC2_CODMUN
		cEstMun	:= CC2->CC2_EST
	EndIf
	
	dbSelectArea("CE2")
	dbSetOrder(1)
	
	dbSelectArea("SB1")
	dbSetOrder(1)
	
	#IFDEF TOP
		If (TcSrvType ()<>"AS/400")
			cAliasCE2 := GetNextAlias()

			BeginSql Alias cAliasCE2

				SELECT
					CE2.CE2_FILIAL,CE2.CE2_NUMPV,CE2.CE2_PRODPV,CE2.CE2_ITEMPV,CE2.CE2_PROJPV,CE2.CE2_EDTPV,CE2.CE2_TASKPV,CE2.CE2_DOCNF,
					CE2.CE2_SERINF,	CE2.CE2_FORNNF,CE2.CE2_LOJANF,CE2.CE2_CODNF,CE2.CE2_ITEMNF,CE2.CE2_ABTSER,CE2.CE2_ABTMAT,CE2.CE2_DTDIGT,
					CE2.CE2_MUNPRE,CE2.CE2_ESTPRE,SB1.B1_COD,SB1.B1_DESC
				FROM
					%Table:CE2% CE2
					LEFT JOIN %Table:SB1% SB1 ON(SB1.B1_FILIAL=%xFilial:SB1%  AND SB1.B1_COD=CE2.CE2_PRODPV AND SB1.%NotDel%)
				WHERE
					CE2.CE2_FILIAL=%xFilial:CE2% AND
					CE2.CE2_DTDIGT >= %Exp:dDataIni% AND
					CE2.CE2_DTDIGT <= %Exp:dDataFim% AND
					CE2.CE2_MUNPRE = %Exp:cCodMun% AND
					CE2.CE2_ESTPRE = %Exp:cEstMun% AND
					CE2.%NotDel%
			EndSql
		Else
	#ENDIF

	#IFDEF TOP
		Endif
	#ENDIF
	// Array com elementos do Browse
	While !(cAliasCE2)->(Eof ())
	    aAdd(aBrowse,{(cAliasCE2)->CE2_FILIAL,;
	    				(cAliasCE2)->CE2_PRODPV,;
	    				(cAliasCE2)->B1_DESC,;
	    				(cAliasCE2)->CE2_DOCNF,;
	    				(cAliasCE2)->CE2_SERINF,;
	    				(cAliasCE2)->CE2_ABTSER,;
	    				(cAliasCE2)->CE2_ABTMAT,;
	    				(cAliasCE2)->CE2_PROJPV,;
	    				(cAliasCE2)->CE2_EDTPV,;
	    				(cAliasCE2)->CE2_TASKPV,;
	    				STOD((cAliasCE2)->CE2_DTDIGT)})
		(cAliasCE2)->(dbSkip())	
	EndDo
	If Len(aBrowse) > 0
	    //Tela para Demonstrar Notas Fiscais.
	    DEFINE DIALOG oDlg TITLE STR0084 FROM 180,180 TO 800,1200 PIXEL //"Notas de Entrada Vinculadas"
	        // Cria Browse
	        oBrowse := TCBrowse():New(015,001,500,290,,aHeadBrow,{50,50,50},oDlg,,,,,{||},,,,,,,.F.,,.T.,,.F.,,, )
	        // Seta array para o browse.
	        oBrowse:SetArray(aBrowse)
	        // Adiciona Colunas.
		    oBrowse:AddColumn( TCColumn():New(STR0073,{ || aBrowse[oBrowse:nAt,1] },,,,"LEFT",,.F.,.T.,,,,.F.,) ) //"Filial"
	        oBrowse:AddColumn( TCColumn():New(STR0074,{ || aBrowse[oBrowse:nAt,2] },,,,"LEFT",,.F.,.T.,,,,.F.,) ) //"Cod. Produto"
	        oBrowse:AddColumn( TCColumn():New(STR0075,{ || aBrowse[oBrowse:nAt,3] },,,,"LEFT",,.F.,.T.,,,,.F.,) ) //"Desc. Produto"
	        oBrowse:AddColumn( TCColumn():New(STR0076,{ || aBrowse[oBrowse:nAt,4] },,,,"LEFT",,.F.,.T.,,,,.F.,) ) //"Nota Fiscal"
	        oBrowse:AddColumn( TCColumn():New(STR0077,{ || aBrowse[oBrowse:nAt,5] },"!!!",,,"LEFT",,.F.,.T.,,,,.F.,) ) //"Serie"
	        oBrowse:AddColumn( TCColumn():New(STR0078,{ || aBrowse[oBrowse:nAt,6] },"@e 999,999,999,999.99",,,"LEFT",,.F.,.T.,,,,.F.,) ) //"Abt. Serviços"
	        oBrowse:AddColumn( TCColumn():New(STR0079,{ || aBrowse[oBrowse:nAt,7] },"@e 999,999,999,999.99",,,"LEFT",,.F.,.T.,,,,.F.,) ) //"Abt. Materiais"
	        oBrowse:AddColumn( TCColumn():New(STR0080,{ || aBrowse[oBrowse:nAt,8] },,,,"LEFT",,.F.,.T.,,,,.F.,) ) //"Projeto"
	        oBrowse:AddColumn( TCColumn():New(STR0081,{ || aBrowse[oBrowse:nAt,9] },,,,"LEFT",,.F.,.T.,,,,.F.,) ) //"EDT"
	        oBrowse:AddColumn( TCColumn():New(STR0082,{ || aBrowse[oBrowse:nAt,10] },,,,"LEFT",,.F.,.T.,,,,.F.,) ) //"Tarefa"
	        oBrowse:AddColumn( TCColumn():New(STR0083,{ || aBrowse[oBrowse:nAt,11] },,,,"LEFT",,.F.,.T.,,,,.F.,) ) //"Dt. Digitação"
	
		ACTIVATE DIALOG oDlg CENTERED ON INIT EnchoiceBar(oDlg,{||oDlg:End()},{|| oDlg:End()})
	Else
		Alert(STR0085) //"Não foram encontrados Registros"
	EndIf

EndIf
CC2->(DbCloseArea())
CE2->(DbCloseArea())
SB1->(DbCloseArea())
Return(lRet)
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcion   ³AcertoChv ³ Autor ³ Rene Julian	        ³ Data ³ 19/12/06 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Retorna a Serie do Documento Principal pois o Prefixo foi   ³±±
±±³          ³modificado.												  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³String contendo FILIAL,PREFIXO,NUM,PARCELA                  ³±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³Mata954                                                     º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function AcertoChv(cChave)
Local aArea  := SE1->(GetArea())
Local cRet   := ""
Local nRecno := SE1->(Recno())

Default cChave := ""

If !Empty(cChave)
	SE1->(DbSetorder(1))
	SE1->(DbSeek(cChave))
	While !SE1->(Eof()) .And. xFilial("SE1") == SF3->F3_FILIAL .And.;
		cChave == SE1->(xFilial("SE1")+E1_PREFIXO+E1_NUM +E1_PARCELA )
		If !Empty(SE1->E1_SERIE)
			cRet  := SE1->E1_SERIE
			Exit
		EndIf
		SE1->(DbSkip())
	End
EndIf
RestArea(aArea)
SE1->(DbGoto(nRecno))

Return(cRet)
