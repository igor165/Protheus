#INCLUDE "PLSA300.ch"
#include "PROTHEUS.CH"
#include "PLSMGER.CH"
#include "COLORS.CH"
#include "TCBROWSE.CH"
#include "JPEG.CH"
                                                                                                                
#define K_Agenda  	1
#define K_Editar  	2
#define K_Cancel  	3
#define K_Remarca 	4
#define K_Marcar  	5
#define K_Encaixe 	6
#define K_Sair     7

Static aInd := {}
/*/
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇旼컴컴컴컴컫컴컴컴컴컫컴컴컴컫컴컴컴컴컴컴컴컴컴컴컴컫컴컴컴쩡컴컴컴컴커굇
굇쿑uncao     PLSA300  Autor  Geraldo Felix Junior   Data  18.12.01 낢
굇쳐컴컴컴컴컵컴컴컴컴컨컴컴컴컨컴컴컴컴컴컴컴컴컴컴컴컨컴컴컴좔컴컴컴컴캑굇
굇쿏escricao  Agenda Medica - Versao 8.11                               낢
굇읕컴컴컴컴컨컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸굇
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
/*/
Function PLSA300(cMatric, cNomUsr, cMatAnt, cTelUsr ,cAterna)
Local aArea		 := GetArea()	// Salva a area atual
PRIVATE lMultLoc  := .F.
PRIVATE inclui	  := .F.
PRIVATE Altera	  := .T.
PRIVATE lForcaUsr := .F.
PRIVATE lForcaPro := .F.
PRIVATE lForcado  := .F.
PRIVATE aAutFor   := {}
PRIVATE lMove	    := .F.
PRIVATE aRotina   := MenuDef()
PRIVATE lBBD_TIPPAC := BBD->(FieldPos("BBD_TIPPAC")) > 0
PRIVATE lBBD_ATERNA := BBD->(FieldPos("BBD_ATERNA")) > 0
PRIVATE lBBO_ATERNA := BBO->(FieldPos("BBO_ATERNA")) > 0
PRIVATE lBBD_DATCAN := BBD->(FieldPos("BBD_DATCAN")) > 0
DEFAULT cAterna   := "0"
/**/
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Verifica a criacao do registro para o usuario/operador logado...         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸

dbSelectarea("BBO")
BB0->(dbSetorder(01))
If ! BBO->(MsSeek(xFilial("BBO")+StrZero(Val(RetCodUsr()),6)))
   BBO->(RecLock("BBO",.T.))
   BBO->BBO_FILIAL := xFilial("BBO")
   BBO->BBO_CODUSR := StrZero(Val(RetCodUsr()),6)
   BBO->BBO_CODESP := "001"   
   BBO->BBO_CODINT := PLSINTPAD()                             
   BBO->BBO_DATA   := Date()
   BBO->(MsUnLock())
Else
   BBO->(RecLock("BBO",.F.))
   BBO->BBO_DATA := Date()
   
   If Empty(BBO->BBO_CODESP)
      BBO->BBO_CODESP := "001"
   Endif                     
   
	BBO->BBO_CODPAC 	:= CriaVar("BBO_CODPAC")
	BBO->BBO_NOME	    := CriaVar("BBO_NOME")
	BBO->BBO_TELEFO		:= CriaVar("BBO_TELEFO")
	BBO->BBO_MATANT		:= CriaVar("BBO_MATANT")
	BBO->BBO_NOMEMP		:= CriaVar("BBO_NOMEMP")
	BBO->BBO_USRFRC 	:= ''

	If lBBO_ATERNA//BBO->( FieldPos("BBO_ATERNA") ) > 0
	   BBO->BBO_ATERNA := "0"
	EndIf
		   
   If Empty(BBO->BBO_CODINT)
      BBO->BBO_CODINT := PLSINTPAD()
   Endif   
   BBO->(MsUnLock())
Endif

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Se nao existir, cria com dados default e caso existe copia para a memoria
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
BBO->(RegToMemory("BBO",.F.))

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Executa rotina que prepara ambiente para rodar a agenda medica...        
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
PLSA300Pre(M->BBO_CODINT,M->BBO_DATA,;
                                    M->BBO_CODESP,;
                                    M->BBO_DESMUN,M->BBO_ESTADO,;
                                    M->BBO_BAIRRO,M->BBO_CODPRO,;
                                    M->BBO_CODLOC,M->BBO_CODCRE, cMatric, cNomUsr, cMatAnt, cTelUsr ,cAterna)//,;M->BBO_SUBESP)
DbSelectArea("SA1")
RestArea(aArea)
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Fim da Rotina Principal...                                               
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
Return Nil
/*/
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇旼컴컴컴컴컫컴컴컴컴컴컴쩡컴컴컴쩡컴컴컴컴컴컴컴컴컴컫컴컴컴쩡컴컴컴컴커굇
굇쿑uncao     PLSA300PRE  Autor 쿒eraldo Felix Junior Data  20.12.01 낢
굇쳐컴컴컴컴컵컴컴컴컴컴컴좔컴컴컴좔컴컴컴컴컴컴컴컴컴컨컴컴컴좔컴컴컴컴캑굇
굇쿏escricao  A partir da rotina que recebe os parametros chama as      낢
굇           subs-rotinas necessarias para a montagem da agenda        낢
굇쳐컴컴컴컴컨컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴캑굇
굇쿒eraldo JR.         |      | Versao 8.11                             낢
굇읕컴컴컴컴컴컨컴컴컴컴좔컴컴컨컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸굇
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
/*/
Static Function PLSA300Pre(cCodInt,dData,cCodEsp,;
                    cDesMun,cEstado,cBairro,;
                    cCodPro,cLocal,cCodCre,cMatric,;
                    cNomUsr, cMatAnt, cTelUsr,cAterna)
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define variaveis locais...                                               
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
LOCAL cInd      := CriaTrab(nil,.F.)
LOCAL aRetorno  := {}

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta o dia...                                                           
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
LOCAL cAno		:= Alltrim(Str(Year( dData)))
LOCAL cDia		:= Alltrim(Str(Dow(  dData)))
LOCAL cMes		:= StrZero(Month(dData),2)
LOCAL cDiaMes	:= StrZero(Day(  dData),2) 
DEFAULT cAterna := "0"

PRIVATE cCadastro := STR0001 //"Agenda Medica"

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Executa rotina que monta area de trabalho e variaveis para utilizacao... 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
aRetorno := PLSA300Trb(cCodInt,dData,cCodEsp,;
                        cDesMun,cEstado,cBairro,;
                        cCodPro,cLocal,cCodCre,;
                        cInd,cCadastro)
If ! aRetorno[1]
   Return
Endif                             

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta a tela com resultado...                                            
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
PLSA300Src(aRetorno[2],aRetorno[3],aRetorno[4],dData,cCodEsp,;
		   cCodCre,cCodInt, cDia, cMes, cAno, cDiaMes, cMatric,;
		   cNomUsr, cMatAnt, cTelUsr,cAterna)
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Atualiza as configuracoes do usuario atual...                            
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
BBO->(PLUPTENC("BBO",K_Alterar))
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Fim da rotina...                                                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
Return
/*/
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇旼컴컴컴컴컫컴컴컴컴컴컴쩡컴컴컴쩡컴컴컴컴컴컴컴컴컴컫컴컴컴쩡컴컴컴컴커굇
굇쿑uncao     PLSA300TRB  Autor 쿒eraldo Felix Junior Data  18.12.01 낢
굇쳐컴컴컴컴컵컴컴컴컴컴컴좔컴컴컴좔컴컴컴컴컴컴컴컴컴컨컴컴컴좔컴컴컴컴캑굇
굇쿏escricao  Monta areas de trabalho e variaveis para ser usado pela   낢
굇           rotina generica de visualizacao da agenda disponivel      낢
굇읕컴컴컴컴컨컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸굇
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
/*/
Static Function PLSA300Trb(cCodInt,dData,cCodEsp,;
                    cDesMun,cEstado,cBairro,;
                    cCodPro,cLocal,cCodCre,;
                    cInd,cCadastro)
                    
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define variaveis...                                                      
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
LOCAL cSQL     	
LOCAL cBB7Name 	:= BB7->(RetSQLName("BB7"))
LOCAL cBAUName 	:= BAU->(RetSQLName("BAU"))
LOCAL cBA0Name 	:= BA0->(RetSQLName("BA0"))
LOCAL cBB8Name 	:= BB8->(RetSQLName("BB8"))
LOCAL cBAQName 	:= BAQ->(RetSQLName("BAQ"))
LOCAL cBAXName 	:= BAX->(RetSQLName("BAX"))
LOCAL cBBIName 	:= BBI->(RetSQLName("BBI"))
LOCAL lCodPro  	:= !Empty(cCodPro)                                           
LOCAL aColunas 	:= {}
LOCAL cDbTipo  	:= AllTrim(TCGetDB())
LOCAL lEof	   	:= .F.   
LOCAL nCnt 		:= 1
LOCAL cAno		:= Alltrim(Str(Year( dData)))
LOCAL cDia		:= Alltrim(Str(Dow(  dData)))
LOCAL cMes		:= StrZero(Month(dData),2)
LOCAL cDiaMes	:= StrZero(Day(  dData),2)

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define query...                                                          
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL := "SELECT "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Campos do BB7 - Tabela principal...                                      
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BB7_FILIAL, BB7_CODIGO, BB7_HORENT, BB7_HORSAI, BB7_EXCINI, BB7_EXCFIN, BB7_CODESP,BB7_INTERV,"
cSQL += "BB7_CODINT, BB7_CODLOC, BB7_ANO, BB7_MES, BB7_DIA, BB7_DIAMES, BB7_PLTINI, BB7_PLTFIN, BB7_OBSDIA,"
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Relaciona nome do prestador/medico...                                    
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BAU_FILIAL, BAU_CODIGO, BAU_LEGEND, BAU_NOME, "+cBAUName+".R_E_C_N_O_ AS REGBAU, "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Relaciona Operadora  ...                                                 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BA0_FILIAL, BA0_CODIDE, BA0_CODINT, BA0_NOMINT, "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Relaciona localidade...                                                  
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BB8_FILIAL, BB8_CODINT, BB8_CODLOC, BB8_LOCAL, BB8_DESLOC, BB8_TMPCON, "
cSQL += "BB8_END, BB8_NR_END, BB8_MUN, BB8_BAIRRO, BB8_TEL, "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Relaciona especialidade...                                               
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BAQ_FILIAL, BAQ_CODESP, BAQ_DESCRI, "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Relaciona especialidade do credenciado...                                
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BAX_DATINC, BAX_DATBLO "
cSQL += "FROM "
cSQL += cBB7Name+", "
cSQL += cBAUName+", "
cSQL += cBA0Name+", "
cSQL += cBB8Name+", "
cSQL += cBAQName+", "

If lCodPro
   cSQL += cBAXName+", "
   cSQL += cBBIName+" WHERE "
Else
   cSQL += cBAXName+" WHERE "   
Endif   

cSQL += cBB7Name+".D_E_L_E_T_ = ' ' AND BB7_FILIAL = '"+xFilial("BB7")+"' AND "
cSQL += cBAUName+".D_E_L_E_T_ = ' ' AND BAU_FILIAL = '"+xFilial("BAU")+"' AND "
cSQL += cBA0Name+".D_E_L_E_T_ = ' ' AND BA0_FILIAL = '"+xFilial("BA0")+"' AND "
cSQL += cBB8Name+".D_E_L_E_T_ = ' ' AND BB8_FILIAL = '"+xFilial("BB8")+"' AND "
cSQL += cBAQName+".D_E_L_E_T_ = ' ' AND BAQ_FILIAL = '"+xFilial("BAQ")+"' AND "
cSQL += cBAXName+".D_E_L_E_T_ = ' ' AND BAX_FILIAL = '"+xFilial("BAX")+"' AND "
If lCodPro
   cSQL += cBBIName+".D_E_L_E_T_ = ' ' AND BBI_FILIAL = '"+xFilial("BBI")+"' AND "
Endif   
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Where relacao BB7 X Credenciado (BAU)...                                 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BAU_CODIGO = BB7_CODIGO AND "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Where relacao BB7 X Operadora   (BA0)...                                 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BA0_CODIDE+BA0_CODINT = BB7_CODINT AND "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Where relacao BB7 X Local Atend. (BB8)...                                
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BB8_CODIGO = BB7_CODIGO AND "
cSQL += "BB8_CODINT = BB7_CODINT AND "
cSQL += "BB8_CODLOC = BB7_CODLOC AND "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Where relacao BB7 X Especialidade (BAQ)...                               
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BAQ_CODESP = BB7_CODESP AND "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Where relacao BB7 X Especialidade do credenciado (BAX)...                
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BAX_CODIGO = BAU_CODIGO AND "
cSQL += "BAX_CODESP = BB7_CODESP AND "
cSQL += "BAX_DATINC <= '"+dtos(dData)+"'AND "
If cDbTipo == "ORACLE"
	cSQL += "BAX_DATBLO = '        ' AND "                          
Else
	cSQL += "BAX_DATBLO = '' AND "                          
Endif
cSQL += "BAX_CODINT = BB7_CODINT AND "
cSQL += "BAX_CODLOC = BB7_CODLOC AND "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta where do arquivo principal BB7...                                  
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BB7_CODINT = '"+cCodInt+"' AND "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Trata dia pedido...                                                      
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BB7_DIA    = '"+cDia+"' AND "
cSQL += "BB7_MES    = '"+cMes+"' AND "
cSQL += "BB7_ANO    = '"+cAno+"' AND "
cSQL += "BB7_DIAMES = '"+cDiaMes+"' AND "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Trata localidade...                                                      
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If ! Empty(cLocal)
   cSQL += "BB8_LOCAL = '"+AllTrim(cLocal)+"' AND "
Endif   
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Trata municipio....                                                      
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If ! Empty(cDesMun)
   cSQL += "BB8_MUN = '"+AllTrim(cDesMun)+"' AND "
Endif   
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Trata bairro...                                                          
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If ! Empty(cBairro)
   cSQL += "BB8_BAIRRO = '"+AllTrim(cBairro)+"' AND "
Endif   
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Trata estado...                                                          
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If ! Empty(cEstado)
   cSQL += "BB8_EST = '"+AllTrim(cEstado)+"' AND "
Endif   
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Trata codigo do credenciado...                                           
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If ! Empty(cCodCre)
   cSQL += "BB7_CODIGO = '"+AllTrim(cCodCre)+"' AND "
Endif   
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Trata somente credenciados que possuem o produto informado...            
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If lCodPro
   cSQL += "BBI_CODIGO = BB7_CODIGO AND "
   cSQL += "BBI_CODPRO = '"+cCodPro+"' AND "
Endif   
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Trata somente codigo da especialidade informada...                       
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If ! Empty(cCodEsp)
   cSQL += "BB7_CODESP = '"+cCodEsp+"' AND "
Endif                                 

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Finaliza construcao da query...                                          
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL := Subs(cSQL,1,Len(cSQL)-4)
cSQL += "ORDER BY "+PlsSQLOrd(BB7->(IndexKey()))
PLSQuery(cSQL,"Trba300")

aInd := {}                 
Trba300->( dbEval({|| Aadd(aInd, {	BB7_FILIAL,;	// 01
									BB7_CODIGO,;	// 02
									BB7_HORENT,;	// 03
									BB7_HORSAI,;	// 04
									BB7_EXCINI,;	// 05
									BB7_EXCFIN,;	// 06
									BB7_CODESP,;	// 07
									BB7_INTERV,;	// 08
									BB7_CODINT,;	// 09
									BB7_CODLOC,;	// 10
									BB7_ANO,;		// 11
									BB7_MES,;		// 12
									BB7_DIA,;		// 13
									BB7_DIAMES,;	// 14
									BB7_PLTINI,;	// 15
									BB7_PLTFIN,;	// 16
									BB7_OBSDIA,;	// 17
									BAU_FILIAL,;	// 18
									BAU_CODIGO,;	// 19
									BAU_LEGEND,;	// 20
									BAU_NOME,;		// 21
									REGBAU,;		// 22
									BA0_FILIAL,;	// 23
									BA0_CODIDE,;	// 24
									BA0_CODINT,;	// 25
									BA0_NOMINT,;	// 26
									BB8_FILIAL,;	// 27
									BB8_CODINT,;	// 28
									BB8_CODLOC,;	// 29
									BB8_LOCAL,;		// 30
									BB8_DESLOC,;	// 31
									BB8_TMPCON,;	// 32
									BB8_END,;		// 33
									BB8_NR_END,;	// 34
									BB8_MUN,;		// 35
									BB8_BAIRRO,;	// 36
									BB8_TEL,;		// 37
									BAQ_FILIAL,;	// 38
									BAQ_CODESP,;	// 39
									BAQ_DESCRI,;	// 40
									BAX_DATINC,;	// 41
									BAX_DATBLO})}))	// 42
								
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta todas as localidades existentes...                                 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
For nCnt := 1 To Len(aInd)
	If ( Ascan(aColunas, {|x|	x[1] == aInd[nCnt][30] .and.;
		 						x[2] == aInd[nCnt][31] .and.;
								x[3] == aInd[nCnt][33] .and.;
								x[4] == aInd[nCnt][34] .and.;
								x[5] == aInd[nCnt][35] .and.;
								x[6] == aInd[nCnt][36] .and.;
								x[7] == aInd[nCnt][37] }) ) == 0
	
		aadd(aColunas,{	aInd[nCnt][30],;
						aInd[nCnt][31],;
						aInd[nCnt][33],;
						aInd[nCnt][34],;
						aInd[nCnt][35],;
						aInd[nCnt][36],;
						aInd[nCnt][37]})
	Endif
Next

DbSelectArea("BA1")
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Caso nao exista pelo menos uma coluna eu incluo uma na mao...            
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If Len(aColunas) == 0
	aadd(aColunas,{"","","","","","",""})
	lEof := .T.	
Elseif Len(aColunas) > 1
	//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
	// Ativa tratamento de multiplos locais de atendimento.                     
	//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
	lMultLoc := .T.
Endif                
Trba300->( dbCloseArea() )

Return({.T.,aColunas,cCadastro,cInd, lEof})

/*/
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇旼컴컴컴컴컫컴컴컴컴컴컴쩡컴컴컴쩡컴컴컴컴컴컴컴컴컴컫컴컴컴쩡컴컴컴컴커굇
굇쿑uncao     PLSA300SRC  Autor 쿒eraldo Felix Junior Data  18.12.01 낢
굇쳐컴컴컴컴컵컴컴컴컴컴컴좔컴컴컴좔컴컴컴컴컴컴컴컴컴컨컴컴컴좔컴컴컴컴캑굇
굇쿏escricao  Monta a tela de acordo com os parametros informados       낢
굇읕컴컴컴컴컨컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸굇
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
/*/
Static Function PLSA300Src(aColunas,cCadastro,cInd,dData,cCodEsp,cCodCre,cCodInt,cDia, cMes, cAno, cDiaMes,cMatric, cNomUsr, cMatAnt, cTelUsr,cAterna)
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define variaveis de tela...                                              
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
LOCAL cHorSel   := ""                     
LOCAL cDesEsp	:= ""
LOCAL cMedico	:= ""
LOCAL nDsPer    := GetNewPar("MV_PLDSCAG",30)//Dias para agendamento de consultas mesma especial
LOCAL cCodPro	:= GetNewPar("MV_PLSCDCO","0110101012")//Codigo padrao da consulta Agenda Medica
LOCAL nTime     := GetNewPar("MV_PLSTAGE",60)//Tempo para agendar uma consulta
LOCAL aDados    := {}
LOCAL aOcupacao := {}
LOCAL aItems    := {}
LOCAL aMedRec   := {}    
LOCAL aMedHor   := {}
LOCAL aRet		:= {}
LOCAL aCampos	:= {}
LOCAL aFields	:= {}
LOCAL aButtons	:= {}
LOCAL aListaUsr := { {"","","",0,.T.,"","",""} }

LOCAL oBrowse
LOCAL oDlgPes
LOCAL oCol        
LOCAL oBot01
LOCAL oBot02
LOCAL oBot04
LOCAL oSay
LOCAL oSayHor
LOCAL oGrupo
LOCAL oListLoc       
LOCAL oListMed
LOCAL oFont01 
LOCAL oGrpHo
LOCAL oGrpMe
LOCAL oListaUsr
LOCAL oTimerBrw
LOCAL oCorLiv   := CLR_BLACK
LOCAL oCorOcu   := CLR_HRED 
LOCAL lMens		:= .F.
LOCAL bPesquisa := { || a := PLSA300Pes(), If(a[3],(BBD->(DbGoTo(a[4])), ;
                         M->BBO_DATA   := BBD->BBD_DATA, ;
                         M->BBO_DIASEM := CriaVar("BBO_DIASEM"),;
                         M->BBO_CODLOC := BBD->BBD_LOCAL,;
                         M->BBO_LOCAL  := CriaVar("BBO_LOCAL"),;
                         M->BBO_CODESP := BBD->BBD_CODESP,;      
                         M->BBO_DESESP := Posicione("BAQ",1,xFILIAL("BAQ")+BBD->BBD_CODINT+M->BBO_CODESP,"BAQ_DESCRI"),;
                         M->BBO_CODCRE := BBD->BBD_CODIGO,;
                         M->BBO_NOMCRE := Posicione("BAU",1,xFilial("BAU")+M->BBO_CODCRE,"BAU_NOME"),;
                         M->BBO_CODINT := BBD->BBD_CODINT,;
                         oHorarios:nAt := 1,;
                         Eval(bVetAge),;
						 oEnc:oBox:Refresh(),;
                         Eval(bFiltro),;
                         nPos := AsCan(aHorAge,{|x| StrTran(x[2],":","") = StrTran(a[2],":","")}),;
                         cHorSel := a[2],;
                         Iif(nPos > 0, oHorarios:nAt := nPos, NIL),;
                         oHorarios:Refresh(), oHorarios:SetFocus() ),oHorarios:SetFocus()) }        

LOCAL bClick    := { || Pls300DisableKeys(),;           
						lRet := PLSA300Sel(oBrowse,oListMed,aColunas,aDados,aOcupacao,;	
                        					 dData,cCodEsp,cDesEsp,cCodInt,cInd,aMedRec,cPictPad,oDlgPes,;
					                         aItems,nOpcao,nDsPer,oListLoc:nAt, aMedHor,, aHorage, oHorarios,;
					                         bVetAge, cCodPro,oListLoc:aArray[oListLoc:nAt][1]), ;  
					                         oHorarios:SetFocus(),;
	                     Pls300EnableKeys(oListLoc, oEnc, bFiltro, nDsPes, dData, aListaUsr,;
                                          nOpcao, oDlgPes, bClick, oHorarios, bVetAge, oBrowse,cCodEsp,oListaUsr,nDsPer) }
                                    
LOCAL bMontVet  := { || PLSA300VET(aColunas,cInd,aDados,aOcupacao,aMedHor,M->BBO_DATA,M->BBO_CODINT,oListLoc,cDia,cDiaMes,cMes,cAno,oListMed) }
LOCAL bVetAge	:= { || cCodEsp :=M->BBO_CODESP,PLSA300Age(aColunas,cCodInt,{},dData,oListLoc,cCodEsp,cDia,cDiaMes,cMes,cAno)}
LOCAL bMonObj   := { || MsBrGetDbase():New( 045, 204, 045, 205,,,, oDlgPes,,,,,,,,,,,, .F.,, .T.,, .F., ) }
LOCAL bBrwCol   := { || x:=''}
LOCAL bChange   := { || x:= ''}
LOCAL cPictPad  := "@R !!:!!"
LOCAL nCor		:= 1
Local aSize 	:= MsAdvSize()
Local aObjects 	:= {}       
Local aObjects2	:= {}
Local aObjects3	:= {}
Local aObjects4	:= {}
Local aObjects5	:= {}
Local aObjects6	:= {}
Local aInfo 	:= {}
Local aInfo2 	:= {}
Local aInfo3 	:= {} 
Local aInfo4 	:= {}
Local aInfo5 	:= {}
Local aInfo6 	:= {}
Local aPosObj 	
Local aPosObj2	
Local oPanel
Local oPainelEchoice
Local nHRes		:=	oMainWnd:nClientWidth	// Resolucao horizontal do monitor  
Local nVRes  	:=	oMainWnd:nClientHeight //Resolucao vertial do monitor
LOCAL nLinI     := 8
LOCAL nColI     := 5
LOCAL nLinF     := -8
LOCAL nColF     := -5
LOCAL lR5     	:= GetRpoRelease("R5") //Indica se o release e 11.5
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define variaveis...                                                      
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
PRIVATE cCombo	  	:= ""
PRIVATE cComboEsp   := ""
PRIVATE nDsPes    	:= GetNewPar("MV_PLDSPES",60)//Dias na pesquisa da proxima data de agenda medica 
PRIVATE n         	:= 1

PRIVATE aTela     	:= {}
PRIVATE aGets     	:= {}
PRIVATE aCols     	:= {}
PRIVATE aHeader   	:= {}
PRIVATE aVetMar   	:= {}
PRIVATE aHorAge	  	:= {}
PRIVATE aCombo 		:= {}
PRIVATE aMedDis		:= {}

PRIVATE lRefresh  	:= .F.
PRIVATE lMarcar   	:= .T.
PRIVATE lFocoBrw	:= .F.
PRIVATE lEncaixe	:= .F.
PRIVATE lByPass		:= .T.
PRIVATE nOpcao 		:= 0
PRIVATE oSinal
PRIVATE oEnc
PRIVATE oSay1
PRIVATE oSay2
PRIVATE oSay3
PRIVATE oSay4
PRIVATE oSay5
PRIVATE oSayMed
PRIVATE bFiltro		:= { || cCodInt	:= M->BBO_CODINT,;
							dData 	:= M->BBO_DATA,;
							PLSA300Ajc(cCodInt,dData,M->BBO_CODESP,M->BBO_DESMUN,M->BBO_ESTADO,M->BBO_BAIRRO,;
			         					M->BBO_CODPRO,M->BBO_CODLOC,M->BBO_CODCRE,cInd,cCadastro,aColunas,;
			                         	aDados,aOcupacao,oBrowse,oDlgPes,bChange,bClick,;
            			             	oCorOcu,oCorLiv,aMedHor,bBrwCol,bMontVet,oListMed,;
			                         	aItems, oListLoc, bVetAge, oHorarios, @cMedico)}                         
                         
PRIVATE bSeekBB7	:= { |cCodInt,cCodLoc,cCodEsp,cDia, cMes, cAno, cDiaMes| BB7->(DbSetOrder(4)), BB7->(MsSeek(xFilial("BB7")+;
                         	cCodInt+cAno+cMes+cCodLoc+cCodEsp+Space(03)+cDiaMes)) }                           
PRIVATE bAtuFil   	:= {|a,b| If(Eval(bFiltro),.T.,.T.) }
PRIVATE oBmpBol
DEFAULT cAterna     := "0"
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define fonte para mensagem...                                            
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸              
DEFINE FONT oFont01 NAME "Arial" SIZE 0,-12 BOLD
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Busca a descricao da especialidade...                                    
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cDesEsp  := Posicione("BAQ",1,xFilial("BAQ")+cCodInt+cCodEsp,"BAQ_DESCRI") 
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define os campos dos parametros...                                       
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
Aadd(aCampos, "BBO_DATA")
Aadd(aCampos, "BBO_DIASEM")
Aadd(aCampos, "BBO_CODESP")
Aadd(aCampos, "BBO_DESESP")
Aadd(aCampos, "BBO_CODLOC")
Aadd(aCampos, "BBO_LOCAL")
Aadd(aCampos, "BBO_CODCRE")
Aadd(aCampos, "BBO_NOMCRE")
Aadd(aCampos, "BBO_CODINT")
Aadd(aCampos, "BBO_DESINT")         
Aadd(aCampos, "BBO_USRFRC")
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
// Lado esquerdo
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
aObjects := {}

AAdd( aObjects, { nVRes*0.30, 050, .F. , .F.} ) //box1
AAdd( aObjects, { nVRes*0.30, 030, .F. , .F.} ) //espaco para botoes 
AAdd( aObjects, { nVRes*0.30, 040, .F. , .F.} ) //box2
AAdd( aObjects, { nVRes*0.30, 040, .F. , .T.} ) //box1


				//LI    //CI      //LF     //CF
aInfo 	 := { aSize[1],aSize[2],aSize[3],aSize[4], 3, 3 }
aPosObj1 := MsObjSize( aInfo, aObjects,.F.,.F. )

   
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
// lado direito
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
aObjects2 := {}
AAdd( aObjects2, { nVRes, 025, .t., .f.} ) //box rda
AAdd( aObjects2, { nVRes, 100, .t., .t.} ) //box data

				//LI    	  //CI     //LF      //CF
aInfo  	 := { aPosObj1[1][4],aSize[2],aSize[3],aSize[4], 3, 3 }
aPosObj2 := MsObjSize( aInfo, aObjects2, .f., .f. )
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define dialogo da pesquisa...                                            
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
DEFINE MSDIALOG oDlgPes TITLE cCadastro FROM aSize[7],0 To aSize[6],aSize[5] of oMainWnd Pixel  

@ aPosObj1[1][1],aPosObj1[1][2] GROUP oGrpLoc TO aPosObj1[1][3]+25, aPosObj1[1][4] PIXEL OF oDlgPes LABEL STR0002  COLOR CLR_HBLUE, CLR_HRED //"Locais de Atendimento - < CTRL + A >"

nColI := 3 
nLinF := -10
nColF := iIf(lR5,-15,-25)

oListLoc := TcBrowse():New( aPosObj1[1][1]+8, aPosObj1[1][2]+2, aPosObj1[1][4]-8, aPosObj1[1][3]-24,,,, oDlgPes,,,,,,,,,,,, .F.,, .T.,, .F., )

nColI := 5 
nLinF := -15  
nColF := -5

	oListLoc:AddColumn(TcColumn():New(STR0003,nil,; //"Local"
	nil,nil,nil,nil,020,.F.,.F.,nil,nil,nil,.F.,nil))
	oListLoc:ACOLUMNS[1]:BDATA     := { || aColunas[oListLoc:nAt,1] }
	oListLoc:AddColumn(TcColumn():New(STR0004,nil,; //"Descricao"
	nil,nil,nil,nil,070,.F.,.F.,nil,nil,nil,.F.,nil))
	oListLoc:ACOLUMNS[2]:BDATA     := { || aColunas[oListLoc:nAt,2] }
	oListLoc:AddColumn(TcColumn():New(STR0005,nil,; //"Telefone"
	nil,nil,nil,nil,070,.F.,.F.,nil,nil,nil,.F.,nil))
	oListLoc:ACOLUMNS[3]:BDATA     := { || Alltrim(aColunas[oListLoc:nAt,7])}
	oListLoc:AddColumn(TcColumn():New(STR0006,nil,; //"Endereco"
	nil,nil,nil,nil,100,.F.,.F.,nil,nil,nil,.F.,nil))
	oListLoc:ACOLUMNS[4]:BDATA     := { || Alltrim(aColunas[oListLoc:nAt,3])+", "+Alltrim(aColunas[oListLoc:nAt,4]) }
	oListLoc:AddColumn(TcColumn():New(STR0007,nil,; //"Municipio"
	nil,nil,nil,nil,060,.F.,.F.,nil,nil,nil,.F.,nil))
	oListLoc:ACOLUMNS[5]:BDATA     := { || Alltrim(aColunas[oListLoc:nAt,5])}
	oListLoc:AddColumn(TcColumn():New(STR0008,nil,; //"Bairro"
	nil,nil,nil,nil,040,.F.,.F.,nil,nil,nil,.F.,nil))
	oListLoc:ACOLUMNS[6]:BDATA     := { || Alltrim(aColunas[oListLoc:nAt,6])}
	
	oListLoc:BLDBLCLICK := {|| Eval(bMontVet),Eval(bAtuFil),oHorarios:SetFocus()}
	
	oListLoc:SetArray(aColunas)

//Grupo para os botoes <<,<,>,>>
@ aPosObj1[2,1]+25,aPosObj1[2,2] GROUP oGrupo TO aPosObj1[2,3]+15,aPosObj1[2,4] PIXEL OF oDlgPes LABEL "" COLOR CLR_HBLUE, CLR_HRED

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Ativa o combobox com a lista de medicos                                  
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
@ aPosObj2[1,1], aPosObj2[1,2] GROUP oGrupo TO aPosObj2[1,3], aPosObj2[1,4] PIXEL OF oDlgPes LABEL STR0052 COLOR CLR_HBLUE, CLR_HRED //" RDA Seleccionada - < CTRL + B >           Ver Mensagem - < CTRL + M >"

If Len(aCombo) > 0
	cCombo 		:= aCombo[1,1]+" - "+aCombo[1,2]
	cCobboEsp   := aCombo[1,4]
	lMens 		:= Iif(!Empty(aCombo[1,5]),.T.,.F.)	
Endif                 

nLinI := 10
@ aPosObj2[1,1]+nLinI, aPosObj2[1,2]+nColI Say oSayMed Prompt cCombo Size 300, 10 PIXEL OF oDlgPes FONT oFont01 COLOR CLR_HRED
                                                                
@ aPosObj2[2,1], aPosObj2[2,2] GROUP oGrupo TO aPosObj2[2,3], aPosObj2[2,4] PIXEL OF oDlgPes LABEL STR0009+dtoc(M->BBO_DATA)+" " COLOR CLR_HBLUE, CLR_HRED //" Data do Dia - "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta horarios do medico selecionado...                                  
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
@ aPosObj2[2,1]+nLinI, aPosObj2[2,2]+nColI Say oSay Prompt "< CTRL + C >" Size 100, 10 PIXEL OF oDlgPes COLOR CLR_HBLUE

nLinI := 8
nColI := 3 
nLinF := -200//1366/1024=200
nColF := -45//768/1024=45

oHorarios := TcBrowse():New( aPosObj2[2,1]+nLinI, aPosObj2[2,2]+nColI, aPosObj2[2,4]+nLinF, aPosObj2[2,3]+nColF,,,, oDlgPes,,,,,,,,,,,, .F.,, .T.,, .F., )

nColI := 5 
nLinF := -8
nColF := -5

//ADD COLUMN TO oHorarios BITMAP DATA "BR_BRANCO" { || Iif(Len(aHorAge)>0,PLSA315Cor(aHorAge,oHorarios),"BR_BRANCO") } TITLE "" WIDTH 015 NOHILITE

oHorarios:AddColumn(TcColumn():New(" ",{ || Iif(Len(aHorAge)>0,PLSA315Cor(aHorAge,oHorarios),"BR_BRANCO") },;
         nil,nil,nil,nil,015,.T.,.T.,nil,nil,nil,.T.,nil))

oHorarios:AddColumn(TcColumn():New(STR0010,nil,; //"Hora"
         nil,nil,nil,nil,020,.F.,.F.,nil,nil,nil,.F.,nil))     
         oHorarios:ACOLUMNS[2]:BDATA     := { || Iif((Len(aHorAge) >= oHorarios:nAt),aHorAge[oHorarios:nAt,2], '') }         
         
oHorarios:AddColumn(TcColumn():New(STR0011,nil,; //"Paciente"
         nil,nil,nil,nil,090,.F.,.F.,nil,nil,nil,.F.,nil))     
        oHorarios:ACOLUMNS[3]:BDATA     := { || Iif((Len(aHorAge) >= oHorarios:nAt),aHorAge[oHorarios:nAt,4],'') } 
        
oHorarios:AddColumn(TcColumn():New(STR0005,nil,; //"Telefone"
         nil,nil,nil,nil,070,.F.,.F.,nil,nil,nil,.F.,nil))     
         oHorarios:ACOLUMNS[4]:BDATA     := { || Iif((Len(aHorAge) >= oHorarios:nAt),aHorAge[oHorarios:nAt,5],'') }

oHorarios:AddColumn(TcColumn():New(STR0012,nil,; //"Empresa"
         nil,nil,nil,nil,050,.F.,.F.,nil,nil,nil,.F.,nil))     
         oHorarios:ACOLUMNS[5]:BDATA     := { || Iif((Len(aHorAge) >= oHorarios:nAt),aHorAge[oHorarios:nAt,14],'') }
                  
oHorarios:BLDBLCLICK   	:= {|| nOpcao := K_Agenda,Eval(bClick,oListLoc:nAt) }

oHorarios:bGotFocus		:= {|| lFocoBrw := .T.}
oHorarios:SetArray(aHorAge)         
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta credenciados disponiveis...                                        
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
aadd(aItems,{"","","",0,0,"",""})
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta botoes... ativa botoes apenas para se ter tecla de atalho... eles nao serao visiveis em tela!  |
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
Aadd(aButtons, {"PESQUISA"    	, bPesquisa ,STR0013, STR0014} ) //"Pesquisar - <ALT + P>"###"Pesquisar"
@ 001,001 BUTTON STR0015 SIZE 000,00 ACTION Eval(bPesquisa) PIXEL //"&Pesquisar"

Aadd(aButtons, {"BMPINCLUIR"   		,{ || nOpcao := K_Agenda, Eval(bClick,oListLoc:nAt), nOpcao := K_Agenda },STR0016,STR0017 } ) //"Agendar - <ALT + A>"###"Agendar"
@ 000,000 BUTTON STR0018   SIZE 000,00 ACTION { || nOpcao := K_Agenda, Eval(bClick,oListLoc:nAt), nOpcao := K_Agenda }  //"&Agendar"

Aadd(aButtons, {"BPMSDOCA"    ,{ || nOpcao := K_Editar, Eval(bClick,oListLoc:nAt), nOpcao := K_Agenda }, STR0019,STR0020 } ) //"Editar - <ALT + E>"###"Editar"
@ 000,000 BUTTON STR0021    SIZE 000,00 ACTION { || nOpcao := K_Editar, Eval(bClick,oListLoc:nAt), nOpcao := K_Agenda }  //"&Editar"

Aadd(aButtons, {"PMSRRFSH"    	,{ || nOpcao := K_Remarca,Eval(bClick,oListLoc:nAt), nOpcao := K_Agenda,lEncaixe:=.F. },STR0022, STR0023} ) //"Remarcar - <ALT + R>"###"Remarcar"
@ 000,000 BUTTON STR0024  SIZE 000,00 ACTION { || nOpcao := K_Remarca,Eval(bClick,oListLoc:nAt), nOpcao := K_Agenda,lEncaixe:=.F. }  //"&Remarcar"

Aadd(aButtons, {"CHECKED"    	,{ || nOpcao := K_Marcar , lFocoBrw := .F.,Eval(bClick,oListLoc:nAt), nOpcao := K_Agenda, lEncaixe:=.F. }, STR0025,STR0026} ) //"Marcar - <ALT + M>"###"Marcar"
@ 000,000 BUTTON STR0027    SIZE 000,00 ACTION { || nOpcao := K_Marcar , lFocoBrw := .F.,Eval(bClick,oListLoc:nAt), nOpcao := K_Agenda, lEncaixe:=.F. }  //"&Marcar"
                       
Aadd(aButtons, {"ESTOMOVI"    	,{ || nOpcao := K_Sair, Eval(bClick,oListLoc:nAt), nOpcao := K_Agenda },STR0028,STR0029} ) //"Estorna Remarcacao - <ALT + C>"###"Estornar"
@ 000,000 BUTTON STR0030  SIZE 000,00 ACTION { || nOpcao := K_Sair, Eval(bClick,oListLoc:nAt), nOpcao := K_Agenda }  //"Estorna Remar&cacao"

Aadd(aButtons, {"EXCLUIR"    	,{ || nOpcao := K_Cancel, Eval(bClick,oListLoc:nAt), nOpcao := K_Agenda },STR0031, STR0032} ) //"Desmarcar - <ALT + D>"###"Desmarcar"
@ 000,000 BUTTON STR0033  SIZE 000,00 ACTION { || nOpcao := K_Cancel, Eval(bClick,oListLoc:nAt), nOpcao := K_Agenda }  //"&Desmarcar"

Aadd(aButtons, {"BMPPARAM"    	,{||lEncaixe := .T.,nOpcao:=K_Agenda,Eval(bClick),lEncaixe:=.F. },STR0034,STR0035} ) //"Encaixe - < F12 > "###"Encaixe"
             
Aadd(aButtons, {"RELATORIO"    	, {||PL300VISCAR(cCodEsp,dData,aListaUsr,oListaUsr, nOpcao, oDlgPes, nDsPer,BBO->BBO_CODPAC,lBBO_ATERNA)},STR0036,STR0037} ) //"Carencias - <ALT + N>"###"Carencia"
@ 000,000 BUTTON STR0038 SIZE 000,00 ACTION Eval({||PL300VISCAR(cCodEsp,dData,aListaUsr,oListaUsr, nOpcao, oDlgPes, nDsPer,BBO->BBO_CODPAC,lBBO_ATERNA)})  //"Care&ncias"
                                                                                                                                      
Aadd(aButtons, {"S4WB004N"    	,{|| A300CLSUSR() },STR0039,STR0040} ) //"Limpa usuario selecionado - < F10 > "###"Usuario"
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta filtros...                                                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
@ aPosObj1[3,1]+15, aPosObj1[3,2] GROUP oGrupo TO aPosObj1[3,3]+140, aPosObj1[3,4] PIXEL OF oDlgPes LABEL STR0041  COLOR CLR_HBLUE, CLR_HRED //" Parametros de Selecao "

nLinI := 8
nColI := 1 
nLinF := -8
nColF := iIf(lR5,-156,-135)

oPainelEchoice := TPanel():New(aPosObj1[3,1]+25,aPosObj1[3,2]+2,,oDlgPes,,,,,,aPosObj1[3,4]-8,aPosObj1[3,3]-007)//ok    

nColI := 5 
nLinF := -135
nColF := -8

oEnc  := MsMGet():New("BBO" ,0 ,K_Incluir,,,,,{aPosObj1[3,1]+10,aPosObj1[3,2]+4 , aPosObj1[3,4]-6,aPosObj1[3,3]-125 },aCampos,,,,,oPainelEchoice,,,.T.,)
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define timer da bolinha da mensagem do medico...                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
@ 032,378 BITMAP oBmpBol RESNAME "BR_VERMELHO" OF oDlgPes SIZE 20,20 NOBORDER WHEN .F. PIXEL
oSinal := TTimer():New( 1 ,{|| (nCor := Iif(nCor==1,2,1), Iif(nCor==1,oBmpBol:CRESNAME := "BR_VERMELHO",oBmpBol:CRESNAME := "BR_AMARELO"), oBmpBol:Refresh())},oDlgPes)
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define timer para dar refresh no browse da agenda...                     
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
oTimerBrw 	:= TTimer():New( nTime*1000 ,bFiltro,oDlgPes)	

If !lMens           
	oSinal:LACTIVE 			:= .F.
	oBmpBol:LVISIBLECONTROL := .F.
Endif
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Posiciona no primeiro dia valido  no prazo de 5 dias					 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
PLSA300Dat("1",oEnc,bFiltro,5,M->BBO_DATA,.T.)

@ aPosObj1[4,1]+140, aPosObj1[4,2] GROUP oGrupo TO aPosObj1[4,3], aPosObj1[4,4] PIXEL OF oDlgPes LABEL STR0042  COLOR CLR_HBLUE, CLR_HRED        //" Paciente selecionado - < F11 >"

If !Empty(cMatric)
	Reclock("BBO",.F.)
		If lBBO_ATERNA//BBO->( FieldPos("BBO_ATERNA") ) > 0
			BBO->BBO_ATERNA := cAterna
		EndIf	
		BBO->BBO_CODPAC 	:= cMatric
		BBO->BBO_NOME	    := cNomUsr
		BBO->BBO_TELEFO		:= cTelUsr
		BBO->BBO_MATANT		:= cMatAnt
	BBO->( msUnlock() )
Endif

nLinI := 150
@ aPosObj1[4,1]+nLinI, aPosObj1[4,2]+nColI Say oSay Prompt STR0011 Size 100, 10 PIXEL OF oDlgPes COLOR CLR_HBLUE //"Paciente"
nColI +=30
@ aPosObj1[4,1]+nLinI, aPosObj1[4,2]+nColI Say oSay1 Prompt BBO->BBO_CODPAC 	PICTURE "@R !.!!!.!!!!.!!!!!!-!!-!" Size 100, 10 PIXEL OF oDlgPes

If lBBO_ATERNA//BBO->( FieldPos("BBO_ATERNA") ) > 0
	nColI +=70
	@ aPosObj1[4,1]+nLinI, aPosObj1[4,2]+nColI Say oSay Prompt STR0043	Size 100, 10 PIXEL OF oDlgPes COLOR CLR_HBLUE //"Recem-Nasc."
	nColI +=40
	@ aPosObj1[4,1]+nLinI, aPosObj1[4,2]+nColI Say oSay5 Prompt AllTrim(X3COMBO("BBO_ATERNA",BBO->BBO_ATERNA))	Size 100, 10 PIXEL OF oDlgPes
EndIf
nLinI +=15
nColI := 5 
@ aPosObj1[4,1]+nLinI, aPosObj1[4,2]+nColI Say oSay Prompt STR0044				Size 100, 10 PIXEL OF oDlgPes COLOR CLR_HBLUE //"Nm. Paciente"
nColI += 35 
@ aPosObj1[4,1]+nLinI, aPosObj1[4,2]+nColI Say oSay2 Prompt BBO->BBO_NOME 	  	Size 100, 10 PIXEL OF oDlgPes

nLinI +=15
nColI := 5 
@ aPosObj1[4,1]+nLinI, aPosObj1[4,2]+nColI Say oSay Prompt STR0045				Size 100, 10 PIXEL OF oDlgPes COLOR CLR_HBLUE //"Matr Antiga "
nColI += 35 
@ aPosObj1[4,1]+nLinI, aPosObj1[4,2]+nColI Say oSay3 Prompt BBO->BBO_MATANT 	Size 100, 10 PIXEL OF oDlgPes

nColI +=70
@ aPosObj1[4,1]+nLinI, aPosObj1[4,2]+nColI Say oSay Prompt STR0005				Size 100, 10 PIXEL OF oDlgPes COLOR CLR_HBLUE //"Telefone"
nColI +=30
@ aPosObj1[4,1]+nLinI, aPosObj1[4,2]+nColI Say oSay4 Prompt BBO->BBO_TELEFO 	Size 100, 10 PIXEL OF oDlgPes

nLinI :=8
nColI :=5
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Desabilita teclas...                                                     
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
Pls300DisableKeys()
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define das teclas de atalhos da marcacao de consultas...                 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
SetKey(VK_F4 ,((oListLoc:Refresh()),lByPass := .T.,{||PLSA300Dat("2",oEnc,bFiltro,nDsPes,M->BBO_DATA),lByPass:=.F.}))// Agenda anterior
SetKey(VK_F5 ,((oListLoc:Refresh()),lByPass := .T.,{||PLSA300Dat("1",oEnc,bFiltro,nDsPes,M->BBO_DATA),lByPass:=.F.}))// Promxima Agenda
SetKey(VK_F6 ,{||oEnc:AENTRYCTRLS[1]:SetFocus()})  										// Troca a data
SetKey(VK_F7 ,{||oEnc:AENTRYCTRLS[3]:SetFocus()})  										// Troca a especialidade
SetKey(VK_F8 ,{||oEnc:AENTRYCTRLS[5]:SetFocus()})											// Troca o medico
SetKey(VK_F9 ,{||oEnc:AENTRYCTRLS[7]:SetFocus()})											// Troca o local de atendimento
SetKey(VK_F10 ,{|| A300CLSUSR() })															// Limpa usuario selecionado.
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Identificacao de usuario...                                              
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
SetKey(VK_F11,{||Pls300DisableKeys(),;     
				 PLSA300CALL(cCodEsp,dData,1,aListaUsr,oListaUsr,nOpcao,oDlgPes,nDsPer,oListLoc:aArray[oListLoc:nAt][1],aHorAge,oHorarios,.T.),;
                 Pls300EnableKeys(oListLoc, oEnc, bFiltro, nDsPes, dData, aListaUsr,nOpcao, oDlgPes, bClick,;
                 oHorarios, bVetAge, oBrowse,cCodEsp,oListaUsr,nDsPer)}) 					// Identificacao do paciente.
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Encaixe...                                                               
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
SetKey(VK_F12 ,{||lEncaixe := .T.,nOpcao:=K_Agenda,Eval(bClick),lEncaixe:=.F. }) 			// Encaixe
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Foca no browse de locais de atendimento...                               
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸				  
SetKey(1  ,{||oListLoc:SetFocus()})  							  							// Foca os locais de atendimento.
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Chama o browse com os medicos disponiveis...                             
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
SetKey(2  ,{||If(lMarcar,(Pls300DisableKays(),PLS300MEDBRW(oHorarios,oBrowse,bVetAge),;
                 Pls300EnableKeys(oListLoc, oEnc, bFiltro, nDsPes,dData, aListaUsr,nOpcao, ;
                 oDlgPes, bClick, oHorarios, bVetAge, oBrowse,cCodEsp,oListaUsr,nDsPer)),;
                 Aviso(STR0023,STR0046,{STR0047})) }) // Invoca o browse de medicos //"Remarcar"###"Nao e possivel trocar de medico na remarcacao."###"&Voltar"
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Foca no browse de horarios...                                            
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸			
SetKey(3  ,{||oHorarios:SetFocus()})  														// Foca a agenda do medico selecionado
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Mostra mansagem do medico na data atual...                               
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
SetKey(13 ,{||PLSA300MSG()})
nLinI := 31
@ aPosObj1[1,3]+nLinI, aPosObj1[1,2]+nColI BUTTON oBot01 PROMPT " << " 	SIZE 20,15  ACTION ((oListLoc:Refresh()),lMove := .T.,lByPass:=.T.,PLSA300Dat("2",oEnc,bFiltro,nDsPes,M->BBO_DATA),lByPass:=.F.) PIXEL  OF oDlgPes
oBot01:cTOOLTIP := STR0048 //"Agenda Anterior"

nColI+=20
@ aPosObj1[1,3]+nLinI, aPosObj1[1,2]+nColI BUTTON oBot02 PROMPT " < " 		SIZE 20,15  ACTION (lMove := .T.,lByPass:=.F.,PLSA300Dat("3",oEnc,bFiltro,nDsPes,M->BBO_DATA)) PIXEL  OF oDlgPes
oBot02:cTOOLTIP := STR0049 //"Diminuir Data"

nColI+=20
@ aPosObj1[1,3]+nLinI, aPosObj1[1,2]+nColI BUTTON oBot04 PROMPT " > " 		SIZE 20,15  ACTION (lMove := .T.,lByPass:=.F.,PLSA300Dat("4",oEnc,bFiltro,nDsPes,M->BBO_DATA)) PIXEL  OF oDlgPes
oBot04:cTOOLTIP := STR0050 //"Aumentar Data"

nColI+=20
@ aPosObj1[1,3]+nLinI, aPosObj1[1,2]+nColI BUTTON oBot03 PROMPT " >> " 	SIZE 20,15  ACTION ((oListLoc:Refresh()),lMove := .T.,lByPass	:=.T.,PLSA300Dat("1",oEnc,bFiltro,nDsPes,M->BBO_DATA),lByPass:=.F.) PIXEL  OF oDlgPes
oBot03:cTOOLTIP := STR0051 //"Proxima Agenda"
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Ativa o dialogo...                                                      
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
ACTIVATE MSDIALOG oDlgPes ON INIT (Iif(ValType(oSinal)<>"U",oSinal:Activate(),nCor:=1),;
								   oTimerBrw:Activate(),;
                                   Eval( {|| EnchoiceBar(oDlgPes,{|| dbSelectarea("BBD"), oDlgPes:End()},{|| dbSelectarea("BBD"), oDlgPes:End()},.F.,aButtons)}) ) 

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Lebera teclas de atalhos...                                              
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
SET KEY VK_F2 TO
SET KEY VK_F4 TO
SET KEY VK_F5 TO
SET KEY VK_F6 TO
SET KEY VK_F7 TO
SET KEY VK_F8 TO
SET KEY VK_F9 TO
SET KEY VK_F10 TO
SET KEY VK_F11 TO
SET KEY VK_F12 TO              
SET KEY 1  TO              
SET KEY 2  TO              
SET KEY 3  TO              
SET KEY 4  TO              
SET KEY 13 TO              
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Fim da rotina...                                                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
Return               
/*/
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇旼컴컴컴컴컫컴컴컴컴컴컴쩡컴컴컴쩡컴컴컴컴컴컴컴컴컴컫컴컴컴쩡컴컴컴컴커굇
굇쿑uncao     PLSA300AJC  Autor 쿒eraldo Felix Junior Data  18.12.01 낢
굇쳐컴컴컴컴컵컴컴컴컴컴컴좔컴컴컴좔컴컴컴컴컴컴컴컴컴컨컴컴컴좔컴컴컴컴캑굇
굇쿏escricao  Ajusta o browse de acordo com os novos parametros...      낢
굇쳐컴컴컴컴컨컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴캑굇
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
/*/
Static Function PLSA300Ajc(	cCodInt,dData,cCodEsp,cDesMun,cEstado,cBairro,cCodPro,cCodLoc,cCodCre,cInd,;
							cCadastro,aColunas,aDados,aOcupacao,oBrowse,oDlgPes,bChange,bClick,;
	                        oCorOcu,oCorLiv,aMedHor,bBrwCol,bMontVet,oListMed,aItems,oListLoc,;
	                        bVetAge,oHorarios,cMedico)
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Declara as variaveis...                                                  
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸                        
Local nCnt
LOCAL nI
LOCAL aRetorno 	:= {}
LOCAL aComboAux := {}
LOCAL lRet 		:= .F.         
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Retorno																	 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸			
If !lMarcar .and. !lMove
	Return(.F.)
Endif
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// criar arquivo de trabalho baseado nos parametros BBO...                  
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸			
lMove := .F.
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// criar arquivo de trabalho baseado nos parametros BBO...                  
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸			
aRetorno := PLSA300Trb(cCodInt,dData,cCodEsp,cDesMun,cEstado,cBairro,cCodPro,cCodLoc,cCodCre,cInd,cCadastro) 
If ! aRetorno[1]
   Return(lRet)
Endif   
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Cria o array com os locais de atendimento resultantes...                 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
aColunas := aClone(aRetorno[2])                             
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Executa o codblock responsavel pelos arrays com os horarios dos medicos  
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
Eval(bMontVet)
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Testa o array dos medicos disponiveis, de  acordo com os parametros...       |
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸                         
If Len(aCombo) > 0                         
	lRet := .T.
	//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
	// Para checar todos os medicos											 
	//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
	For nI := 1 To Len(aCombo)
		//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
		// Pega o medico															 
		//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
		If Alltrim(cCombo) == STR0053 .Or. Empty(cCombo) //"Nao ha medicos disponiveis"
			cCombo 					:= aCombo[nI,1]+" - "+aCombo[nI,2]
			cComboEsp				:= aCombo[nI,4]
			oSinal:LACTIVE 			:= Iif(!Empty(aCombo[nI,5]),.T.,.F.)	
			oBmpBol:LVISIBLECONTROL := Iif(!Empty(aCombo[nI,5]),.T.,.F.)	
		Endif
		//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
		// Executa o codblock responsavel pela agenda especifica do medico selecionado horarios...|
		//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸                         
		Eval(bVetAge)
		//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
		// Caso seja precionado o botao "PROXIMA VAGA" tem que ignorar os dias com agenda cheia.|
		//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸                         
		If lByPass 
			lRet := .F.
			For nCnt := 1 To Len(aHorAge)
				If Empty(aHorAge[nCnt][4])
					lRet := .T.
					Exit
				Endif
			Next
		Endif   
		//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
		// Limpa combo para pegar o proximo medico												 |
		//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸                         
		If !lRet
			cCombo := ''
		Else
		    Exit	
		EndIf
    Next      
	//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
	// Retira medicos que nao tem horario disponivel										 |
	//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸                         
	If lRet .And. lByPass                       
	   If Len(aMedDis) > 0
		   For nI := 1 To Len(aCombo)
			   nPos := Ascan(aMedDis,{|x| x[1] == aCombo[nI,1] } )
		       If nPos > 0 .Or. Left(cCombo,Len(BAU->BAU_CODIGO)) == aCombo[nI,1]
       			  AaDd(aComboAux, {aCombo[nI,1],aCombo[nI,2],aCombo[nI,3],aCombo[nI,4],aCombo[nI,5]} )	
			   EndIf	   
		   Next
	   Else
		   nPos := Ascan(aCombo,{|x| x[1] == Left(cCombo,Len(BAU->BAU_CODIGO)) } )
	       If nPos > 0 
      		  AaDd(aComboAux, {aCombo[nPos,1],aCombo[nPos,2],aCombo[nPos,3],aCombo[nPos,4],aCombo[nPos,5]} )	
		   EndIf	   
	   EndIf   
  	   //旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
	   // Atualiza matriz combo																|
	   //읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸                         
	   aCombo := aClone(aComboAux)
	EndIf   
Else
	cCombo 					:= STR0053   //"Nao ha medicos disponiveis"
	cComboEsp 				:= ''
	oSinal:LACTIVE 			:= .F.
	oBmpBol:LVISIBLECONTROL := .F.
	lRet 					:= .F.
	aHorAge 				:= {}
Endif
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Atualiza o browse dos locais de atendimento, utilizando o array acolunas...  |
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸                         
oListLoc:SetArray(aColunas)    
oListLoc:Refresh()
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Ajusta o browse da agenda especifica do medico selecionado...                    |
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
oHorarios:SetArray(aHorAge)
oHorarios:Refresh()
oHorarios:SetFocus()

Return(lRet)

/*/
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇旼컴컴컴컴컫컴컴컴컴컴컴쩡컴컴컴쩡컴컴컴컴컴컴컴컴컴컫컴컴컴쩡컴컴컴컴커굇
굇쿑uncao     PLSA300VET  Autor 쿒eraldo Felix Junior Data  18.12.01 낢
굇쳐컴컴컴컴컵컴컴컴컴컴컴좔컴컴컴좔컴컴컴컴컴컴컴컴컴컨컴컴컴좔컴컴컴컴캑굇
굇쿏escricao  Monta os arrays necessarios para a montagem do dialogo... 낢
굇쳐컴컴컴컴컨컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴캑굇
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
/*/
Static Function PLSA300VET(aColunas,cInd,aDados,aOcupacao,aMedHor,dData,cCodInt,oListLoc,cDia,cDiaMes,cMes,cAno,oListMed)
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define variaveis de tela...                                              
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
LOCAL aAux      := {}
LOCAL aPosHor   := {}                                 
LOCAL aColsAux  := {}
LOCAL aHorCol   := {}
LOCAL aAuxMeds	:= {}
LOCAL cSQL

LOCAL nAux		:= 0
LOCAL nCol		:= 0
LOCAL nInd		:= 0                   
LOCAL nCnt 		:= 0

LOCAL lVaga
LOCAL lHorCan
LOCAL bSeek		:= {|| ( BBD->(MsSeek(xFilial("BBD")+aInd[nCnt][02]+cCodInt+aInd[nCnt][29]+dtos(dData)+aAux[nAux]+Space(02))) .And. BBD->BBD_ENCAIX == "0" .And. BBD->BBD_PRTATD == "0" .and. Empty(BBD->BBD_CODCAN))}
PRIVATE cPictPad  := "@R !!:!!"

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Redefine o array dos horarios medicos...                                 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
aMedHor := {}                         

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Testa integridade do dado...                                             
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸              
If Len(aColunas) <= 1 .Or. (Len(aColunas) < oListLoc:nAt)
	oListLoc:nAt := 1
Endif	
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Redefine o array aCombo...                                               
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
aCombo:= {}
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Para cada localidade vou buscar os horarios disponiveis...               
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸	
BBD->(DbSetOrder(1))     
For nCnt := 1 To Len(aInd)
	// Apenas as colunas do local de atendimento selecionado.
	If aInd[nCnt][30] <> aColunas[oListLoc:nAt,1]
		Loop
	Endif
	
	//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
	// Monta os horarios dos medicos...                                         
	//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
	aAux := PLSA300HR(aInd[nCnt][03],aInd[nCnt][04],Iif(!Empty(aInd[nCnt][08]),aInd[nCnt][08],aInd[nCnt][32]),aInd[nCnt][05],aInd[nCnt][06])
	//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
	// Monta o array com os medicoss disponiveis                                
	//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸			
	If Len(aAux) > 0
		BAQ->( dbSetorder(01) )
		BAQ->( MsSeek(xFilial("BAQ")+aInd[nCnt][09]+aInd[nCnt][07]) )
		If Ascan(aCombo,{|x| x[1]+x[4] == aInd[nCnt][02]+aInd[nCnt][07]}) == 0
			aadd(aCombo,{aInd[nCnt][02],Alltrim(aInd[nCnt][21]),aInd[nCnt][40],aInd[nCnt][07],aInd[nCnt][17]})	
		Endif
	Endif	
Next
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Seleciona area usuarios													 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
DbSelectArea("BA1")
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Atualiza a variavel do medico...                                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If ( nPos := Ascan(aCombo,{|x| x[1] == Left(cCombo,Len(BAU->BAU_CODIGO)) }) ) <> 0
	cCombo 		:= aCombo[nPos,1]+" - "+aCombo[nPos,2]
	cComboEsp   := aCombo[nPos,4]
	If ValType(oSinal) == "O"
		oSinal:LACTIVE 			:= Iif(!Empty(aCombo[1,5]),.T.,.F.)	
	Endif
	If ValType(oBmpBol) == "O"
		oBmpBol:LVISIBLECONTROL := Iif(!Empty(aCombo[1,5]),.T.,.F.)	
	Endif	
Else                      
	If Len(aCombo) > 0
		cCombo := aCombo[1,1]+" - "+aCombo[1,2]
		cComboEsp   := aCombo[1,4]
		If ValType(oSinal) == "O"
			oSinal:LACTIVE 			:= Iif(!Empty(aCombo[1,5]),.T.,.F.)	
		Endif
		If ValType(oBmpBol) == "O"
			oBmpBol:LVISIBLECONTROL := Iif(!Empty(aCombo[1,5]),.T.,.F.)	
		Endif
	Endif
Endif
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Fim da rotina...                                                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
Return(aDados,aOcupacao,aMedHor)               

/*/
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇旼컴컴컴컴컫컴컴컴컴컴컴쩡컴컴컴쩡컴컴컴컴컴컴컴컴컴컫컴컴컴쩡컴컴컴컴커굇
굇쿑uncao     PLSA300SEL  Autor 쿒eraldo Felix Junior Data  18.12.01 낢
굇쳐컴컴컴컴컵컴컴컴컴컴컴좔컴컴컴좔컴컴컴컴컴컴컴컴컴컨컴컴컴좔컴컴컴컴캑굇
굇쿏escricao  Abre a tela da agenda de um determinado medico em um hora.낢
굇쳐컴컴컴컴컨컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴캑굇
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
/*/
Static Function PLSA300Sel(oBrowse,oListMed,aColunas,aDados,aOcupacao,dData,;
                           cCodEsp,cDesEsp,cCodInt,cInd,aMedRec,cPictPad,;
                           oDlgPes,aItems,nOpcao,nDsPer, nCol, aMedHor, cNada,;
                           aHorAge, oHorarios, bVetAge, cCodPro, cCodLoc) 
LOCAL lFlag
LOCAL oFont01 
LOCAL oDlgMar
LOCAL oSay
LOCAL oEnc               
LOCAL oListaUsr
LOCAL oListaUs1
LOCAL oComboMed
LOCAL oFontVd

LOCAL lRet       := .F.
LOCAL nPosHour	 := 0
LOCAL nH		 := 0
LOCAL nLin       := 0
LOCAL nRecBBD	 := 0
LOCAL nInd		 := 0
LOCAL nTamDlgPad := 0
LOCAL nAux       := 0
LOCAL nOpca      := 0               
LOCAL nAtCombo	 := 1    
LOCAL nOpcEnc	 := 0
LOCAL nNewCampos := 1
LOCAL cFile		 := ''
LOCAL cNil       := ''
LOCAL cTimeFin	 := ''
LOCAL cTitulo	 := ''
LOCAL cFoto      := ''
LOCAL cTimeIni	 := Time()
LOCAL cConSem 	 := "ATEND"                                                
LOCAL cLocal     := { || aColunas[nCol,1]+" - "+aColunas[nCol,2] }
LOCAL cHorario   := { || StrTran(aHorAge[oHorarios:nAt,2],":","") }
LOCAL aButtons   := {}
LOCAL aCampos    := {}   
LOCAL aDadBBD    := {}
LOCAL aDadBHY    := {}         
LOCAL aComboMed	 := {}
LOCAL aComboAux	 := {}
LOCAL aListaUsr  := { {"","","",0,.T.,"","",""} }
LOCAL aListaUs1  := { {"","","",0,.T.} }
LOCAL aOldTela   := aTela
LOCAL aOldGets   := aGets
LOCAL aDadUsr 	 := {} 
LOCAL bRecBAU    := { || aHorAge[oHorarios:nAt,11] }
LOCAL bCodLoc    := { || aHorAge[oHorarios:nAt,12] }
LOCAL bOK        := { || Iif(A300VLDSEL(@nOpca, @lEncaixe, @aGets, @aTela, @nOpcao, @aHorAge, @dData, @cCodEsp,;
									 @nDsPer, oEnc, @lMarcar, @oDlgRes, @cCodLoc) .And. IIf(ExistBlock("PL300ENC") .And. lEncaixe,ExecBlock("PL300ENC",.F.,.F.,{BAU->BAU_CODIGO}),.T.), oDlgRes:End(), NIL)}
		                     
LOCAL bCanc      := { || nOpca := 3,oDlgRes:End() }
LOCAL bOKMar     := { || nOpca := 1,If((Obrigatorio(aGets,aTela)),(PLS300MAR(dData,cCombo,oHorarios) .And. oDlgMar:End()),(nOpca:=3,.F.))}
LOCAL bCancMar   := { || nOpca := 3,oDlgMar:End() }
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Variaveis PRIVATES...                                                    
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
PRIVATE oDlgRes
PRIVATE nTamDlgBrw := 538 
PRIVATE aTela    := {}
PRIVATE aGets    := {}
DEFAULT nOpcao   := K_Agenda
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// O nOpcao esta se perdendo.. 										     
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If nOpcao == 0  
   nOpcao  := K_Agenda                      
EndIf  
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Atualiza a variavel de especialidade...                                  
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cCodEsp := cComboEsp

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Trata agenda em branco...                                                
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If Len(aHorAge) == 0
	oHorarios:SetFocus()
	Return(lRet)
Else
	cLocal     := Eval(cLocal)
 	cHorario   := Eval(cHorario)
Endif
nRecBBD	 := aHorAge[oHorarios:nAt,06]
nLin     := oHorarios:nAt     
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Testa integridade do dado...                                             
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If Valtype(Eval(bRecBAU)) # "N"
	Aviso(STR0054,STR0055,{STR0047}) //"Erro."###"Tipo de dados incompativel"###"&Voltar"
	oHorarios:Setfocus()
	Return(lRet)
Endif
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Posiciona no registro do credenciado selecionado...                      
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸 
If nOpcao == K_Marcar .or. nOpcao == K_Sair
	If Len(aVetMar) == 0
		Return(lRet)
	Endif
	BAU->( dbSetorder(01) )
	BAU->( MsSeek(xFilial("BAU")+Left(aVetMar[1,8], Len(BAU->BAU_CODIGO))) )
Else
	BAU->( dbSetorder(01) )
	BAU->( MsSeek(xFilial("BAU")+Left(cCombo, Len(BAU->BAU_CODIGO))) )
Endif

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Trata se outra estacao realizou um bloqueio das agendas...               
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If !PL300VLBLQ(cCodInt, BAU->BAU_CODIGO, cCodEsp, Substr(cLocal, 1, Len(BBD->BBD_LOCAL)), dData, cHorario)
	Eval(bVetAge)
	oHorarios:Setarray(aHorAge)
	oHorarios:Refresh()
	Return(lRet)
Endif

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Clicou em marcar ou estornar a remarcacao sem ter clicaco em remarcar...                     |
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸                         
If nOpcao == K_Marcar .or. nOpcao == K_Sair
	If Len(aVetMar) == 0
		oHorarios:SetFocus()
		Return(lRet)		
	Endif                            
Endif
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Caso seja o "marcar" da remarcacao e seja clicado enter no browse, forca a troca da operacao |
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸                         
If !lMarcar .and. lFocoBrw .and. nOpcao # K_Sair
	If Len(aVetMar) == 0
	Else
		MsgInfo(STR0056) //"Para confirmar a remarcacao, posicione no horario livre desejado em seguida clique no botao MARCAR ou precione ALT+M"
	Endif
	Return(lRet)
Endif
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Trata horarios bloqueados...                                                                 |
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸                                                  
If (nOpcao == K_Agenda .or. nOpcao == K_Marcar) .and. !aHorAge[oHorarios:nAt,13]
	Aviso(STR0057,STR0058,{STR0047}) //"Bloqueio!"###"Este horario foi bloqueado pelo operador!"###"&Voltar"
	oHorarios:SetFocus()
	Return(lRet)
Endif	
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Para tratar remarcacao de encaixe...                                                         |
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴t켸                         
If nOpcao == K_Marcar
	If Len(aVetMar) == 0
		Return(lRet)
	Else
		If aVetMar[1,12] == "1"  //Encaixe
		   lEncaixe := .T.
		Endif
	Endif
Endif
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Trata horarios de encaixe																	 |
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸                                                  
If aHorAge[oHorarios:nAt,9] == '1' .And. !lEncaixe .and. nOpcao <> K_Cancel .and. nOpcao <> K_Editar
	MsgStop('Nao e possivel reutilizar um Horario de Encaixe')
	Return(lRet)
EndIf	
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Opcao... 								                                 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If (nOpcao == K_Agenda .or. nOpcao == K_Marcar) .and. cHorario < StrTran(Left(Time(),5),":","") .and.;
    M->BBO_DATA == Date() .and. !lEncaixe
	Aviso(STR0059,STR0060,{STR0047}) //"Horario invalido!"###"A hora da agenda selecionada e menor que a hora atual na mesma data."###"&Voltar"
	oHorarios:SetFocus()
	Return(lRet)
Endif
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define fonte para mensagem...                                            
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸              
DEFINE FONT oFont01 NAME "Arial" SIZE 0,-16 BOLD

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Vaga ocupada aborta...                                                   
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If (nOpcao == K_Agenda .Or. nOpcao == K_Marcar) .And.;
	!Empty(aHorAge[oHorarios:nAt,4]) .And.; //Tiver passiente
	Empty(aHorAge[oHorarios:nAt,10]) .And.; //Nao tiver cancelado
	!lEncaixe								 //Nao for um encaixe
	Aviso(STR0061,STR0062,{STR0047}) //"Horario nao disponivel!"###"Ja existe uma agenda marcada neste horario, selecione um horario livre."###"&Voltar"
	oHorarios:SetFocus()
	Return(lRet)
Endif      
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Teste de ocupacao...                                                     
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If ( nOpcao == K_Editar .Or. nOpcao == K_Cancel .Or. nOpcao == K_Remarca ) .And. aHorAge[oHorarios:nAt,6] == 0 .and. !lEncaixe
	MsgInfo(STR0063) //"Este horario nao esta ocupado portando nao podera ser editado ou cancelado"
	oHorarios:SetFocus()
	Return(lRet)
Endif   
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta titulo do dialogo de acordo com a opcao...                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If  nOpcao == K_Agenda
	cTitulo := STR0064 //"Agenda Medica - Dados do Paciente"
ElseIf nOpcao == K_Editar
	cTitulo := STR0065 //"Agenda Medica - Editar Dados do Paciente"
ElseIf nOpcao == K_Cancel
	cTitulo := STR0066 //"Agenda Medica - Cancelar Agenda"
ElseIf nOpcao == K_Remarca
	cTitulo := STR0067 //"Agenda Medica - Remarcar Agenda"
Elseif nOpcao == K_Sair
	cTitulo := STR0068 //"Agenda Medica - Restaurar Agenda"
Endif       
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Se nao estiver selecionado no listmed sugere o primeiro...               
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If nOpcao == K_Agenda
	lFlag := .F.
	For nInd := 1 To Len(aItems)
		If Empty(aItems[nInd,2])
			lFlag := .T.
			If ValType(Eval(bRecBAU)) == "C"
				MsgAlert(STR0069) //"Ocorreu um erro inesperado no sistema, por favor tente novamente. Se o problema continuar acione o Suporte Tecnico."
				Return(.F.)
			Endif
			Aadd( aComboMed,aItems[nInd,1]+"    ["+Alltrim(Str(Eval(bRecBAU)))+"]" )
			Aadd( aComboAux,aItems[nInd,7] )
		Endif
	Next
	
	If !lFlag
		Aadd( aComboMed,aItems[1,1]+"    ["+Alltrim(Str(Eval(bRecBAU)))+"]" )
		Aadd( aComboAux,aItems[1,7] )
	Endif
Endif                         

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Se ja houve atendimento nao pode cancelar...                             
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If nOpcao == K_Cancel .Or. nOpcao == K_Editar .Or. nOpcao == K_Remarca
	If aHorAge[oHorarios:nAt,7] <> "1" .And. aHorAge[oHorarios:nAt,7] <> "8"
		MsgInfo(STR0070) //"Esta agenda ja foi editada pela Recepcao medica."
		oHorarios:SetFocus()
		Return(lRet)
	Endif
Endif

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Eu testo se ja existe...                                                 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If (nOpcao == K_Agenda .or. nOpcao == K_Marcar) .and. !lEncaixe
   BBD->(DbSetOrder(1))
   If BBD->(MsSeek(xFilial("BBD")+BAU->BAU_CODIGO+cCodInt+Eval(bCodLoc)+dtos(dData)+TransForm(cHorario,cPictPad)+Space(02))) .and. Empty(BBD->BBD_CODCAN)
      MsgInfo(STR0071) //"Horario Reservado por outro(a) operador(a)"
      oHorarios:SetFocus()
      Return(lRet)
   Endif   
Else
   BBD->( DbGoTo(nRecBBD) )
Endif
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Controle de transacao...                                                 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If nRecBBD > 0
   cFile := "F"+cConSem+AllTrim( Str(nRecBBD) )+".SMF"
Else 
   cFile := "F"+cConSem+aHorAge[oHorarios:nAt,1]+aHorAge[oHorarios:nAt,12]+cHorario+".SMF"
EndIf   
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Tenta criar o arquivo													 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
nH := FCreate(cFile)
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Checa se o arquivo ja foi criado Cancelamento							 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If nH == -1 
   Aviso(STR0072,STR0073,{STR0047}) //"Ocupado"###"Horario sendo utilizado por outra estacao. Tente dentro de alguns segundos"###"&Voltar"
   Return
Endif   
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta dialogo...                                                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If nopcao == K_Cancel 
   nAux := 031
Else
   nAux := 029
Endif   
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Testa se existe usuario selecionado...                                   
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸     
If nOpcao == K_Agenda 
	If Empty(BBO->BBO_CODPAC)
		If Aviso(STR0040,STR0074,{STR0075,STR0047}) == 1 //"Usuario"###"Nao existe usuario selecionado!"###"&Selecionar"###"&Voltar"
			If !PLSA300CALL(cCodEsp,dData,1,aListaUsr,oListaUsr,nOpcao,oDlgPes,nDsPer,aColunas[nCol,1],aHorAge,oHorarios,.F.)
				//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
				// Controle de transacao...                                                 
				//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
				FCLOSE(nH)
				FErase(cFile)   
				oHorarios:SetFocus()
				Return(.F.)
			Endif
		Else
			//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
			// Controle de transacao...                                                 
			//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
			FCLOSE(nH)
			FErase(cFile)
			oHorarios:SetFocus()
			Return(.F.)
		Endif
	Endif
Endif	

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define font utilizada na validacao do usuario...                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
DEFINE FONT oFontVd NAME "Arial" SIZE 0,-14 BOLD

If nOpcao <> K_Remarca
	
	DEFINE MSDIALOG oDlgRes TITLE cTitulo FROM 002,005 TO nAux, 060 OF oDlgPes
	//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
	// Monta informacoes do horario/medico selecionado...                       
	//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
	@ 014,001 GROUP oGrpLoc TO 061, 215 PIXEL OF oDlgRes LABEL STR0076  COLOR CLR_HBLUE, CLR_HRED //"Detalhes"
	
	@ 022,005 Say oSay Prompt STR0077 Size 150,008 PIXEL OF oDlgRes COLOR CLR_HBLUE //"DATA"
	@ 021,030 Say oSay Prompt dtoc(dData) Size 150,008 PIXEL OF oDlgRes FONT oFontVd COLOR CLR_HRED
	
	@ 022,095 Say oSay Prompt STR0078 Size 150,008 PIXEL OF oDlgRes COLOR CLR_HBLUE //"HORARIO"
	If lEncaixe
		@ 021,130 Say oSay Prompt STR0035 Size 150,008 PIXEL OF oDlgRes FONT oFontVd COLOR CLR_HRED //"Encaixe"
	Else
		@ 021,130 Say oSay Prompt TransForm(cHorario,cPictPad) Size 150,008 PIXEL OF oDlgRes FONT oFontVd COLOR CLR_HRED
	Endif
	
	@ 037,005 Say oSay Prompt STR0079 Size 150,008 PIXEL OF oDlgRes COLOR CLR_HBLUE //"LOCAL "
	@ 036,030 Say oSay Prompt cLocal Size 200,008 PIXEL OF oDlgRes FONT oFontVd COLOR CLR_HRED
	
	@ 050,005 Say oSay Prompt STR0080 Size 100,008 PIXEL OF oDlgRes COLOR CLR_HBLUE //"MEDICO"
	
	If nOpcao == K_Marcar .or. nOpcao == K_Sair
		If Len(aVetMar) <> 0
			@ 050,030 Say oSay Prompt aVetMar[1,8] Size 200,008 PIXEL OF oDlgRes FONT oFontVd COLOR CLR_HRED
		Endif
	Else
		@ 050,030 Say oSay Prompt cCombo Size 200,008 PIXEL OF oDlgRes FONT oFontVd COLOR CLR_HRED
	Endif
	
ENDIF

If nOpcao == K_Remarca
	//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
	// Monta dialogo remarcacao...                                              
	//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
	DEFINE MSDIALOG oDlgMar TITLE cTitulo FROM 002,005 TO nAux, 060 OF oDlgPes
	//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
	// Monta informacoes do horario/medico selecionado...                       
	//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
	@ 015,001 GROUP oGrpLoc TO 061, 215 PIXEL OF  oDlgMar LABEL STR0076  COLOR CLR_HBLUE, CLR_HRED //"Detalhes"
	
	@ 022,005 Say oSay Prompt STR0077 Size 150,008 PIXEL OF oDlgRes COLOR CLR_HBLUE //"DATA"
	@ 021,030 Say oSay Prompt dtoc(dData) Size 150,008 PIXEL OF oDlgRes FONT oFontVd COLOR CLR_HRED
	                                                                  
	@ 022,095 Say oSay Prompt STR0078 Size 150,008 PIXEL OF oDlgRes COLOR CLR_HBLUE     //"HORARIO"
	@ 021,130 Say oSay Prompt TransForm(cHorario,cPictPad) Size 150,008 PIXEL OF oDlgRes FONT oFontVd COLOR CLR_HRED
         
	@ 037,005 Say oSay Prompt STR0079 Size 150,008 PIXEL OF oDlgRes COLOR CLR_HBLUE //"LOCAL "
	@ 036,030 Say oSay Prompt cLocal Size 200,008 PIXEL OF oDlgRes FONT oFontVd COLOR CLR_HRED

	@ 050,005 Say oSay Prompt STR0080 Size 100,008 PIXEL OF oDlgMar COLOR CLR_HBLUE //"MEDICO"
	@ 050,030 Say oSay Prompt cCombo Size 200,008 PIXEL OF oDlgRes FONT oFontVd COLOR CLR_HRED
	
ENDIF
                              
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
//쿎arrega variaveis de memoria...                                           
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
BBD->(RegToMemory("BBD",.F.))
                              
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta dados da enchoice...                                               
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
aadd(aCampos,"BBD_CODPAC")
aadd(aCampos,"BBD_NOME")
aadd(aCampos,"BBD_TELEFO")
aadd(aCampos,"BBD_TIPO")
aadd(aCampos,"BBD_HORA")
aadd(aCampos,"BBD_MATANT")
aadd(aCampos,"BBD_CODSOL")
aadd(aCampos,"BBD_NOMSOL")
aadd(aCampos,"BBD_OBSERV")
If lBBD_ATERNA//BBD->( FieldPos("BBD_ATERNA") ) > 0
   aadd(aCampos,"BBD_ATERNA")
EndIf	
//If BBD->( FieldPos("BBD_TIPPAC") ) > 0
If lBBD_TIPPAC
   aadd(aCampos,"BBD_TIPPAC")
EndIf	
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Inclui novos campos na enchoice atraves do ponto de entrada PLCAMMAR     
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸    
If ExistBlock("PLCAMMARC")
   aNewCampos := ExecBlock("PLCAMMARC",.F.,.F.)     
   If ValType(aNewCampos) == 'A'
      For nNewCampos :=1 To Len(aNewCampos)    
         aadd(aCampos,aNewCampos[nNewCampos])
      Next
   EndIf   
Endif	

If nOpcao == K_Agenda
	M->BBD_CODPAC 	:= Iif(!Empty(BBO->BBO_CODPAC),BBO->BBO_CODPAC,Space(Len(BBD->BBD_CODPAC)))
	M->BBD_NOME   	:= Iif(!Empty(BBO->BBO_NOME  ),BBO->BBO_NOME  ,Space(Len(BBD->BBD_NOME  )))
	M->BBD_TELEFO 	:= Iif(!Empty(BBO->BBO_TELEFO),BBO->BBO_TELEFO,Space(Len(BBD->BBD_TELEFO)))
	lForcado		:= Iif(!Empty(BBO->BBO_USRFRC),.T.,.F.)       
	
	If lBBD_ATERNA .And. lBBO_ATERNA//BBD->( FieldPos("BBD_ATERNA") ) > 0 .And. BBO->( FieldPos("BBO_ATERNA") ) > 0
		M->BBD_ATERNA := Iif( !Empty(BBO->BBO_ATERNA) ,BBO->BBO_ATERNA,"0" )
	EndIf	                        
	
	If lEncaixe
		M->BBD_TIPO := "4"
	Else
		M->BBD_TIPO := "1"
	Endif
	M->BBD_MATANT 	:= Iif(!Empty(BBO->BBO_MATANT),BBO->BBO_MATANT,Space(Len(BBD->BBD_MATANT)))
	M->BBD_CODSOL 	:= CriaVar("BBD_CODSOL")    
	M->BBD_NOMSOL	:= CriaVar("BBD_NOMSOL")    
	M->BBD_HORA		:= Space(Len(BBD->BBD_HORA))
	M->BBD_OBSERV	:= CriaVar("BBD_OBSERV")
    If lBBD_TIPPAC//BBD->( FieldPos("BBD_TIPPAC") ) > 0 
		M->BBD_TIPPAC   := getNewPar("MV_PLSTPAA","9")//Define o tipo de paciente que sera gravado na guia de internacao.
	EndIf    
Else
	If nOpcao == K_Marcar .or. nOpcao == K_Sair
		M->BBD_CODPAC 	:= aVetMar[1,01]
		M->BBD_NOME   	:= aVetMar[1,02]
		M->BBD_TELEFO 	:= aVetMar[1,03]
		M->BBD_TIPO   	:= aVetMar[1,04]
		M->BBD_MATANT 	:= aVetMar[1,05]    
		M->BBD_CODSOL 	:= aVetMar[1,06]
		M->BBD_NOMSOL	:= aVetMar[1,10]
		M->BBD_OBSERV	:= aVetMar[1,13]
		If lBBD_ATERNA//BBD->( FieldPos("BBD_ATERNA") ) > 0
		   M->BBD_ATERNA := aVetMar[1,14]
		EndIf
		
		If nOpcao == K_Marcar                          
			If !lEncaixe
				M->BBD_HORA		:= aHorAge[oHorarios:nAt,2]
			Else
				M->BBD_HORA		:= Criavar("BBD_HORA")
			Endif
		Else        
			M->BBD_HORA		:= aVetMar[1,7]   // Opcao Sair... restaura hoario original
			dData			:= aVetMar[1,9]
			cHorario		:= StrTran(aVetMar[1,7],":","")
		Endif
	Else
		M->BBD_CODPAC 	:= BBD->BBD_CODPAC
		M->BBD_NOME   	:= BBD->BBD_NOME
		M->BBD_TELEFO 	:= BBD->BBD_TELEFO		
		M->BBD_TIPO   	:= BBD->BBD_TIPO
		M->BBD_MATANT 	:= BBD->BBD_MATANT
		M->BBD_HORA		:= BBD->BBD_HORA
		M->BBD_CODSOL 	:= BBD->BBD_CODSOL
		M->BBD_NOMSOL	:= CriaVar("BBD_NOMSOL")
		M->BBD_OBSERV	:= BBD->BBD_OBSERV
		If lBBD_ATERNA//BBD->( FieldPos("BBD_ATERNA") ) > 0 
		   M->BBD_ATERNA := BBD->BBD_ATERNA
		EndIf	
		If lBBD_TIPPAC//BBD->( FieldPos("BBD_TIPPAC") ) > 0            
	   		M->BBD_TIPPAC	:= BBD->BBD_TIPPAC
		EndIf
	Endif
Endif                     

If nOpcao == K_Remarca
	M->BBD_CODPAC 	:= BBD->BBD_CODPAC
	M->BBD_NOME   	:= BBD->BBD_NOME
	M->BBD_TELEFO 	:= BBD->BBD_TELEFO
	M->BBD_TIPO   	:= BBD->BBD_TIPO
	M->BBD_MATANT 	:= BBD->BBD_MATANT
	M->BBD_HORA		:= BBD->BBD_HORA
	M->BBD_CODSOL 	:= BBD->BBD_CODSOL
	M->BBD_NOMSOL	:= CriaVar("BBD_NOMSOL")
	M->BBD_OBESERV	:= BBD->BBD_OBSERV
	If lBBD_ATERNA//BBD->( FieldPos("BBD_ATERNA") ) > 0 
	   M->BBD_ATERNA := BBD->BBD_ATERNA
	EndIf	
Endif

If nOpcao == K_Cancel
	aadd(aCampos,"BBD_CODCAN")
	aadd(aCampos,"BBD_DESCAN")
	If lBBD_DATCAN//BBD->( FieldPos("BBD_DATCAN") ) > 0
		aadd(aCampos,"BBD_DATCAN")
		M->BBD_DATCAN := CriaVar("BBD_DATCAN")		
	Endif
	M->BBD_CODCAN := CriaVar("BBD_CODCAN")
	M->BBD_DESCAN := CriaVar("BBD_CODCAN")
Endif                 
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// foto...                                                        			 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cPrefFot := ""
@ 070, 162 JPEG oFoto FILENAME cPrefFot+M->BBD_CODPAC+".JPG" OF oDlgRes SIZE 050, 042 NOBORDER WHEN .F. PIXEL     
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta enchoice...                                                        
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If     nOpcao == K_Agenda  .Or.  nOpcao == K_Marcar .or. nOpcao == K_Sair
       nOpcEnc := K_Incluir
ElseIf nOpcao == K_Editar
       nOpcEnc := K_Alterar
ElseIf nOpcao == K_Cancel
       nOpcEnc := K_Alterar
ElseIf nOpcao == K_Remarca
       nOpcEnc := K_Alterar
Endif
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Posiciona no registro do credenciado selecionado...                      
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸 
If nOpcao == K_Marcar .or. nOpcao == K_Sair
	If Len(aVetMar) == 0
		Return(lRet)
	Endif                                          
	BAU->( dbSetorder(01) )
	BAU->( MsSeek(xFilial("BAU")+Left(aVetMar[1,8], Len(BAU->BAU_CODIGO))) )
Else
	BAU->( dbSetorder(01) )
	BAU->( MsSeek(xFilial("BAU")+Left(cCombo, Len(BAU->BAU_CODIGO))) )
Endif

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Enc																		 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
oEnc  := BBD->(MSMGet():New("BBD",5,nOpcEnc,,,,aCampos,{064,003,If(nOpcao==K_Cancel,214,203),215},aCampos,,,,,oDlgRes,,,.T.))
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// No caso da agenda vou alterar o valid do campo BBD_NOME...               
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
For nInd := 1 To Len(oEnc:AENTRYCTRLS)

	If nOpcao # K_Remarca
		If oEnc:AENTRYCTRLS[nInd]:cReadVar == "M->BBD_NOME"
			oEnc:AENTRYCTRLS[nInd]:BLOSTFOCUS := { || lRet := PLSA300APq(M->BBD_NOME,oDlgRes,nTamDlgBrw,aListaUsr,oListaUsr), IF(lRet,PLS300LISUSR(cCodEsp,dData,nTamDlgBrw,aListaUsr,oListaUsr, nOpcao,oEnc, oDlgRes, nDsPer,M->BBD_NOME),Nil) } //IF(lRet,oListaUsr:SetFocus(),Nil) }
		Endif
    Else
		If oEnc:AENTRYCTRLS[nInd]:cReadVar == "M->BBD_NOME"
			oEnc:AENTRYCTRLS[nInd]:BLOSTFOCUS := { || lRet := PLSA300APq(M->BBD_NOME,oDlgMar,nTamDlgBrw,aListaUsr,oListaUsr), IF(lRet,oListaUsr:SetFocus(),nil) }
		Endif
	Endif

	If oEnc:AENTRYCTRLS[nInd]:cReadVar == "M->BBD_HORA"
		If lEncaixe
			oEnc:AENTRYCTRLS[nInd]:BWHEN := { || .T. }
			oEnc:AENTRYCTRLS[nInd]:BVALID := { || PLSA300ENC(M->BBD_HORA,aHorAge,oHorarios,nOpcao) }
		Else		
			oEnc:AENTRYCTRLS[nInd]:BWHEN := { || .F. }
		Endif
		nPosHour := nInd
	Endif	
		                
	If oEnc:AENTRYCTRLS[nInd]:cReadVar == "M->BBD_TIPO"
		If lEncaixe .and. nOpcao <> K_Marcar
			oEnc:AENTRYCTRLS[nInd]:BWHEN := { || .F. }
		Else
			oEnc:AENTRYCTRLS[nInd]:BLOSTFOCUS := { || Iif((M->BBD_TIPO # "4" .and. nOpcao # K_Marcar),(oEnc:AENTRYCTRLS[nPosHour]:BWHEN := { || .F. }),(oEnc:AENTRYCTRLS[nPosHour]:BWHEN := { || .T. },oEnc:AENTRYCTRLS[nPosHour]:BVALID := { || PLSA300ENC(M->BBD_HORA,aHorAge,oHorarios,nOpcao) })) }
		Endif
	Endif
	
	If oEnc:AENTRYCTRLS[nInd]:cReadVar $ "M->BBD_NOME,M->BBD_CODPAC"
		If !Empty(BBO->BBO_CODPAC) .AND. !Empty(BBO->BBO_NOME)
			oEnc:AENTRYCTRLS[nInd]:BWHEN := { || .F. }
		Endif
	Endif 
	
	//na tela de callcenter eu tenho que poder alterar o campo de recem nascido
	//pois o usuario ja bem preenchido 
    If lBBD_ATERNA .and. Funname() <> 'TMKA271' 
		If oEnc:AENTRYCTRLS[nInd]:cReadVar $ "M->BBD_ATERNA"
	   	   oEnc:AENTRYCTRLS[nInd]:BWHEN := { || .F. }
		EndIf   
    EndIf
    
	If nOpcao == K_Cancel
       If lBBD_ATERNA//BBD->( FieldPos("BBD_ATERNA") ) > 0
		  If oEnc:AENTRYCTRLS[nInd]:cReadVar $ "M->BBD_NOME,M->BBD_CODPAC,M->BBD_TELEFO,M->BBD_TIPO,M->BBD_MATANT,M->BBD_CODSOL,M->BBD_ATERNA"
		     oEnc:AENTRYCTRLS[nInd]:BWHEN := { || .F. }
	   	  Endif
		Else 
		  If oEnc:AENTRYCTRLS[nInd]:cReadVar $ "M->BBD_NOME,M->BBD_CODPAC,M->BBD_TELEFO,M->BBD_TIPO,M->BBD_MATANT,M->BBD_CODSOL,M->BBD_TIPPAC"
		     oEnc:AENTRYCTRLS[nInd]:BWHEN := { || .F. }
	   	  Endif
		EndIf	
	Endif
	
	If nOpcao == K_Remarca
       If lBBD_ATERNA//BBD->( FieldPos("BBD_ATERNA") ) > 0
		  If oEnc:AENTRYCTRLS[nInd]:cReadVar $ "M->BBD_NOME,M->BBD_CODPAC,M->BBD_TELEFO,M->BBD_TIPO,M->BBD_MATANT,M->BBD_CODSOL,M->BBD_ATERNA"
		     oEnc:AENTRYCTRLS[nInd]:BWHEN := { || .F. }
		  EndIf   
	   Else
		  If oEnc:AENTRYCTRLS[nInd]:cReadVar $ "M->BBD_NOME,M->BBD_CODPAC,M->BBD_TELEFO,M->BBD_TIPO,M->BBD_MATANT,M->BBD_CODSOL,M->BBD_TIPPAC"
		     oEnc:AENTRYCTRLS[nInd]:BWHEN := { || .F. }
		  EndIf   		     
	   Endif
	Endif
	
	If nOpcao == K_Editar
       If lBBD_ATERNA//BBD->( FieldPos("BBD_ATERNA") ) > 0
		  If oEnc:AENTRYCTRLS[nInd]:cReadVar $ "M->BBD_NOME,M->BBD_CODPAC,M->BBD_TIPO,M->BBD_MATANT,M->BBD_ATERNA"
		     oEnc:AENTRYCTRLS[nInd]:BWHEN := { || .F. }
		  Endif
	   Else
		  If oEnc:AENTRYCTRLS[nInd]:cReadVar $ "M->BBD_NOME,M->BBD_CODPAC,M->BBD_TIPO,M->BBD_MATANT"
		     oEnc:AENTRYCTRLS[nInd]:BWHEN := { || .F. }
		  Endif
	   EndIf	  
	Endif
Next    
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// No caso da agenda vou remarcacao...                                      
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If nOpcao == K_Remarca
	@ 205,040 Say oSay Prompt "F12 - Ver a Familia" Size 100,008 ;
	PIXEL OF oDlgMar FONT oFont01 COLOR CLR_HBLUE
ENDIF
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Ativa o dialogo...                                                       
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If nOpcao == K_Remarca
   ACTIVATE MSDIALOG oDlgMar ON INIT Eval( { || nTamDlgPad := oDlgMar:nBottom, EnChoiceBar(oDlgMar,bokMar,bCancMar,.F.,aButtons) } ) 
ELSE
   ACTIVATE MSDIALOG oDlgRes ON INIT Eval( { || nTamDlgPad := oDlgRes:nBottom, EnChoiceBar(oDlgRes,bOK,bCanc,.F.,aButtons) } ) 
EndIf   
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// inicia transacao na base se confirmado operacao..                        
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If nOpca == K_OK                                                
	//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
	// Reposiciona no registro do credenciado selecionado...                    
	//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
	If nOpcao == K_Marcar .or. nOpcao == K_Sair
		BAU->( dbSetorder(01) )
		BAU->( MsSeek(xFilial("BAU")+Left(aVetMar[1,8], Len(BAU->BAU_CODIGO))) )
	Else
		BAU->( dbSetorder(01) )
		BAU->( MsSeek(xFilial("BAU")+Left(cCombo, Len(BAU->BAU_CODIGO))) )
	Endif
	//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
	// Monta campos e seus conteudos...                                         
	//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
	Begin Transaction

	If nOpcao == K_Agenda .Or. nOpcao == K_Marcar 
	    If nRecBBD > 0
			//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
			// Posiciona																			 
			//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸 
			BBD->( DbGoto(nRecBBD) )
			//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
			// Verifica se a agenda e para um horario que foi cancelado e deleta o cancelamento	 
			//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸 
			If !Empty( BBD->BBD_CODCAN )
				BHY->( DbSetOrder(1) ) //BHY_FILIAL + BHY_CODIGO + BHY_CODINT + BHY_CODLOC + DTOS(BHY_DATA) + BHY_HORA
				If BHY->( MsSeek( xFilial("BHY")+BBD->(BBD_CODIGO+BBD_CODINT+BBD_CODLOC+DtoS(BBD_DATA)+BBD_HORA) ) ) 
				   BHY->( Reclock("BHY",.F.) )
				   	 BHY->( DbDelete() )  
				   BHY->( msUnlock() ) 
		        EndIf            
				//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
				// Deleta o agendamento																 
				//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸 
		    	BBD->( Reclock("BBD",.F.) )
					BBD->( DbDelete() )  
				BBD->( msUnlock() ) 
	        EndIf
	    EndIf
		BA1->(DbSetOrder(2))
		BA1->(MsSeek(xFilial("BA1")+AllTrim(M->BBD_CODPAC)))
		
		aadd(aDadBBD,{"BBD_CODEMP",BA1->BA1_CODEMP})
		aadd(aDadBBD,{"BBD_CONEMP",BA1->BA1_CONEMP})
		aadd(aDadBBD,{"BBD_VERCON",BA1->BA1_VERCON})
		aadd(aDadBBD,{"BBD_SUBCON",BA1->BA1_SUBCON})
		aadd(aDadBBD,{"BBD_VERSUB",BA1->BA1_VERSUB})
		aadd(aDadBBD,{"BBD_HORCAN",""} )
		aadd(aDadBBD,{"BBD_CODCAN",""} )
		If lBBD_DATCAN//BBD->( FieldPos("BBD_DATCAN") ) > 0					
		   aadd(aDadBBD,{"BBD_DATCAN",Ctod('')} )
		Endif                                        		
		aadd(aDadBBD,{"BBD_CODIGO",BAU->BAU_CODIGO})
		aadd(aDadBBD,{"BBD_CODINT",cCodInt})
		aadd(aDadBBD,{"BBD_DATA"  ,dData})
		aadd(aDadBBD,{"BBD_TIPO"  ,M->BBD_TIPO})	
		If ( M->BBD_TIPO # "4" ) .And. ! lEncaixe
			aadd(aDadBBD,{"BBD_STATUS","1"})
			If Type("M->BBD_HORA") == "C" .And. ! Empty(M->BBD_HORA)
   			   aadd(aDadBBD,{"BBD_HORA"  ,M->BBD_HORA})
			Else
			   aadd(aDadBBD,{"BBD_HORA"  ,TransForm(cHorario,cPictPad)})
			Endif
			aadd(aDadBBD,{"BBD_ENCAIX","0"})
		Else
			aadd(aDadBBD,{"BBD_STATUS","1"})
			aadd(aDadBBD,{"BBD_ENCAIX","1"})
			aadd(aDadBBD,{"BBD_HORA"  ,M->BBD_HORA})
		Endif		
		aadd(aDadBBD,{"BBD_PRTATD","0"})
		aadd(aDadBBD,{"BBD_CODESP",cComboEsp})
		aadd(aDadBBD,{"BBD_CODLOC",Eval(bCodLoc)})
		aadd(aDadBBD,{"BBD_LOCAL",Subs(cLocal,1,3)})
		aadd(aDadBBD,{"BBD_SIGLA",BAU->BAU_SIGLCR})
		aadd(aDadBBD,{"BBD_NUMREG",BAU->BAU_CONREG})
		aadd(aDadBBD,{"BBD_ESTCR",BAU->BAU_ESTCR})
		aadd(aDadBBD,{"BBD_CODPRF",BAU->BAU_CODBB0})
		aadd(aDadBBD,{"BBD_CODPAC",M->BBD_CODPAC})
		aadd(aDadBBD,{"BBD_NOME",M->BBD_NOME})
		aadd(aDadBBD,{"BBD_TELEFO",M->BBD_TELEFO})
		aadd(aDadBBD,{"BBD_USUOPE",PLRETOPE()})
		aadd(aDadBBD,{"BBD_MATANT",M->BBD_MATANT})
		aadd(aDadBBD,{"BBD_MATVID",BA1->BA1_MATVID})
		aadd(aDadBBD,{"BBD_CODSOL",M->BBD_CODSOL})
		aadd(aDadBBD,{"BBD_INIATE",cTimeIni})		
		aadd(aDadBBD,{"BBD_FIMATE",Time()})
		aadd(aDadBBD,{"BBD_DATDIG",Date()})
		aadd(aDadBBD,{"BBD_OBSERV",M->BBD_OBSERV})
		If lBBD_ATERNA//BBD->( FieldPos("BBD_ATERNA") ) > 0
		   aadd(aDadBBD,{"BBD_ATERNA",M->BBD_ATERNA})
		EndIf	
		If lBBD_TIPPAC//BBD->( FieldPos("BBD_TIPPAC") ) > 0
		   aadd(aDadBBD,{"BBD_TIPPAC",M->BBD_TIPPAC})
		EndIf	
		//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
		// Caso tenha sido uma autorizacao forcada, gravo o usuario...              
		//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸 
		If lForcaPro
			aadd(aDadBBD,{"BBD_USRFRC",aAutFor[Len(aAutFor),09]})       
			aadd(aDadBBD,{"BBD_OBSFRC",aAutFor[Len(aAutFor),12]})
		Else
			aadd(aDadBBD,{"BBD_OBSFRC",' '})
		Endif
		//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
		// Grava procedimento utilizado...                                          
		//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸		
		If BBD->( FieldPos("BBD_CODPAD") ) > 0 .and. BBD->( FieldPos("BBD_CODPRO") ) > 0
			aadd(aDadBBD,{"BBD_CODPAD",Left(cCodPro,2)})
			aadd(aDadBBD,{"BBD_CODPRO",Substr(cCodPro,3,16)})
        Endif
       	//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
		// Grava campos retornados pelo Ponto de Entrada PLCAMMARC                  
		//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸              
		If ExistBlock("PLCAMMARC")
           If ValType(aNewCampos) == 'A'
               For nNewCampos :=1 To Len(aNewCampos)    
                  aadd(aDadBBD,{aNewCampos[nNewCampos],M->&(aNewCampos[nNewCampos])})
               Next
           EndIf   
        Endif	
        
		PLSAtuAge(aDadBBD)
		//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
		// Zera array de remarcacao...                                              
		//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸 
		aVetMar := {}
		
		lRet := .T.
	Elseif nOpcao == K_Sair
		//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
		// Posiciona																			 
		//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸 
		BBD->( DbGoto(aVetMar[1,11]) )
		//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
		// Verifica se a agenda e para um horario que foi cancelado e deleta o cancelamento	 
		//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸 
		If !Empty( BBD->BBD_CODCAN )
			BHY->( DbSetOrder(1) ) //BHY_FILIAL + BHY_CODIGO + BHY_CODINT + BHY_CODLOC + DTOS(BHY_DATA) + BHY_HORA
			If BHY->( MsSeek( xFilial("BHY")+BBD->(BBD_CODIGO+BBD_CODINT+BBD_CODLOC+DtoS(BBD_DATA)+BBD_HORA) ) ) 
			   BHY->( Reclock("BHY",.F.) )
			   	 BHY->( DbDelete() )  
			   BHY->( msUnlock() ) 
	        EndIf
        EndIf
		//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
		// Altera o Horario																	 
		//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸 
		BBD->( Reclock("BBD",.F.) )
			If M->BBD_TIPO # "4" .And. ! lEncaixe
				BBD->BBD_STATUS	:= '1'
				BBD->BBD_ENCAIX	:= '0'
				BBD->BBD_HORA	:= TransForm(cHorario,cPictPad)
			Else
				BBD->BBD_STATUS	:= '1'
				BBD->BBD_ENCAIX	:= '1' 
				BBD->BBD_HORA 	:= M->BBD_HORA
			Endif		
			BBD->BBD_HORCAN := ''
			BBD->BBD_CODCAN	:= ''
			If lBBD_DATCAN//BBD->( FieldPos("BBD_DATCAN") ) > 0					
			   BBD->BBD_DATCAN := Ctod('')
			Endif               
			If lBBD_ATERNA//BBD->( FieldPos("BBD_ATERNA") ) > 0
			   BBD->BBD_ATERNA := "0"
			EndIf	
		BBD->( msUnlock()) 
		//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
		// Zera array de remarcacao...                                              
		//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸 
		aVetMar := {}
				
		lRet := .T.
	Else
		If nOpcao == K_Editar
			BBD->(RecLock("BBD",.F.))
				BBD->BBD_CODPAC := M->BBD_CODPAC
				BBD->BBD_NOME   := M->BBD_NOME
				BBD->BBD_TELEFO := M->BBD_TELEFO
				BBD->BBD_TIPO   := M->BBD_TIPO
				BBD->BBD_MATANT := M->BBD_MATANT
				BBD->BBD_CODSOL := M->BBD_CODSOL
				BBD->BBD_OBSERV := M->BBD_OBSERV
				If lBBD_ATERNA//BBD->( FieldPos("BBD_ATERNA") ) > 0
				   BBD->BBD_ATERNA := M->BBD_ATERNA
				EndIf	
			    If lBBD_TIPPAC//BBD->( FieldPos("BBD_TIPPAC") ) > 0
					BBD->BBD_TIPPAC := M->BBD_TIPPAC
				EndIf
				//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
		        // Grava campos retornados pelo Ponto de Entrada PLCAMMARC                  
		        //읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸              
		        If ExistBlock("PLCAMMARC")
                   If ValType(aNewCampos) == 'A'
                      For nNewCampos :=1 To Len(aNewCampos)    
                         BBD->&(aNewCampos[nNewCampos]) := M->&(aNewCampos[nNewCampos])
                      Next
                   EndIf   
                Endif	
			BBD->(MsUnLock())
		Else
			If nOpcao <> K_Remarca .and. nOpcao <> K_Sair .Or. nOpcao == K_Marcar
				aadd(aDadBHY,{"BHY_CODIGO",BBD->BBD_CODIGO})
				aadd(aDadBHY,{"BHY_CODINT",BBD->BBD_CODINT})
				aadd(aDadBHY,{"BHY_DATA"  ,BBD->BBD_DATA})
				aadd(aDadBHY,{"BHY_HORA"  ,BBD->BBD_HORA})
				aadd(aDadBHY,{"BHY_TIPO"  ,BBD->BBD_TIPO})
				aadd(aDadBHY,{"BHY_ENCAIX",BBD->BBD_ENCAIX})
				aadd(aDadBHY,{"BHY_PRTATD",BBD->BBD_PRTATD})
				aadd(aDadBHY,{"BHY_CODESP",BBD->BBD_CODESP})
				aadd(aDadBHY,{"BHY_CODLOC",BBD->BBD_CODLOC})
				aadd(aDadBHY,{"BHY_LOCAL",BBD->BBD_LOCAL})
				aadd(aDadBHY,{"BHY_SIGLA",BBD->BBD_SIGLA})
				aadd(aDadBHY,{"BHY_NUMREG",BBD->BBD_ESTCR})
				aadd(aDadBHY,{"BHY_ESTCR",BBD->BBD_ESTCR})
				aadd(aDadBHY,{"BHY_CODPRF",BBD->BBD_CODPRF})
				aadd(aDadBHY,{"BHY_CODPAC",BBD->BBD_CODPAC})
				aadd(aDadBHY,{"BHY_NOME",BBD->BBD_NOME})
				aadd(aDadBHY,{"BHY_USUOPE",BBD->BBD_USUOPE})
				aadd(aDadBHY,{"BHY_CODCAN",M->BBD_CODCAN})
				aadd(aDadBHY,{"BHY_CODSOL",M->BBD_CODSOL})
				PLSCanAge(aDadBHY)
				
				BBD->(RecLock("BBD",.F.))
				If nOpcao <> K_Cancel
					BBD->BBD_STATUS := '7'
				Else
					BBD->BBD_STATUS := '7'
					BBD->BBD_CODCAN	:= M->BBD_CODCAN
				    BBD->BBD_HORCAN	:= Left(Time(),5)
					If lBBD_DATCAN//BBD->( FieldPos("BBD_DATCAN") ) > 0					
						BBD->BBD_DATCAN := M->BBD_DATCAN
					Endif
					If BBD->( FieldPos("BBD_USUCAN") ) > 0
						BBD->BBD_USUCAN := PLRETOPE()	
					Endif					
					//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
	             	// Grava campos retornados pelo Ponto de Entrada PLCAMMARC                  
		            //읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸              
		            If ExistBlock("PLCAMMARC")
                       If ValType(aNewCampos) == 'A'
                          For nNewCampos :=1 To Len(aNewCampos)    
                             BBD->&(aNewCampos[nNewCampos]) := M->&(aNewCampos[nNewCampos])
                          Next
                       EndIf   
                    Endif						
				Endif
				BBD->(MsUnLock())
			Endif
		Endif
		lRet := .T.		
	Endif
	End Transaction

	If ExistBlock("PLS300AGF")
		ExecBlock("PLS300AGF",.F.,.F., {nOpcao} )
	Endif	

	Eval(bVetAge)
	oHorarios:Setarray(aHorAge)
	oHorarios:Refresh()
Endif
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Quanto a permanencia do usuario selecionado...                           
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸 
If nOpcao == K_Agenda
	If Aviso(STR0081,STR0082,{STR0083,STR0084}) == 1 //"Usuario selecionado..."###"Deseja manter o usuario selecionado?"###"&No"###"&Sim"
		A300CLSUSR()
	Endif
Endif

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Controle de transacao...                                                 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
FCLOSE(nH)   
Ferase(cFile)                                                                
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Restaura dados...                                                        
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
aTela := aOldTela
aGets := aOldGets               
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Devolve o foco...                                                        
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
oHorarios:SetFocus()
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Fim da Rotina...                                                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
Return(lRet)

/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴藁袴袴袴錮袴袴袴袴袴袴袴袴袴袴箇袴袴錮袴袴袴袴袴袴敲굇
굇튡rograma  쿌300VLDSEL튍utor  쿒eraldo Felix Junior Data   06/13/07   볍
굇勁袴袴袴袴曲袴袴袴袴袴姦袴袴袴鳩袴袴袴袴袴袴袴袴袴菰袴袴袴鳩袴袴袴袴袴袴묽
굇튒esc.     쿣alida a confirmacao da agenda medica...                    볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴선
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Static Function A300VLDSEL(nOpca, lEncaixe, aGets, aTela, nOpcao, aHorAge, dData, cCodEsp,;
							nDsPer, oEnc, lMarcar, oDlgRes, cCodLoc)
LOCAL aRet := {}

// Conteudo inicial da variavel de controle eh 3, que significa negado.            
nOpca:=3
If !Obrigatorio(aGets,aTela)
	Return(.F.)
Endif
	
If lEncaixe .And. Empty(M->BBD_HORA)
	MsgInfo(STR0085) //"A hora e obrigatorio para encaixes."
	Return(.F.)
Endif

If (lEncaixe .And. (M->BBD_HORA < Left(Time(),5) .And. M->BBO_DATA==Date())) .Or. M->BBD_HORA>"23:59"
	MsgStop(STR0086) //"Hora invalida. Informe um horario valido!"
	Return(.F.)
Endif	
                   
If nOpcao==K_Agenda  
	If !lEncaixe
		lRet := A300VldAge(dData) //Chama validacao da agenda
		If !lRet
			Return(.F.)
		EndIf
	EndIf

	If M->BBD_TIPO <> '2'
		If !VerifBrw(aHorAge,3,7,M->BBD_CODPAC,STR0087) //"Paciente ja agendado nesta data"
			Return(.F.)
		Endif

		aRet := PLSA300CAR(M->BBD_CODPAC,Iif(lBBD_ATERNA/*BBD->( FieldPos("BBD_ATERNA") )>0*/,M->BBD_ATERNA,"0"),,cCodLoc,cCodEsp)
		lRet := Iif( ValType(aRet[1]) == 'L', aRet[1], .F.)
		If !lRet
			// Se criticar por periodicidade, o encaixe pode ser marcado como revisao.
			If (Len(aRet[2]) > 0 .and. aRet[2][1][1] == '018')
				If lEncaixe
				   cMSG := "Deseja marcar o encaixe como REVIS홒?"
				Else
   				   cMSG := "Deseja marcar a agenda como REVIS홒?"
				Endif   
				If Aviso("Reviso",cMSG, {"Sim","No"}) == 2
					Return(.F.)
				Else
					M->BBD_TIPO := '2'
				Endif
			Else
				Return(.F.)
			Endif
		Endif
		
		If M->BBD_TIPO <> '2'
			If !PLSA300TPe(M->BBD_CODPAC,dData,cCodEsp,nDsPer,oEnc:oBox)
				Return(.F.)
			Endif
		Endif
	Else
		aRet := PLSA300CAR(M->BBD_CODPAC,Iif(lBBD_ATERNA/*BBD->( FieldPos("BBD_ATERNA") )>0*/,M->BBD_ATERNA,"0"),,cCodLoc,cCodEsp,.F.)
		lRet := Iif( ValType(aRet[1]) == 'L', aRet[1], .F.)
        
		// Se for autorizado, ou se a critica for diferente da periodicidade, nao permite agendar retorno.
		If lRet .or. (!lRet .and. Len(aRet[2]) > 0 .and. aRet[2][1][1] <> '018')
			BR8->( dbSetorder(01) )
			If BR8->( MsSeek(xFilial("BR8")+BBD->BBD_CODPAD+BBD->BBD_CODPRO) )
				cDesPro := Alltrim(BR8->BR8_DESCRI)
			Endif
	
			nOpcao := Aviso(STR0088, STR0092,; //"Reviso"###"No ser possvel marcar o retorno porque no existe consulta realizada no perodo mnimo."
						{STR0093}) //"Retornar"
                                                         
			Return(.F.)
		Endif		
	Endif
Endif 		

If nOpcao == K_Marcar
	lRet := A300VldAge(dData)		//Chama validacao da agenda se for marcacao
	If !lRet
		Return(.F.)
	EndIf
EndIf

// Conteudo inicial da variavel...
nOpca := 1
lMarcar := .T.

Return(.T.)

/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴藁袴袴袴錮袴袴袴袴袴袴袴袴袴袴箇袴袴錮袴袴袴袴袴袴敲굇
굇튡rograma  쿛LSA300   튍utor  쿘icrosiga            Data   04/06/03   볍
굇勁袴袴袴袴曲袴袴袴袴袴姦袴袴袴鳩袴袴袴袴袴袴袴袴袴菰袴袴袴鳩袴袴袴袴袴袴묽
굇튒esc.                                                                 볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴선
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Static Function PLSA300DAT(cTipo,oEnc,bFiltro,nDsPes,dData, lStart)
LOCAL dAux       
LOCAL nInd
LOCAL dOldData
LOCAL lRet := .F.                          
DEFAULT lStart := .F.
                                  
If lStart
	If Eval(bFiltro)
		M->BBO_DIASEM := PLSDIASEM(dData)
		oEnc:oBox:Refresh()
		lRefresh := .T.
		Return(.T.)
	Endif
Endif
    	    
If Empty(dData)
   dData := Date()
   dOldData := dData
   dAux     := dData 
Else
   dAux := dData
   dOldData := dData
   dAux := IF((cTipo=="1" .or. cTipo=="4"),(dAux+1),(dAux-1))
Endif   

For nInd := 1 To nDsPes   
	lMove := .T.
    If dtos(dAux) < dtos(Date())
       Exit
    Endif                                                

    M->BBO_DATA	:= dAux
    lRet		:= Eval(bFiltro)
    
    If lRet 
       M->BBO_DIASEM := PLSDIASEM(dAux)
       oEnc:oBox:Refresh()
       lRefresh := .T.       
       Exit
    Endif  
                          
    If cTipo > "2"
    	Exit
    Endif
    
    dAux := IF((cTipo=="1" .or. cTipo=="4"),(dAux+1),(dAux-1))
Next

If ! lRet .and. cTipo < "3"
   M->BBO_DATA   := dOldData
   Aviso(STR0094,STR0095,{"Ok"}) //"Indisponivel"###"Nao existe agenda disponivel para o filtro informado."
Else
    If dtos(dAux) >= dtos(Date())
	   M->BBO_DIASEM := PLSDIASEM(dAux)
	EndIf   
   oEnc:oBox:Refresh()
   lRefresh := .T.
Endif    

Return(lRet)

/*/
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇旼컴컴컴컴컫컴컴컴컴컴컴쩡컴컴컴쩡컴컴컴컴컴컴컴컴컴컫컴컴컴쩡컴컴컴컴커굇
굇쿑uncao     PLSA300PQ   Autor 쿒eraldo Felix Junior Data  18.12.01 낢
굇쳐컴컴컴컴컵컴컴컴컴컴컴좔컴컴컴좔컴컴컴컴컴컴컴컴컴컨컴컴컴좔컴컴컴컴캑굇
굇쿏escricao  Pesquisa a agenda na base de dados...                     낢
굇쳐컴컴컴컴컨컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴캑굇
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
/*/
Function PLSA300Pq(cNomPac,aBrowPac,aVetPad,oBrowPac)
LOCAL cSQL  
LOCAL cNmMed
LOCAL dDt
LOCAL cNReduz	:= ''
LOCAL cNomTit	:= ''
LOCAL cNomSol	:= ''
LOCAL cDesLocal	:= ''
LOCAL cDesEsp	:= ''
LOCAL aArea		:= GetArea()
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Limpa resultado...                                                       
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
aBrowPac := {}
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Efetua busca...                                                          
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL := " SELECT BBD_CODINT, BBD_FILIAL, BBD_CODPAC, BBD_NOME, BBD_HORA, BBD_DATA, BBD_CODIGO, BBD_CODESP, BBD_CODSOL, " 
cSQL += " BBD_LOCAL, BBD_CODLOC, BBD_USUOPE, R_E_C_N_O_ AS REGBBD FROM "+RetSQLName("BBD")
cSQL += " WHERE BBD_FILIAL = '"+xFilial("BBD")+"' "
cSQL += "   AND BBD_CODCAN = '' "
cSql += "   AND BBD_TIPOPA = '' "
cSQL += "   AND BBD_NOME LIKE '%"+AllTrim(cNomPac)+"%' "  
cSQL += "   AND BBD_DATA   >= '"+dtos(dDataBase)+"' "
cSQL += "   AND D_E_L_E_T_ = ' ' "
cSQL += " ORDER BY BBD_FILIAL,BBD_NOME,BBD_DATA,BBD_HORA "
                                        
PLSQuery(cSQL,"TrbPes")
TrbPes->(DbGoTop())

While ! TrbPes->(Eof())

	dDt    := TrbPes->BBD_DATA
	dDt    := dtoc(dDt) + " ("+PLSDIASEM(dDt)+")"
	
	BAU->( dbSetorder(01) )
	BAU->( MsSeek(xFilial("BAU")+TrbPes->BBD_CODIGO) )
	If !Empty(BAU->BAU_LEGEND)
		cNmMed := AllTrim(X3COMBO("BAU_LEGEND",BAU->BAU_LEGEND))+". "
	Else
		cNmMed := ''
	Endif
	cNmMed += AllTrim(BAU->BAU_NOME)
                                   
	cDesLocal 	:= Posicione("BD1",1, xFilial("BD1")+TrbPes->BBD_CODINT+TrbPes->BBD_LOCAL, "BD1_DESLOC" )
	cDesEsp		:= Posicione("BAQ",1, xFilial("BAQ")+TrbPes->BBD_CODINT+TrbPes->BBD_CODESP, "BAQ_DESCRI" )
		
	cNReduz:= Posicione("BA1",2,xFilial("BA1")+TrbPes->BBD_CODPAC,"BA1_NREDUZ")
	If Empty(cNReduz)
	   BA3->( DbSetOrder(01) )
   	   BA3->( MsSeek(xFilial("BA3")+BA1->(BA1_CODINT+BA1_CODEMP+BA1_MATRIC)) )
	   cNReduz := Posicione("BG9",1,xFilial("BG9")+BA3->(BA3_CODINT+BA3_CODEMP+BA3_TIPOUS),"BG9_NREDUZ")
	EndIf
	cNomTit:= Posicione("BA1",2,xFilial("BA1")+Substr(TrbPes->BBD_CODPAC,1, 14)+GetNewPar("MV_PLCDTGP","01"),"BA1_NOMUSR")//Codigo do Grau de Parentesco do Titular
	cNomSol:= Iif(TrbPes->BBD_CODSOL == '999999','PACIENTE',TrbPes->BBD_CODSOL+'-'+;
			  Posicione("BAU",1,xFilial("BAU")+TrbPes->BBD_CODSOL,"BAU_NOME"))
		
	TrbPes->(aadd(aBrowPac,{BBD_NOME,;	
							 dDt,;
							 BBD_HORA,;
							 cNmMed,;
							 cDesEsp,;
							 cDesLocal,;
							 REGBBD,;
							 BBD->BBD_MATANT,;
							 REGBBD,;
							 cNReduz,;
							 cNomTit,;
							 TrbPes->BBD_CODPAC,;
							 TrbPes->BBD_USUOPE,;
							 cNomSol}))
	TrbPes->(DbSkip())
Enddo
      
TrbPes->(DbCloseArea())
RestArea(aArea)
DbSelectArea("BA1")
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Testa resultado da pesquisa...                                           
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If Len(aBrowPac) == 0
   aBrowPac := aClone(aVetPad)
Endif       
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Atualiza browse...                                                       
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
oBrowPac:SetArray(aBrowPac)
oBrowPac:Refresh()
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Fim da Rotina...                                                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
Return(.T.)
                                
/*/
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇旼컴컴컴컴컫컴컴컴컴컴컴쩡컴컴컴쩡컴컴컴컴컴컴컴컴컴컫컴컴컴쩡컴컴컴컴커굇
굇쿑uncao     PLSA300MAR  Autor 쿒eraldo Felix Junior Data  18.09.02 낢
굇쳐컴컴컴컴컵컴컴컴컴컴컴좔컴컴컴좔컴컴컴컴컴컴컴컴컴컨컴컴컴좔컴컴컴컴캑굇
굇쿏escricao  Executa a funcao de remarcacao de consulta.               낢
굇쳐컴컴컴컴컨컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴캑굇
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
/*/
Static Function PLS300MAR(dData, cMedico, oHorarios)

LOCAL lRet := .T.
LOCAL cMotBlo := GetNewPar("MV_PLSREMR",'01')//Codigo do motivo de bloqueio utilizado na remarcacao de consultas

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Alimenta matriz com dados da origem para o caso de estorno...            
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸           
lMarcar := .F.
aVetMar := {}
aadd(aVetMar,{M->BBD_CODPAC,;
			  M->BBD_NOME,;
			  M->BBD_TELEFO,;
			  M->BBD_TIPO,;
			  M->BBD_MATANT, ;
			  M->BBD_CODSOL, ;
			  M->BBD_HORA, ;
			  cMedico, ;
			  dData,;
			  M->BBD_NOMSOL,;
			  oHorarios:aArray[oHorarios:nAt,6],;
			  oHorarios:aArray[oHorarios:nAt,9],;
			  M->BBD_OBSERV,;
			  Iif(lBBD_ATERNA/*BBD->( FieldPos("BBD_ATERNA") ) > 0*/,M->BBD_ATERNA,"0") })

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Fixa dados do paciente no filtro da rotina...                            
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
BBO->(RecLock("BBO",.F.))
	BBO->BBO_CODPAC	:= M->BBD_CODPAC
	BBO->BBO_NOME	:= M->BBD_NOME                        
	BBO->BBO_MATANT	:= M->BBD_MATANT
	BBO->BBO_TELEFO	:= M->BBD_TELEFO                                       
	If lBBD_ATERNA .And. lBBO_ATERNA //BBD->( FieldPos("BBD_ATERNA") ) > 0 .And. BBO->( FieldPos("BBO_ATERNA") ) > 0
	   BBO->BBO_ATERNA := M->BBD_ATERNA
	EndIf   
	BBO->BBO_USRFRC := BBD->BBD_USRFRC
	BBO->BBO_CODCRE := BAU->BAU_CODIGO
	M->BBO_CODCRE	:= BAU->BAU_CODIGO
	M->BBO_NOMCRE	:= BAU->BAU_NOME	
BBO->(MSUnlock())

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Atualiza dados na tela...                                                
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
oSay1:Refresh()
oSay2:Refresh()
oSay3:Refresh()
oSay4:Refresh()
If lBBO_ATERNA//BBO->( FieldPos("BBO_ATERNA") ) > 0
   oSay5:Refresh()
EndIf   

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Cancela consulta original...                                             
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸	          
BBD->(RecLock("BBD",.F.))
	BBD->BBD_STATUS := '7'                          
	BBD->BBD_CODCAN := cMotBlo
	BBD->BBD_HORCAN := Left(Time(),5)
	If lBBD_DATCAN//BBD->( FieldPos("BBD_DATCAN") ) > 0
		BBD->BBD_DATCAN := Date()
	Endif
BBD->(MSUnlock())

Return(lRet)

/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴藁袴袴袴錮袴袴袴袴袴袴袴袴袴袴箇袴袴錮袴袴袴袴袴袴敲굇
굇튡rograma  쿛LSA300FAM튍utor  쿒eraldo Felix Junior Data   09/04/03   볍
굇勁袴袴袴袴曲袴袴袴袴袴姦袴袴袴鳩袴袴袴袴袴袴袴袴袴菰袴袴袴鳩袴袴袴袴袴袴묽
굇튒esc.      Mostrar a familia do usuario posicionado.                  볍
굇튧so        Marcacao de consultas.                                     볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴선
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Function PLSA300FAM(cChave)
LOCAL cSql
LOCAL oSyFam
LOCAL oGrpFam
LOCAL oSyEmp
LOCAL oGrpEmp
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
// Usuarios...                                                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
LOCAL oBrwusr
LOCAL aCabUsr  	:= {}
LOCAL aDadUsr  	:= {}
LOCAL aTrbUsr  	:= {}

LOCAL cMatFam   := ''
LOCAL cNomTit   := ''

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
// Monta a aHeader dos usuarios da familia                             
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
Store Header "BA1" TO aCabUsr FOR SX3->(X3_CAMPO $ "BA1_MATUSU" .or.;
										 X3_CAMPO $ "BA1_NOMUSR"  .or.;
										 X3_CAMPO $ "BA1_DESUSU" .or.;
										 X3_CAMPO $ "BA1_TELEFO" .or.;
										 X3_CAMPO $ "BA1_DESGRA" )      
										 
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
// Posiciona usuario...                                                
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴										 										 
cChave  := StrTran(StrTran(cChave,'.',''),'-','')
cCodInt := Substr(cChave, atCodOpe[1], atCodOpe[2])
cCodEmp := Substr(cChave, atCodEmp[1], atCodEmp[2])
cMatric := Substr(cChave, atMatric[1], atMatric[2])

BA1->(DbSetOrder(2))
If ! BA1->(MsSeek(xFilial("BA1")+cCodInt+cCodEmp+cMatric))
	MsgAlert(STR0096+cChave) //"Usuario nao encontrado:"
	Return()
Endif

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
// Monta matricula da familia do usuario...                            
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
cMatFam := BA1->( BA1_CODINT + BA1_CODEMP + BA1_MATRIC )
                                                
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
// Posiciona familia...                                                
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
BA3->( dbSetorder(01) )
If ! BA3->( MsSeek(xFilial("BA3")+BA1->(BA1_CODINT+BA1_CODEMP+BA1_MATRIC)) )
	MsgAlert( STR0097+BA1->(BA1_CODINT+BA1_CODEMP+BA1_MATRIC) ) //"Familia nao encontrada:"
	Return()
Endif	      

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
// Fixa o nome do titular da familia...                                
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
cNomTit := BA1->BA1_NOMUSR
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
// Monta a GetDados com os usuarios da familia                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
Store COLS "BA1" TO aDadUsr FROM aCabUsr VETTRAB aTrbUsr While xFilial("BA1")+cMatFam == BA1->(BA1_FILIAL+BA1_CODINT+BA1_CODEMP+BA1_MATRIC)
	
DEFINE MSDIALOG oDlgFam TITLE Alltrim(cNomTit) FROM 019.5,001 TO 37, 100 

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
// Monta o Browse dos Usuarios                                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
@ 033,002 GROUP oGrpFam TO 050, 390 PIXEL OF oDlgFam LABEL STR0098 COLOR CLR_HBLUE, CLR_HRED //" Familia de "
@ 040,008 Say oSyFam Prompt Alltrim(cNomTit) Size 150,008 PIXEL OF oDlgFam COLOR CLR_HBLUE

oBrwUsr            := TPLSBrw():New(055,002,390,125,nil  ,oDlgFam,nil    , nil ,nil    ,nil  , nil, .T.  ,nil   ,.T.   ,nil   ,aCabUsr ,aDadUsr ,.T.      ,"BA1" ,K_Visualizar,STR0099,{{"BA1_MOTBLO","<>","''"}},nil,nil,aTrbuSR) //"Usuarios"

ACTIVATE MSDIALOG oDlgFam ON INIT Eval({||EnChoiceBar(oDlgFam,{||oDlgFam:End()},{||oDlgFam:End()},.F.)} )

Return()

/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴藁袴袴袴錮袴袴袴袴袴袴袴袴袴袴箇袴袴錮袴袴袴袴袴袴敲굇
굇튡rograma  쿛LSA300LISUSR     쿒eraldo Felix Junior Data   29/04/03   볍
굇勁袴袴袴袴曲袴袴袴袴袴姦袴袴袴鳩袴袴袴袴袴袴袴袴袴菰袴袴袴鳩袴袴袴袴袴袴묽
굇튒esc.      Novo conceito na listagem de pacientes.                    볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴선
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Function PLS300LISUSR(cCodEsp,dData,nTamDlgBrw,aListaUsr,oListaUsr,;
                             nOpcao,oEnc,oDlgRes,nDsPer,cNome,lDireto) //,cCodSubEsp)
                             
LOCAL bOk := { || If(PLSA300TPe(aListaUsr[oListaUsr:nAt,2],dData,cCodEsp,nDsPer,;
oEnc:oBox, lDireto),(cChave := aListaUsr[oListaUsr:nAt,2], cChave := StrTran(cChave,".",""),;
 cChave := StrTran(cChave,"-",""), M->BBO_NOME := IF(Empty(aListaUsr[oListaUsr:nAt,1]),;
 M->BBO_NOME,aListaUsr[oListaUsr:nAt,1])    , ;
 M->BBO_NOMEMP := Iif(Empty(aListaUsr[oListaUsr:nAt,1]),M->BBO_NOMEMP,Alltrim(aListaUsr[oListaUsr:nAt,8])),;
 M->BBO_CODPAC := IF(Empty(cChave),M->BBO_CODPAC,cChave) , ;
 M->BBO_TELEFO := aListaUsr[oListaUsr:nAt,3], M->BBO_MATANT := IF(Empty(aListaUsr[oListaUsr:nAt,6]),;
 M->BBO_MATANT,aListaUsr[oListaUsr:nAt,6]),     ;
 lRefresh := .T., oDlgRes:Refresh(), oEnc:oBox:SetFocus(),oDlgUsu:End()),oDlgUsu:End()) }
 
 LOCAL aButtons := {}
                     
 DEFAULT lDireto  := .F.
 
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Tecla de Atalho para visualizar a Familia do usuario posicionado.        
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If Empty(cNome)
	Return()
Endif
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define botao...                                                          
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
Aadd(aButtons, {"BMPGROUP"   ,{|| PLSA300FAM(aListaUsr[oListaUsr:nAt,2],,aListaUsr[oListaUsr:nAt,1],aListaUsr[oListaUsr:nAt,8],cCodEsp,dData,nTamDlgBrw,aListaUsr,oListaUsr,nOpcao,oEnc,oDlgRes,nDsPer) },STR0100,STR0101} ) //"Visualizar Familia - <CTRL + A>"###"Familia"
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define o CTRL+A...                                                       
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
SetKey(VK_LBUTTON,{||PLSA300FAM(aListaUsr[oListaUsr:nAt,2],,aListaUsr[oListaUsr:nAt,1],aListaUsr[oListaUsr:nAt,8],cCodEsp,dData,nTamDlgBrw,aListaUsr,oListaUsr,nOpcao,oEnc,oDlgRes,nDsPer)})
                           
DEFINE MSDIALOG oDlgUsu TITLE STR0099 FROM 018,005 TO 28, 100 OF oDlgRes //"Usuarios"

oListaUsr := TcBrowse():New( If(nOpcao==K_Cancel,180,013), 002, 372, 062,,,, oDlgUsu,,,,,,,,,,,, .F.,, .T.,, .F., )
oListaUsr:SetArray(aListaUsr)

//ADD COLUMN TO oListaUsr BITMAP DATA IF(!Empty(aListaUsr[olistaUsr:nAt,5]),LoadBitmap( GetResources(), "ENABLE" ),LoadBitmap( GetResources(), "DISABLE" )) TITLE "" WIDTH 015 NOHILITE

oListaUsr:AddColumn(TcColumn():New(" ",iif(!Empty(aListaUsr[olistaUsr:nAt,5]),{||LoadBitmap( GetResources(), "ENABLE" )},{||LoadBitmap( GetResources(), "DISABLE" )}),;
         nil,nil,nil,nil,015,.T.,.T.,nil,nil,nil,.T.,nil))

oListaUsr:AddColumn(TcColumn():New(STR0102,nil,; //"Nome"
nil,nil,nil,nil,075,.F.,.F.,nil,nil,nil,.F.,nil))
oListaUsr:ACOLUMNS[2]:BDATA     := { || aListaUsr[oListaUsr:nAt,1] }

oListaUsr:AddColumn(TcColumn():New(STR0103,nil,; //"Matricula"
nil,nil,nil,nil,070,.F.,.F.,nil,nil,nil,.F.,nil))
oListaUsr:ACOLUMNS[3]:BDATA     := { || aListaUsr[oListaUsr:nAt,2] }

oListaUsr:AddColumn(TcColumn():New(STR0104,nil,; //"Matricula Antiga"
nil,nil,nil,nil,070,.F.,.F.,nil,nil,nil,.F.,nil))
oListaUsr:ACOLUMNS[4]:BDATA     := { || aListaUsr[oListaUsr:nAt,6] }

oListaUsr:AddColumn(TcColumn():New(STR0012,nil,; //"Empresa"
nil,nil,nil,nil,140,.F.,.F.,nil,nil,nil,.F.,nil))
oListaUsr:ACOLUMNS[5]:BDATA     := { || aListaUsr[oListaUsr:nAt,8] }

oListaUsr:AddColumn(TcColumn():New(STR0105,nil,; //"Nome da Mae"
nil,nil,nil,nil,075,.F.,.F.,nil,nil,nil,.F.,nil))
oListaUsr:ACOLUMNS[6]:BDATA     := { || aListaUsr[oListaUsr:nAt,7] }

oListaUsr:AddColumn(TcColumn():New(STR0005,nil,; //"Telefone"
nil,nil,nil,nil,070,.F.,.F.,nil,nil,nil,.F.,nil))
oListaUsr:ACOLUMNS[7]:BDATA     := { || aListaUsr[oListaUsr:nAt,3] }

oListaUsr:BLDBLCLICK := bOk

ACTIVATE MSDIALOG oDlgUsu ON INIT Eval({||EnChoiceBar(oDlgUsu,{||Eval(bOk),oDlgUsu:End()},{||oDlgUsu:End()},.F.)} )
                                                  
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Redefine o CTRL+A...                                                        
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
SET KEY VK_LBUTTON TO

Return()

/*/
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇旼컴컴컴컴컫컴컴컴컴컴컴쩡컴컴컴쩡컴컴컴컴컴컴컴컴컴컫컴컴컴쩡컴컴컴컴커굇
굇쿑uncao     PLSA300Age  Autor  Geraldo Felix Jr.   Data  09.05.03 낢
굇쳐컴컴컴컴컵컴컴컴컴컴컴좔컴컴컴좔컴컴컴컴컴컴컴컴컴컨컴컴컴좔컴컴컴컴캑굇
굇쿏escricao  Funcao de apoio para criar as matrizes da agenda.         낢
굇쳐컴컴컴컴컨컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴캑굇
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
/*/
Static Function PLSA300Age(aColunas,cCodOpe,aBrwHor,dDtRec, oListLoc, cCodEsp) 
Local nCnt
LOCAL cSQL
LOCAL aAux          
LOCAL cNReduz
LOCAL lAux := .F.
LOCAL nSala := 1
LOCAL nAux      
LOCAL nHorAbert := 0                       
LOCAL nRecBBDCan:= 0                       
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define variaveis para utilizacao nas querys...                           
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
LOCAL cBB7Name  := BB7->(RetSQLName("BB7"))
LOCAL cBB8Name  := BB8->(RetSQLName("BB8"))
LOCAL cBAUName  := BAU->(RetSQLName("BAU"))
LOCAL cBAQName  := BAQ->(RetSQLName("BAQ"))
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta o dia...                                                           
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
LOCAL cMes		:= StrZero(Month(dDtRec),2)   
LOCAL cDiaMes	:= StrZero(Day(dDtRec),2)
LOCAL cDia		:= Alltrim(Str(Dow(dDtRec)))
LOCAL cAno		:= Alltrim(Str(Year(dDtRec)))
LOCAL cHoraEnt  := ""
LOCAL cHoraSai  := ""
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Montar variaveis para utilizacao nas querys...                           
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL := "SELECT "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Dados da agenda...                                                       
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BB7_CODIGO, BB7_DIA, BB7_CODESP, BB7_CODINT, BB7_HORENT, BB7_CODLOC, BB7_HORSAI, BB7_EXCINI, BB7_EXCFIN, BB7_PLTINI, BB7_PLTFIN, BB7_INTERV, "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Dados do local de atendimento...                                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BB8_CODIGO, BB8_CODLOC, BB8_LOCAL, BB8_CODINT, BB8_TMPCON, "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Dados do medico...                                                       
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BAU_CODIGO, BAU_NOME, BAU_LEGEND, "+cBAUName+".R_E_C_N_O_ AS REGBAU, "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Dados da especialidade...                                                
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BAQ_CODESP, BAQ_DESCRI "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta From...                                                            
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "FROM "+cBB7Name+", "+cBAUName+", "+cBB8Name+", "+cBAQName+" "

cSQL += "WHERE "
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta wheres padroes para os arquivos envolvidos...                      
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BB7_FILIAL = '"+xFilial("BB7")+"' AND "
cSQL += "BAU_FILIAL = '"+xFilial("BAU")+"' AND "
cSQL += "BB8_FILIAL = '"+xFilial("BB8")+"' AND "
cSQL += "BAQ_FILIAL = '"+xFilial("BAQ")+"' AND "

cSQL += cBB7Name+".D_E_L_E_T_ = '' AND "
cSQL += cBAUName+".D_E_L_E_T_ = '' AND "
cSQL += cBB8Name+".D_E_L_E_T_ = '' AND "
cSQL += cBAQName+".D_E_L_E_T_ = '' AND "

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Relaciona o BB7 com os arquivos envolvidos na query...                   
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BB7_CODIGO = BAU_CODIGO AND "
cSQL += "BB7_CODINT = BB8_CODINT AND "
cSQL += "BB7_CODIGO = BB8_CODIGO AND "
cSQL += "BB7_CODLOC = BB8_CODLOC AND "
cSQL += "BAQ_CODESP = BB7_CODESP AND "

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta o filtro no arquivos de agendas...                                 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "BB7_DIA    = '"+cDia+"' AND "
cSQL += "BB7_MES    = '"+cMes+"' AND "
cSQL += "BB7_ANO    = '"+cAno+"' AND "
cSQL += "BB7_DIAMES = '"+cDiaMes+"' AND "
cSQL += "BB7_CODINT = '"+cCodOpe+"' AND "
cSQL += "BB7_CODESP = '"+cCodEsp+"' AND "                             
cSQL += "BB8_LOCAL  = '"+aColunas[oListLoc:nAt,1]+"' "

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta Order by ...                                                       
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL += "ORDER BY BAU_FILIAL,BAU_NOME"

PLSQuery(cSQL,"Trb300")

Trb300->(DbGoTop())

aBrwHor 	:= {}
aMedDis		:= {}

If TRB300->(Eof())

	aadd(aBrwHor,{'',;
	'',;
	"",;
	"",;
	"",;
	0,;
	"",;
	"",;
	"",;
	"",;
	0 ,;
	'',;
	.T.,;
	"",;
	"0"})
	
Else
	//cHoraEnt := Trb300->BB7_HORENT
	//cHoraSai := Trb300->BB7_HORSAI
	While ! TRB300->(Eof())
		
	    cHoraEnt := Trb300->BB7_HORENT
	    cHoraSai := Trb300->BB7_HORSAI

		aAux := TRB300->(PLSA300HR(BB7_HORENT,BB7_HORSAI,Iif(!Empty(BB7_INTERV),BB7_INTERV,BB8_TMPCON),BB7_EXCINI,BB7_EXCFIN))
		
		If Alltrim(TRB300->BB7_CODIGO) == Left(cCombo,Len(BAU->BAU_CODIGO))
			For nAux := 1 To Len(aAux)
				//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
				// Para controle de horario cancelado										 
				//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
				nRecBBDCan := 0
				//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
				// Matriz principal de horarios											 
				//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
				If ( Ascan(aBrwHor,{|a| a[1]+a[2] = TRB300->(BB7_CODIGO)+aAux[nAux] }) == 0 )
					//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
					// Checa se tem horario usado												 
					//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
					If BBD->(MsSeek(xFilial("BBD")+TRB300->BB7_CODIGO+cCodOpe+TRB300->BB8_CODLOC+dtos(dDtRec)+aAux[nAux]+Space(02)))
						//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
						// Enquanto for o mesmo horario											 
						//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
						While !BBD->( Eof() ) .And. BBD->(BBD_CODIGO+BBD_CODINT+BBD_CODLOC+DTOS(BBD_DATA)+BBD_HORA) == TRB300->BB7_CODIGO+cCodOpe+TRB300->BB8_CODLOC+dtos(dDtRec)+aAux[nAux]
							If BBD->BBD_PRTATD == "0" .AND. BBD->BBD_ENCAIX == "0" 
					   			If BBD->BBD_STATUS $ '7,8'
					   				lAux := .F.
					   				BBD->( dbSkip() )
					   				Loop
					   			Else
					   				lAux := .T.
					   			Endif
							Else
								lAux := .F.
							Endif              
							//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
							// Tem que ser diferente de cancelado pq o horarios pode ter sido utilizado 
							//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
							If lAux .And. BBD->BBD_STATUS <> '7' 
							   Exit         
							EndIf
							BBD->( dbSkip() )
						EndDo     

						//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
						// Monta matriz															 
						//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
						If lAux
							cNReduz:= Posicione("BA1",2,xFilial("BA1")+BBD->BBD_CODPAC,"BA1_NREDUZ")
							If Empty(cNReduz)
							   BA3->( DbSetOrder(01) )
						   	   BA3->( MsSeek(xFilial("BA3")+BA1->(BA1_CODINT+BA1_CODEMP+BA1_MATRIC)) )
							   cNReduz := Posicione("BG9",1,xFilial("BG9")+BA3->(BA3_CODINT+BA3_CODEMP+BA3_TIPOUS),"BG9_NREDUZ")
							EndIf
							aadd(aBrwHor,{	TRB300->(BB7_CODIGO),;
											aAux[nAux],;
											BBD->BBD_CODPAC,;
											BBD->BBD_NOME,;
											BBD->BBD_TELEFO,;
											BBD->(Recno()),;
											BBD->BBD_STATUS,;
											AllTrim(X3COMBO("BAU_LEGEND",TRB300->BAU_LEGEND))+". "+AllTrim(TRB300->BAU_NOME),;
											BBD->BBD_ENCAIX,;
											BBD->BBD_CODCAN,;
											TRB300->REGBAU,;
											TRB300->BB7_CODLOC,;
											.T.,;
											cNReduz,;
											Iif(lBBD_ATERNA/*BBD->(FieldPos("BBD_ATERNA") ) > 0*/,BBD->BBD_ATERNA,"0") })
						Else
							aadd(aBrwHor,{	TRB300->(BB7_CODIGO),;
											aAux[nAux],;
											"",;
											"",;
											"",;
											0,;
											"",;
											"",;
											"",;
											"",;
											0 ,;
											TRB300->BB7_CODLOC,;
											.T.,;
											"",;
											"0"})
						Endif
					Else
		  				aadd(aBrwHor,{	TRB300->(BB7_CODIGO),;
										aAux[nAux],;
										"",;
										"",;
										"",;
										0,;
										"",;
										"",;
										"",;
										"",;
										0 ,;
										TRB300->BB7_CODLOC,;
										.T.,;
										"",;
										"0"})
					Endif
				Endif
			Next
		Else
			For nAux := 1 To Len(aAux)
				If BBD->(MsSeek(xFilial("BBD")+TRB300->BB7_CODIGO+cCodOpe+TRB300->BB8_CODLOC+dtos(dDtRec)+aAux[nAux]+Space(02)))
					While !BBD->( Eof() ) .And. BBD->(BBD_CODIGO+BBD_CODINT+BBD_CODLOC+DTOS(BBD_DATA)+BBD_HORA) == TRB300->BB7_CODIGO+cCodOpe+TRB300->BB8_CODLOC+dtos(dDtRec)+aAux[nAux]
						If BBD->BBD_PRTATD == "0" .And. BBD->BBD_ENCAIX == "0" 
							If BBD->BBD_STATUS $ '7,8' 
								lAux := .T.
							Else
								lAux := .F.
							Endif
						Else
							lAux := .F.
						Endif
						//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
						// Tem que ser diferente de cancelado pq o horarios pode ter sido utilizado 
						//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
						If lAux .And. BBD->BBD_STATUS <> '7' 
						   Exit
                        EndIf
						//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
						// Proximo registro														 
						//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
						BBD->( dbSkip() )
					EndDo	
					//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
					// Se o horario esta livre													 
					//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
					If lAux
					   Exit
                    EndIf
				Else
					lAux := .T.						
					Exit
				EndIf	        
			Next
			//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
			// Se achou horario livre													 
			//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
			If lAux             
			   AaDd( aMedDis, { TRB300->(BB7_CODIGO) } )
			EndIf
		Endif
		//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
		// Proximo registro														 
		//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
		TRB300->(DbSkip())
	Enddo
Endif

TRB300->(DbCloseArea())
DbSelectArea("BBD")
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta os horarios de encaixe...                                          
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL := "SELECT BBD_CODIGO,BBD_HORA,BBD_CODPAC,BBD_NOME,BBD_TELEFO,R_E_C_N_O_,BBD_STATUS,BBD_ENCAIX,BBD_CODCAN,BBD_CODLOC, "
cSQL += Iif(lBBD_ATERNA/*BBD->(FieldPos("BBD_ATERNA") ) > 0*/,"BBD_ATERNA",'"0" BBD_ATERNA')
cSQL += " FROM "+BBD->(RetSQLName("BBD"))
cSQL += " WHERE BBD_FILIAL	= '"+xFilial("BBD")+"' "
cSQL += "   AND BBD_LOCAL	= '"+aColunas[oListLoc:nAt,1]+"' "
cSQL += "   AND BBD_DATA 	= '"+dtos(dDtRec)+"' "
cSQL += "   AND BBD_CODINT	= '"+cCodOpe+"' "
//cSQL += "   AND BBD_NUMATE	= '"+Space(Len(BBD->BBD_NUMATE))+"' "
cSQL += "   AND BBD_ENCAIX	= '1' "
cSQL += "   AND BBD_CODIGO  = '"+Left(cCombo,LEN(BBD->BBD_CODIGO))+"' "
If lBBD_DATCAN//BBD->( FieldPos("BBD_DATCAN") ) > 0
	cSql += " AND ( BBD_STATUS <> '7' OR (BBD_STATUS = '7' AND BBD_DATCAN = '"+dTos(M->BBO_DATA)+"') ) "
Else
	cSql += " AND BBD_STATUS <> '7' "
Endif
cSQL += "   AND D_E_L_E_T_	= ' ' "
cSQL += "ORDER BY BBD_FILIAL"

PLSQuery(cSQL,"Trb300")

Trb300->(DbGoTop())
While ! Trb300->(Eof())
     //旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
     // Posiciona no credenciado...                                              
     //읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
     BAU->(DbSetOrder(1))
     BAU->(MsSeek(xFilial("BAU")+Trb300->(BBD_CODIGO)))
     //旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
     // Para cada encaixe adiciona no vetor...                                   
     //읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
     aadd(aBrwHor,{Trb300->(BBD_CODIGO),;     
                      Trb300->BBD_HORA,;
                      Trb300->BBD_CODPAC,;
                      Trb300->BBD_NOME,;
                      Trb300->BBD_TELEFO,;
                      Trb300->R_E_C_N_O_,;
                      Trb300->BBD_STATUS,;
                      AllTrim(X3COMBO("BAU_LEGEND",BAU->BAU_LEGEND))+". "+AllTrim(BAU->BAU_NOME),;
                      Trb300->BBD_ENCAIX,;
                      Trb300->BBD_CODCAN,;
                      Trb300->R_E_C_N_O_,;
					  Trb300->BBD_CODLOC,;
					  .T.,;
					  "",;
					  Trb300->BBD_ATERNA })
	Trb300->(DbSkip())
Enddo
DbSelectArea("BBD")       


If Len(aBrwHor) > 0 
	cSQL := "SELECT * FROM "+RetSQLName("BBQ")+" WHERE "
	cSQL += "BBQ_FILIAL = '"+xFilial("BBQ")+"' AND "
	cSQL += "BBQ_CODINT = '"+cCodOpe+"' AND "
	cSQL += "BBQ_CODRDA = '"+Left(cCombo,LEN(BBD->BBD_CODIGO))+"' AND "
	cSQL += "BBQ_CODLOC = '"+aColunas[oListLoc:nAt,1]+"' AND "
	cSQL += "'"+dtos(dDtRec)+"' >= BBQ_DATDE AND '"+dtos(dDtRec)+"' <= BBQ_DATATE AND "
	cSQL += "D_E_L_E_T_ = ''"
	PLSQuery(cSQL,"TRBBBQ")
	
	If TRBBBQ->( Eof() )
		aHorAge := aClone(aBrwHor)
	Else
		aHorAge := {}
	Endif
	
	While !TRBBBQ->( Eof() )
		For nCnt := 1 To Len(aBrwHor)
			If aBrwHor[nCnt][2] >= TRBBBQ->BBQ_HORDE .and. aBrwHor[nCnt][2] <= TRBBBQ->BBQ_HORATE
				// Adiciona horario na matriz, pois existe paciente para ser remarcado.
				If !Empty(aBrwHor[nCnt][3])
					aBrwHor[nCnt][13] := .F.
					Aadd(aHorAge, aClone(aBrwHor[nCnt]))
				Endif
			Else
				Aadd(aHorAge, aClone(aBrwHor[nCnt]))
			Endif
		Next
		TRBBBQ->( dbSkip() )
	Enddo
	TRBBBQ->( dbCloseArea() )
Endif

If Len(aHorAge) == 0
	aadd(aBrwHor,{'',;
		'',;
		"",;
		"",;
		"",;
		0,;
		"",;
		"",;
		"",;
		"",;
		0 ,;
		'',;
		.T.,;
		"",;
		"0"})
Endif
	
Asort(aHorAge,,,{|x,y| x[2] < y[2]})

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Fecha Area de Trabalho...                                                
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
Trb300->(DbCloseArea())
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Fim da Rotina...                                                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
Return

/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴藁袴袴袴錮袴袴袴袴袴袴袴袴袴袴箇袴袴錮袴袴袴袴袴袴敲굇
굇튡rograma 쿛LSA300CALL튍utor  쿒eraldo Felix Junior Data   13/05/03   볍
굇勁袴袴袴袴曲袴袴袴袴袴姦袴袴袴鳩袴袴袴袴袴袴袴袴袴菰袴袴袴鳩袴袴袴袴袴袴묽
굇튒esc.      Chamada da tela de identificacao do usuario ao telefone.   볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴선
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Function PLSA300CALL(cCodEsp,dData,nLen,aListaUsr,oListaUsr, nOpcao, oDlgPes, nDsPer, cCodLoc) 

LOCAL aFields		:= {}
LOCAL oDlg
LOCAL oGrupo
LOCAL oUsr
LOCAL nOpca 	  	:= 2
LOCAL bOk			:= {|| Iif(Obrigatorio(aGets,aTela),(nopca := 1,oDlg:End()),NIL)}
LOCAL aButtons		:= {}

PRIVATE aTela     	:= {}
PRIVATE aGets     	:= {}
PRIVATE lRefresh  	:= .F.
                                                        
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define botoes...                                                         
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸                           
aadd(aButtons,{"POSCLI"  ,{ || A300INTGER() },STR0106,STR0107}) //"Usuarios de Outros Intercambios"###"Intercamb"
aadd(aButtons,{"HISTORIC",{ || PLSHISTCON() },STR0108,STR0109}) //"Historico de Consultas"###"Historico"

If ExistBlock("PL300F11") 
	If ExistBlock('PL300DAD')
		aDadBt:=Execblock("PL300DAD",.F.,.F.)	
	    cPictBt:= aDadBt[1]
	    cDescBt:= aDadBt[2]
	    cTitBt := aDadBt[3]
	Else 
		cPictBt:= "S4WB007N"
		cDescBt:= "PL300F11"
	    cTitBt := "PL300F11"
	Endif
	aadd( aButtons,{cPictBt,{ || ExecBlock("PL300F11",.F.,.F.,{M->BBO_CODPAC,M->BBO_CODESP}) },cDescBt,cTitBt} )
Endif

@ 001,001 BUTTON STR0110 SIZE 000,00 ACTION Eval({||A300INTGER()}) PIXEL  //"&Intercambio"
//BBO->(RegToMemory("BBO",.F.,.T.,.T.))

Aadd(aFields, "BBO_NOME")
Aadd(aFields, "BBO_CODPAC")
Aadd(aFields, "BBO_TELEFO")
Aadd(aFields, "BBO_MATANT")    
Aadd(aFields, "BBO_NOMEMP")    
If lBBO_ATERNA//BBO->( FieldPos("BBO_ATERNA") ) > 0
   aadd(aFields,"BBO_ATERNA")
   M->BBO_ATERNA	:= "0"
EndIf	
M->BBO_NOME 	:= Space(Len(BBO->BBO_NOME))
M->BBO_CODPAC  	:= Space(Len(BBO->BBO_CODPAC))
M->BBO_TELEFO	:= Space(Len(BBO->BBO_TELEFO))
M->BBO_MATANT	:= Space(Len(BBO->BBO_MATANT))
M->BBO_NOMEMP	:= Space(Len(BBO->BBO_NOMEMP))

DEFINE MSDIALOG oDlg TITLE STR0111 FROM 005,005 TO 25, 093 OF oDlgPes //"Identificacao do usuario"
	    
@ 030,004 GROUP oGrupo TO 140, 345 PIXEL OF oDlg LABEL STR0112  COLOR CLR_HBLUE, CLR_HRED        //" Pesquisa de usuario "

oUsr  := MsMGet():New("BBO" ,0 ,K_Incluir,,,,aFields,{040,010,135,340},aFields,,,,,oDlg,,,.T.,)

ACTIVATE MSDIALOG oDlg CENTERED ON INIT Eval({||EnChoiceBar(oDlg,bOk,{||nOpca:=2,oDlg:End()}, .F.,aButtons)} )

If nOpca == 1
	Reclock("BBO",.F.)
		If lBBO_ATERNA//BBO->( FieldPos("BBO_ATERNA") ) > 0
			BBO->BBO_ATERNA := M->BBO_ATERNA
		EndIf	
		BBO->BBO_CODPAC 	:= M->BBO_CODPAC
		BBO->BBO_NOME	    := M->BBO_NOME
		BBO->BBO_TELEFO		:= M->BBO_TELEFO
		BBO->BBO_MATANT		:= M->BBO_MATANT
		BBO->BBO_NOMEMP		:= M->BBO_NOMEMP
		If lForcaPro
			BBO->BBO_USRFRC := aAutFor[Len(aAutFor),9]
		Endif		
	BBO->( msUnlock() )
Endif

oSay1:Refresh()
oSay2:Refresh()
oSay3:Refresh()
oSay4:Refresh()
If lBBO_ATERNA//BBO->( FieldPos("BBO_ATERNA") ) > 0
   oSay5:Refresh()
EndIf

Return(Iif(nOpca==1,.T.,.F.))

/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴藁袴袴袴錮袴袴袴袴袴袴袴袴袴袴箇袴袴錮袴袴袴袴袴袴敲굇
굇튡rograma  쿛LSA300ENC튍utor  쿒eraldo Felix Junior Data   14/05/03   볍
굇勁袴袴袴袴曲袴袴袴袴袴姦袴袴袴鳩袴袴袴袴袴袴袴袴袴菰袴袴袴鳩袴袴袴袴袴袴묽
굇튒esc.      Validacao do encaixe.                                      볍
굇튧so        Agenda medica.                                             볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴선
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Function PLSA300ENC(cHora, aHorAge, oHorarios,nOpcao)
LOCAL nPos := Ascan(aHorAge, {|x| x[2] == cHora})

If nOpcao == K_Marcar
	If nPos # 0 .and. !Empty(aHorAge[nPos][03])
		Aviso(STR0113,STR0114,{STR0047}) //"Horario nao disponive!"###"Este horario ja esta marcado. Informe um horario disponivel."###"&Voltar"
		Return(.F.)
	Endif		
Else
	If nPos # 0
		Aviso(STR0113,STR0115,{STR0047}) //"Horario nao disponive!"###"Informe um horario disponivel."###"&Voltar"
		Return(.F.)
	Endif
Endif	

Return(.T.)

/*/
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇旼컴컴컴컴컫컴컴컴컴컴컴쩡컴컴컴쩡컴컴컴컴컴컴컴컴컴컴쩡컴컴컫컴컴컴컴컴엽굇
굇쿑uncao     PLS300CAR   Autor  Geraldo Felix Junior Data  15.05.03 낢굇
굇쳐컴컴컴컴컵컴컴컴컴컴컴좔컴컴컴좔컴컴컴컴컴컴컴컴컴컴좔컴컴컨컴컴컴컴컴눙굇
굇쿏escricao  Valida carencia...                                         낢굇
굇쳐컴컴컴컴컨컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴눙굇
굇 16.05.02  xxxx  Tulio Cesar  Versao 7.10                           낢굇
굇 18.08.03  xxxx 쿒eraldo Felix Versao 8.11                           낢굇
굇읕컴컴컴컴컨컴컴컴좔컴컴컴컴컴컴좔컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴袂굇
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/

Function PLS300Car(dDatPro,cCdTbPd,cCodPro, cMatric)
                    
LOCAL dAux               
LOCAL nDiasFT   
LOCAL aCriticas := {}
LOCAL lOK       := .T.
LOCAL nDias          
LOCAL nDiasCar	:= 0
LOCAL cUnCar	:= ""
LOCAL dDatCar	:= cTod("")

DEFAULT cCodPro	:= GetNewPar("MV_PLSCDCO","0110101012") //Codigo padrao da consulta Agenda Medica

cMatric := StrTran(cMatric,".","")
cMatric := StrTran(cMatric,"-","")

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Testa se existe carencia a ser verificada...                             
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
BA1->( dbSetorder(02) )
BA1->( MsSeek(xFilial("BA1")+cMatric) )
dDatCar := BA1->BA1_DATCAR
	
BR8->(DbSetOrder(1))
If BR8->(MsSeek(xFilial("BR8")+cCodPro))
	
	nDiasCar := BR8->BR8_CARENC
	cUnCar   := BR8->BR8_UNCAR
	cDesPro	 := BR8->BR8_DESCRI
	
	If     cUnCar $ "2,3,4" // Dias,Meses,Anos
		nDias := PLSCarDias(nDiasCar,cUnCar) // Calcula em dias
		dAux     := dDatCar+nDias
		
		If dtos(dDatPro) < dtos(dAux)
			nDiasFT := dAux - dDatPro
			lOK     := .F.
			
			aadd(aCriticas,{""   ,STR0116                                   ,AllTrim(str(nDiasCar))+" "+X3COMBO("BR8_UNCAR",cUnCar),"","",cCodPro}) //"Carencia do procedimento"
			aadd(aCriticas,{""   ,STR0117+dtoc(dDatPro),AllTrim(Str((nDias-nDiasFT)))+STR0118,"","",cCodPro}) //"Carencia cumprida ate a data do procedimento "###" Dias"
			aadd(aCriticas,{""   ,STR0119                  ,AllTrim(Str(nDiasFT)),"","",cCodPro}) //"Quantidade restante de dias ate a utilizacao"
			aadd(aCriticas,{""   ,STR0120                ,dtoc(dAux)+" ("+PLSDIASEM(dAux)+")","","",cCodPro}) //"Data em que podera ser realizado o procedimento"
			
		Endif
		
	Endif
Endif

If nDiasCar == 0
   Return(.T.)
Endif                           
     
If Len(aCriticas) <> 0
	PLS300CRI("1",{cCodPro,cDesPro},aCriticas)
	Return(.F.)
Endif

Return(.T.)	

/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇旼컴컴컴컴컫컴컴컴컴컴컴쩡컴컴컴쩡컴컴컴컴컴컴컴컴컴컴쩡컴컴컫컴컴컴컴컴엽
굇쿑uncao     PLS300CRI   Autor  Geraldo Felix Junior Data  15.05.03 낢
굇쳐컴컴컴컴컵컴컴컴컴컴컴좔컴컴컴좔컴컴컴컴컴컴컴컴컴컴좔컴컴컨컴컴컴컴컴눙
굇쿏escricao  Critica                                                    낢
굇읕컴컴컴컴컨컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴袂
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
 賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Function PLS300CRI(cTipo,aDados,aHisCri)
LOCAL oDlg
LOCAL aCri      := {}
LOCAL nOpca     := 0
LOCAL bOK       := {|| nOpca := 1,oDlg:End() }
LOCAL bCancel   := {|| nOpca := 0,oDlg:End() }
LOCAL oCritica                                  
LOCAL cCodPad
LOCAL cCodPro
LOCAL cDesPro
LOCAL cSequen
LOCAL cTitulo
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta dados para o caso de critica de movimentacao...                    
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If     cTipo == "1"
       cCodPad := aDados[1]
       cDesPro := aDados[2]
   
       cTitulo := STR0121+AllTrim(cCodPro)+" - "+AllTrim(cDesPro) //"Criticas do usuario "
ElseIf cTipo == "2"
       cTitulo := STR0122 //"Criticas Usuario"
ElseIf cTipo == "3"
       cTitulo := STR0123 //"Criticas Rede de Atendimento"
Endif
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define dialogo...                                                        
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
DEFINE MSDIALOG oDlg TITLE cTitulo FROM 005,005 TO 024, 090

oCritica := TcBrowse():New( 022, 005, 320, 110,,,, oDlg,,,,,,,,,,,, .F.,, .T.,, .F., )
                                            
oCritica:AddColumn(TcColumn():New(STR0124,{ || aHisCri[oCritica:nAt,1] },; //"Codigo"
         "@C",nil,nil,nil,020,.F.,.F.,nil,nil,nil,.F.,nil))     
oCritica:AddColumn(TcColumn():New(STR0004,{ || OemToAnsi(aHisCri[oCritica:nAt,2]) },; //"Descricao"
         "@C",nil,nil,nil,170,.F.,.F.,nil,nil,nil,.F.,nil))     
oCritica:AddColumn(TcColumn():New(STR0125,{ || OemToAnsi(aHisCri[oCritica:nAt,3]) },; //"Info"
         "@C",nil,nil,nil,050,.F.,.F.,nil,nil,nil,.F.,nil))     

oCritica:SetArray(aHisCri)         
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Ativa dialogo....                                                        
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
ACTIVATE MSDIALOG oDlg ON INIT Eval( { || EnChoiceBar(oDlg,bOK,bCancel,.F.) } )

Return

/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴藁袴袴袴錮袴袴袴袴袴袴袴袴袴袴箇袴袴錮袴袴袴袴袴袴敲굇
굇튡rograma  쿛LS300MEDBRW튍utor  쿒eraldo Felix Junior튒ata    27/05/03 볍
굇勁袴袴袴袴曲袴袴袴袴袴姦袴袴袴鳩袴袴袴袴袴袴袴袴袴菰袴袴袴鳩袴袴袴袴袴袴묽
굇튒esc.     쿗ista as especialidades do medico se esta nao for especifica볍
굇          쿭a...                                                       볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴선
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Static Function PLS300MEDBRW(oHorarios,oBrowse,bVetAge)

LOCAL cSql 		:= ""
LOCAL aEspe 	:= {}
LOCAL cCodMed	:= ""
LOCAL oDlgMed
LOCAL nOpc		:= 0
LOCAL nAt		:= 0
LOCAL nBrwAt	:= 0
LOCAL bOk       := {|| Iif( Len(aCombo) > 0 , Eval({|| nBrwAt := oBrwMed:nAt, nOpc:=1,cCombo:=aCombo[oBrwMed:nAt,1]+" - "+aCombo[oBrwMed:nAt,2],cComboEsp:=aCombo[oBrwMed:nAt,4] , oDlgMed:End() }) ,oDlgMed:End() ) } 
LOCAL bCa		:= {|| nOpc:=0,oDlgMed:End()}
LOCAL oBrwMed

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define dialogo...                                                        
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
DEFINE MSDIALOG oDlgMed TITLE STR0126 FROM 06,000 TO 022, 100 //"Medicos disponiveis"

oBrwMed := TcBrowse():New( 032, 001, 390, 080,,,, oDlgMed,,,,,,,,,,,, .F.,, .T.,, .F., )
                                            
oBrwMed:AddColumn(TcColumn():New(STR0124			,{ || aCombo[oBrwMed:nAt,1] },"@C",nil,nil,nil,026,.F.,.F.,nil,nil,nil,.F.,nil)) //"Codigo"
oBrwMed:AddColumn(TcColumn():New(STR0080			,{ || OemToAnsi(aCombo[oBrwMed:nAt,2]) },"@C",nil,nil,nil,160,.F.,.F.,nil,nil,nil,.F.,nil)) //"Medico"
oBrwMed:AddColumn(TcColumn():New(STR0127	,{ || OemToAnsi(aCombo[oBrwMed:nAt,3]) },"@C",nil,nil,nil,160,.F.,.F.,nil,nil,nil,.F.,nil)) //"Especialidade"
oBrwMed:AddColumn(TcColumn():New(STR0128		,{ || OemToAnsi(aCombo[oBrwMed:nAt,4]) },"@C",nil,nil,nil,030,.F.,.F.,nil,nil,nil,.F.,nil)) //"Cod. Esp."
oBrwMed:SetArray(aCombo)         
oBrwMed:BLDBLCLICK := bOk                                                    

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Ativa dialogo....                                                        
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
ACTIVATE MSDIALOG oDlgMed ON INIT Eval( { || EnChoiceBar(oDlgMed,bOK,bCa,.F.,{}) } )
                          
If nOpc == 1
	oSayMed:Refresh()
	Eval(bVetAge)
	oHorarios:Setarray(aHorAge)
	oHorarios:Refresh()
	oHorarios:SetFocus()
	oSinal:LACTIVE			:= Iif(!Empty(aCombo[nBrwAt,5]),.T.,.F.)
	oBmpBol:LVISIBLECONTROL := Iif(!Empty(aCombo[nBrwAt,5]),.T.,.F.)	
Endif

Return()                                                                       	
    
/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴藁袴袴袴錮袴袴袴袴袴袴袴袴袴袴箇袴袴錮袴袴袴袴袴袴敲굇
굇튡rograma  쿛LSA300MSG튍utor  쿒eraldo Felix Junior Data   09-14-03   볍
굇勁袴袴袴袴曲袴袴袴袴袴姦袴袴袴鳩袴袴袴袴袴袴袴袴袴菰袴袴袴鳩袴袴袴袴袴袴묽
굇튒esc.      mostra a mensagem do dia do medico selecionado             볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴선
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Static Function PLSA300MSG()
If ( nPos := Ascan(aCombo,{|x| x[1] == Left(cCombo,Len(BAU->BAU_CODIGO))}) ) <> 0
	If !Empty(aCombo[nPos,5])
		MsgInfo(aCombo[nPos,5])
	Endif
Endif                      

Return()

/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴藁袴袴袴錮袴袴袴袴袴袴袴袴袴袴箇袴袴錮袴袴袴袴袴袴敲굇
굇튡rograma  쿛LSA300   튍utor  쿘icrosiga            Data   09-17-03   볍
굇勁袴袴袴袴曲袴袴袴袴袴姦袴袴袴鳩袴袴袴袴袴袴袴袴袴菰袴袴袴鳩袴袴袴袴袴袴묽
굇튒esc.                                                                 볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴선
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Static Function Pls300EnableKeys(oListLoc, oEnc, bFiltro, nDsPes, dData, aListaUsr, nOpcao,; 
				oDlgPes, bClick, oHorarios, bVetAge, oBrowse, cCodEsp, oListaUsr, nDsPer)

SetKey(VK_F4 ,{||((oListLoc:Refresh()),PLSA300Dat("2",oEnc,bFiltro,nDsPes,M->BBO_DATA))})// Agenda anterior
SetKey(VK_F5 ,{||((oListLoc:Refresh()),PLSA300Dat("1",oEnc,bFiltro,nDsPes,M->BBO_DATA))})// Promxima Agenda
SetKey(VK_F6 ,{||oEnc:AENTRYCTRLS[1]:SetFocus()})  		// Troca a data
SetKey(VK_F7 ,{||oEnc:AENTRYCTRLS[3]:SetFocus()})  		// Troca a especialidade
SetKey(VK_F8 ,{||oEnc:AENTRYCTRLS[5]:SetFocus()})  		// Troca o medico
SetKey(VK_F9 ,{||oEnc:AENTRYCTRLS[7]:SetFocus()})			// Troca o local de atendimento
SetKey(VK_F10,{||A300CLSUSR()})  							// Limpa usuario selecionado...

SetKey(VK_F11,{||Pls300DisableKeys(),;
				 PLSA300CALL(cCodEsp,dData,1,aListaUsr,oListaUsr,nOpcao,oDlgPes,nDsPer,oListLoc:aArray[oListLoc:nAt][1],aHorAge,oHorarios,.T.),;
                 Pls300EnableKeys(oListLoc, oEnc, bFiltro, nDsPes, dData, aListaUsr,nOpcao, oDlgPes, bClick,;
                 oHorarios, bVetAge, oBrowse,cCodEsp,oListaUsr,nDsPer)}) 			// Identificacao do paciente.     
                 
SetKey(VK_F12,{||lEncaixe := .T.,nOpcao:=K_Agenda,Eval(bClick),lEncaixe:=.F. }) 	// Encaixe
SetKey(1  ,{||oListLoc:SetFocus()})  							  					// Foca os locais de atendimento.

SetKey(2  ,{||If(lMarcar,(Pls300DisableKays(),;
						   PLS300MEDBRW(oHorarios,oBrowse,bVetAge),;
			               Pls300EnableKeys(oListLoc, oEnc, bFiltro, nDsPes,dData, aListaUsr,nOpcao, ;
							                 oDlgPes, bClick, oHorarios, bVetAge, oBrowse,cCodEsp,;
							                 oListaUsr,nDsPer)),;
							                 Aviso(STR0023,STR0046,{"&Voltar"})) }) // Invoca o browse de medicos //"Remarcar"###"Nao e possivel trocar de medico na remarcacao."
SetKey(3  ,{||oHorarios:SetFocus()})  // Foca a agenda do medico selecionado
SetKey(13 ,{||PLSA300MSG()})

Return
			  	    
/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴藁袴袴袴錮袴袴袴袴袴袴袴袴袴袴箇袴袴錮袴袴袴袴袴袴敲굇
굇튡rograma  쿛LSA300   튍utor  쿘icrosiga            Data   09-17-03   볍
굇勁袴袴袴袴曲袴袴袴袴袴姦袴袴袴鳩袴袴袴袴袴袴袴袴袴菰袴袴袴鳩袴袴袴袴袴袴묽
굇튒esc.                                                                 볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴선
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Static Function Pls300DisableKeys()

SET KEY VK_F4 TO
SET KEY VK_F5 TO
SET KEY VK_F6 TO
SET KEY VK_F7 TO
SET KEY VK_F8 TO
SET KEY VK_F9 TO
SET KEY VK_F10 TO
SET KEY VK_F11 TO
SET KEY VK_F12 TO                  
SET KEY 1  TO
SET KEY 2  TO
SET KEY 3  TO
SET KEY 13 TO

Return()

/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴藁袴袴袴錮袴袴袴袴袴袴袴袴袴袴箇袴袴錮袴袴袴袴袴袴敲굇
굇튡rograma  쿛LSA300CAR튍utor  쿒eraldo Felix Junior Data   11-08-03   볍
굇勁袴袴袴袴曲袴袴袴袴袴姦袴袴袴鳩袴袴袴袴袴袴袴袴袴菰袴袴袴鳩袴袴袴袴袴袴묽
굇튒esc.      Analiza carencia... agora com o forca                      볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴선
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Function PLSA300CAR(cMatric,cAterna,cComboMed,cCodLoc,cCodEsp,lShowCri)
LOCAL aDadUsr 	  := PLSDADUSR(cMatric,"1",.T.,dDatabase)
LOCAL aDadRDA 	  := {} 
LOCAL cCodPro 	  := GetNewPar("MV_PLSCDCO","0110101012") //Codigo padrao da consulta Agenda Medica
LOCAL cCodPad 	  := Left(cCodPro,2)
LOCAL cDesPro
LOCAL cNivel 
LOCAL aHisCri	  := {}
LOCAL lRetorno    := .T.
LOCAL lRet
LOCAL lForcou	  := .T.
LOCAL oMemo
LOCAL cMemo 	  := ""
LOCAL oDlg
LOCAL nOpca		  := 2               
LOCAL cCodRDA     := ""
LOCAL nOrdBB8       := BB8->(IndexOrd())
LOCAL nRecBB8       := BB8->(Recno())   
LOCAL dDatPro		:= IIf(GetNewPar("MV_PLSPEAG","0") == "1" .And. FunName()$'PLSA300,PLSA315,TMKA271' .and. type('M->BBO_DATA')<> 'U',M->BBO_DATA,dDataBase)

DEFAULT cCodLoc    := ""
DEFAULT cAterna	  := "0"              
DEFAULT cComboMed := GetNewPar("MV_PLSRDAG","999999")//Rede de Atendimento Generica Utilizada na rotina de liberacao
DEFAULT lShowCri  := .T.

If Type("cCombo") == "C"
   cCodRDA := Left(cCombo,Len(BAU->BAU_CODIGO))   
Else          
   cCodRDA := Left(cComboMed,Len(BAU->BAU_CODIGO))   
EndIf
                   
//Procura o correto local de atendimento a partir do BB8
BB8->(DbSetOrder(3))
BB8->(DbSeek(xFilial("BB8")+cCodRda+PLSIntPad()+cCodLoc))
cCodLoc := BB8->BB8_CODLOC

BB8->(DbSetOrder(nOrdBB8))
BB8->(DbGoTo(nRecBB8))

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Redefine as variaveis...                                                 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cCodPro 	:= Substr(cCodPro,3,8)
lForcaUsr	:= .F.
lForcaPro	:= .F.         
aAutFor 	:= {}

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Verifica se existe o procedimento...                                     
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
cSQL := "SELECT BR8_NIVEL, BR8_DESCRI, R_E_C_N_O_ AS REGBR8 FROM "+RetSQLName("BR8")+" WHERE "
cSQL += "BR8_FILIAL = '"+xFilial("BR8")+"' AND "
cSQL += "BR8_CODPAD = '"+cCodPad+"' AND "
cSQL += "BR8_CODPSA = '"+cCodPro+"' AND "
cSQL += "D_E_L_E_T_ = '' AND BR8_ANASIN = '1'"

PLSQuery(cSQL,"PLSA090AUT")

If PLSA090AUT->(Eof())
   lRet := .F.
Else
   BR8->(DbGoTo(PLSA090AUT->REGBR8))
   cDesPro := PLSA090AUT->BR8_DESCRI
   cNivel  := PLSA090AUT->BR8_NIVEL
   lRet   := .T.
Endif   
PLSA090AUT->(DbCloseArea())

BCT->(dbSetOrder(1))

If lShowCri .Or. !aDadUsr[1]
	aRet := PLSA090USR(cMatric,dDatabase,Time(),,.F.,.T.,.F.)
	lCritica := aRet[1]
	aCritica := aRet[2]                                       
Else 
	lCritica := .F.
	aCritica := {}                                       
Endif     
     
If Len(aCritica) > 0  
	If BCT->(MsSeek(xFilial("BCT")+PlsIntPad()+aCritica[1][1]))
		lRet := PLSMOVCRI("2",{},aCritica,BCT->BCT_PERFOR == "1") 
		If !lRet 	
			Return({lRet,aCritica})
		EndIf
		lCritica := lRet
		lShowCri := .F.
	Else	
		PLSMOVCRI("2",{},aCritica) 
		lCritica := .F.	
	EndIf
Endif

If lCritica
   aDadUsr := PLSGETUsr()
Endif
     
If !aDadUsr[1]
	Return({lCritica, aCritica})
Endif
                                   
If Type("cCombo") == "C"
   cCodRDA := Left(cCombo,Len(BAU->BAU_CODIGO))   
Else          
   cCodRDA := Left(cComboMed,Len(BAU->BAU_CODIGO))   
EndIf
	
aDadRDA := PLSDADRDA(BA1->BA1_CODINT,cCodRda,'1' ,dDatabase,cCodLoc,cCodEsp)

If !aDadRDA[1]  
	If BCT->(MsSeek(xFilial("BCT")+PlsIntPad()+aDadRDA[2][1][1]))
		lRet := PLSMOVCRI("2",{},aDadRDA[2],BCT->BCT_PERFOR == "1") 
		lCritica := lRet
		lShowCri := .F.
	Else	
		PLSMOVCRI("2",{},aDadRDA[2]) 
		lCritica := .F.	
	EndIf
Endif

If !aDadRDA[1]
	Return({aDadRDA[1], {}})
Endif
                                          
aRet := PLSAUTP(dDatPro,Time(),cCodPad,cCodPro,1,aDadUsr,0,aDadRDA,"1",.T.,'',,NIL,,,,,,,,,,,,,,,cAterna,,,,,,,,,,,;
        ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.F.)

lRet := aRet[1]

If !aRet[1]   	                                                      
	If BCT->(MsSeek(xFilial("BCT")+PlsIntPad()+aRet[2][1][1]))
		lRet := PLSMOVCRI("2",{},aRet[2],BCT->BCT_PERFOR == "1") 
		lCritica := lRet
		lShowCri := .F.
	Else	
		PLSMOVCRI("2",{},aRet[2]) 
		lCritica := .F.	
	EndIf
Endif

If !lRet .and. Len(aDadUsr) > 0 .and. Len(aDadRDA) > 0
	
	//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
	// Caso nao seja autorizada analiso o campo que trata se e permitido forcar 
	//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
	If ! lRet
		//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
		// Monta aHisCri...                                                         
		//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
		aHisCri := aClone(aRet[2])
		
		//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
		// Parametro que permite ou nao a visualizacao das criticas...              
		//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸			
		If lShowCri
			aRet[1] := PLSMOVCRI("1",{cCodPad,cCodPro,cDesPro,"001"},aHisCri,BR8->BR8_PERFOR == "1")
			
			lRet := Iif( ValType(aRet[1]) == 'L', aRet[1], .F.)
			//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
			// Forcou, abrir tela de digitacao de observacoes...                        
			//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸		
			If lRet
				nPos := Ascan(aAutFor,{|x| x[2]+x[3] == cCodPad+cCodPro})
				If nPos == 0
					aadd(aAutFor,{.T.,cCodPad,cCodPro,"","","","",0,BCS->(RetCodUsr()),Date(),Time()})
				Endif    			
				lForcaPro := .T.
				//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
				// Forcou, abrir tela de digitacao de observacoes...                        
				//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
				DEFINE MSDIALOG oDlg TITLE STR0129 FROM 005,005 TO 19, 045  //"Observacoes"
	    
					@ 016,003 GROUP oGrupo TO 104, 157 PIXEL OF oDlg LABEL STR0130  COLOR CLR_HBLUE, CLR_HRED        //" Observacoes "
					@ 024,006 GET oMemo  VAR cMemo MEMO SIZE 145,075 OF oDlg PIXEL

				ACTIVATE MSDIALOG oDlg ON INIT Eval({||EnChoiceBar(oDlg,{||nOpca:=1,oDlg:End()},{||nOpca:=2,oDlg:End()}, .F.)} )
				If nOpca == 1
					Aadd(aAutFor[Len(aAutFor)], cMemo)
				Else	
					Aadd(aAutFor[Len(aAutFor)], '')
				Endif			
			Else
				lForcaPro := .F.
			Endif
		Endif
	Endif
Endif

lRetorno :=  lRet
Return({lRetorno, aHisCri})

/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴袴箇袴袴袴佶袴袴袴袴袴袴袴袴袴藁袴袴袴佶袴袴袴袴袴袴뺑
굇튡rograma  쿛L300VISCAR튍utor  쿒eraldo Felix Junior Data   13/05/03   볍
굇勁袴袴袴袴曲袴袴袴袴袴菰袴袴袴賈袴袴袴袴袴袴袴袴袴袴姦袴袴賈袴袴袴袴袴袴攷굇
굇튒esc.      Chamada da tela de identificacao do usuario ao telefone.    볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴暠굇
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Function PL300VISCAR(cCodEsp,dData,aListaUsr,oListaUsr, nOpcao, oDlgPes, nDsPer, cCodPac,lBBO_ATERNA)

LOCAL oUsr
LOCAL oDlgCar
LOCAL oGrupo

LOCAL nOpca 	  	:= 2
LOCAL bOk			:= {|| oDlgCar:End() }
LOCAL bCancel 		:= {|| oDlgCar:End() }
LOCAL bCarencia		:= {|| PLSVSCLACAR( Substr(Iif(!Empty(cCodPac),cCodPac,M->BBO_CODPAC),1,(Len(BBO->BBO_CODPAC)-1)) )}
LOCAL aButtons		:= {{"RELATORIO"    	, bCarencia ,STR0131,STR0132}} //"Carencias - <ALT + C>"###"Carencias"
LOCAL aFields		:= {}

PRIVATE aTela     	:= {}
PRIVATE aGets     	:= {}
PRIVATE lRefresh  	:= .F.
DEFAULT lBBO_ATERNA := BBO->( FieldPos("BBO_ATERNA") ) > 0
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Caso tenha um usuario selecionado...                                     
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If !Empty(cCodPac)
	Eval(bCarencia)
	Return()
ElseIf Type('M->BBO_CODPAC') == 'U' .and. funname() <> 'PLSA315'
	Return()
Endif	  

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Carrega variaveis de memoria											 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
BBO->(RegToMemory("BBO",.F.))

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Manta array																 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
Aadd(aFields, "BBO_NOME"  )
Aadd(aFields, "BBO_CODPAC")
Aadd(aFields, "BBO_MATANT")    
Aadd(aFields, "BBO_NOMEMP")    
If lBBO_ATERNA//BBO->( FieldPos("BBO_ATERNA") ) > 0
   aadd(aFields,"BBO_ATERNA")
   M->BBO_ATERNA	:= "0"
EndIf	
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Alimenta variavel memoria												 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
M->BBO_NOME 	:= Space(Len(BBO->BBO_NOME))  
M->BBO_CODPAC  	:= Space(Len(BBO->BBO_CODPAC))
M->BBO_MATANT	:= Space(Len(BBO->BBO_MATANT))
M->BBO_NOMEMP	:= Space(Len(BBO->BBO_NOMEMP))

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// dlg																	 	 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
DEFINE MSDIALOG oDlgCar TITLE STR0132 FROM 005,005 TO 19, 068 OF oDlgPes //"Carencias"
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
//쿌tiva tecla de atalho...												 	 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
@ 001,001 BUTTON STR0133 SIZE 000,00 ACTION Eval(bCarencia) PIXEL OF oDlgCar  //"&Carencias"

@ 016,003 GROUP oGrupo TO 102, 248 PIXEL OF oDlgCar LABEL STR0134  COLOR CLR_HBLUE, CLR_HRED        //" Informe o usuario "

oUsr  := MsMGet():New("BBO" ,0 ,K_Incluir,,,,aFields,{024,006,098,245},aFields,,,,,oDlgCar,,,.T.,)

ACTIVATE MSDIALOG oDlgCar ON INIT Eval({||EnChoiceBar(oDlgCar,bOk,bCancel, .F., aButtons)} ) CENTER
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Fim da rotina															 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
Return()
/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴藁袴袴袴錮袴袴袴袴袴袴袴袴袴袴箇袴袴錮袴袴袴袴袴袴敲굇
굇튡rograma  쿌300INTGER튍utor  쿒eraldo Felix Junior Data   13/06/05   볍
굇勁袴袴袴袴曲袴袴袴袴袴姦袴袴袴鳩袴袴袴袴袴袴袴袴袴菰袴袴袴鳩袴袴袴袴袴袴묽
굇튒esc.      Inclusao de usuarios de intercambio eventual...            볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴선
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/

Function A300INTGER(lChkCon)
LOCAL aRetIntEve	:= PLSA235(.F.,"",.T.,NIL,NIL,NIL,NIL,NIL,NIL,lChkCon)
LOCAL aRet 			:= {}
LOCAL lRet 			:= .F.
LOCAL cMatric		:= ''
LOCAL _cCodEsp  	:= ''
LOCAL cNReduz                                  

If Type('M->BBO_CODESP') == "C"
   _cCodEsp := M->BBO_CODESP
Else 
   _cCodEsp := cCodEsp
Endif   
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Para usuarios que vem de uma marcacao de consulta						 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If aRetIntEve[1]
	cMatric := BA1->(BA1_CODINT+BA1_CODEMP+BA1_MATRIC+BA1_TIPREG+BA1_DIGITO)
	
	aRet := PLSA090USR(cMatric,dDatabase,Time(),,.F.,.T.,.F.)
	lRet := PLSA300TPe(cMatric,dDatabase,_cCodEsp,GetNewPar("MV_PLDSCAG",30),oEnc:oBox)//Dias para agendamento de consultas mesma especial.
	
	If lRet
		cNReduz := Posicione("BA1",2,xFilial("BA1")+cMatric,"BA1_NREDUZ")
		If Empty(cNReduz)
		   BA3->( DbSetOrder(01) )
	   	   BA3->( MsSeek(xFilial("BA3")+BA1->(BA1_CODINT+BA1_CODEMP+BA1_MATRIC)) )
		   cNReduz := Posicione("BG9",1,xFilial("BG9")+BA3->(BA3_CODINT+BA3_CODEMP+BA3_TIPOUS),"BG9_NREDUZ")
		EndIf

		M->BBD_CODPAC := cMatric
		M->BBD_NOME   := BA1->BA1_NOMUSR
		M->BBD_TELEFO := BA1->BA1_TELEFO
		M->BBD_MATANT := BA1->BA1_MATANT

		M->BBO_CODPAC 	:= cMatric
		M->BBO_NOME 	:= BA1->BA1_NOMUSR
		M->BBO_NOMEMP 	:= cNReduz
		M->BBO_TELEFO 	:= BA1->BA1_TELEFO
		M->BBO_MATANT 	:= BA1->BA1_MATANT
	Endif
	
	lRefresh := .T.
Else
   If Len(aRetIntEve) >= 2 .And. Len(aRetIntEve[2]) > 0
   		PLSMOVCRI("2",{},aRetIntEve[2])      
   Endif   
Endif

Return

/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴藁袴袴袴錮袴袴袴袴袴袴袴袴袴袴箇袴袴錮袴袴袴袴袴袴敲굇
굇튡rograma  쿛LSHISTCON튍utor  쿌lexander 			  Data   31/01/06   볍
굇勁袴袴袴袴曲袴袴袴袴袴姦袴袴袴鳩袴袴袴袴袴袴袴袴袴菰袴袴袴鳩袴袴袴袴袴袴묽
굇튒esc.      Historico de Consultas									  볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴선
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Function PLSHISTCON()
LOCAL cSql  := ""
LOCAL aRet  := {}
LOCAL nCont := 0
LOCAL cNome
If !Empty(M->BBO_CODPAC)
	cSQL := " SELECT BBD_CODPAC,BBD_NOME,BBD_DATA,BBD_HORA,BBD_CODINT,BBD_CODESP,BBD_CODIGO,BBD_CODLOC,BBD_LOCAL,BBD_NSALA,BBD_HORCHE,BBD_HORENT,BBD_HORSAI "
	cSQL += "  FROM "+BBD->(RetSQLName("BBD"))
	cSQL += " WHERE BBD_FILIAL = '"+xFilial("BBD")				+"' "
	cSQL += "   AND BBD_CODINT = '"+SubStr(M->BBO_CODPAC,1,4)	+"' " 
	cSQL += "   AND BBD_CODPAC = '"+M->BBO_CODPAC				+"' "
	cSQL += "   AND BBD_STATUS = '4' "
	cSQL += "   AND D_E_L_E_T_ = ' ' "
	cSQL += " ORDER BY BBD_DATA DESC "
	PLSQuery(cSQL,"TrbHis")
	TrbHis->( DbGoTop() )                   
	cNome := Transform(TrbHis->BBD_CODPAC,"@R !!!!.!!!!.!!!!!!.!!-!")+' - '+TrbHis->BBD_NOME
	While ! TrbHis->(Eof()) .And. nCont <= 6
      nCont++                                               
	  AaDd(aRet,{	TrbHis->BBD_DATA,; //Data do Atendimento
	  				TrbHis->BBD_HORA,; //Hora do Atendimento
	  				Posicione("BAQ",1,xFilial("BAQ")+TrbHis->(BBD_CODINT+BBD_CODESP), "BAQ_DESCRI" ),; //Especialidade
	  				Posicione("BAU",1,xFilial("BAU")+TrbHis->(BBD_CODIGO), "BAU_NOME" ),; //Medico
	  				Posicione("BB8",1,xFilial("BB8")+TrbHis->(BBD_CODIGO+BBD_CODINT+BBD_CODLOC+BBD_LOCAL), "BB8_DESLOC" ),;//Local
					TrbHis->BBD_NSALA,; 	//Sala
					TrbHis->BBD_HORCHE,;	//Hora de Chegada
					TrbHis->BBD_HORENT,;	//Hora de Entrada
					TrbHis->BBD_HORSAI})	//Hora de Saida
	  TrbHis->( DbSkip() )
	EndDo                 
    If Len(aRet) > 0
       PLSCRIGEN(aRet,{	{STR0077			,"@C",050 }	,; //"Data"
       					{STR0010			,"@C",050 }	,; //"Hora"
       					{STR0127,"@C",100 } ,; //"Especialidade"
       					{STR0080		,"@C",100 } ,; //"Medico"
       					{STR0003		,"@C",100 } ,; //"Local"
       					{STR0135			,"@C",50 } ,; //"Sala"
       					{STR0136	,"@C",50 } ,; //"Hora Chegada"
       					{STR0137	,"@C",50 } ,; //"Hora Entrada"
       					{STR0138	,"@C",50 }},; //"Hora Saida"
       					STR0139+cNome) //"Historico de Consulta do paciente -> "
    EndIf	                          
TrbHis->(DbCloseArea())    
EndIf	
Return
/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴藁袴袴袴錮袴袴袴袴袴袴袴袴袴袴箇袴袴錮袴袴袴袴袴袴敲굇
굇튡rograma  쿛LSMedEsp 튍utor  쿌lexander 			  Data   17/02/06   볍
굇勁袴袴袴袴曲袴袴袴袴袴姦袴袴袴鳩袴袴袴袴袴袴袴袴袴菰袴袴袴鳩袴袴袴袴袴袴묽
굇튒esc.      Checa Especiadlidade x Medico							  볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴선
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Function PLSMedEsp(nTipo,cCampo1,cCampo2)
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define variaveis...                                                      
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
LOCAL nInd                            
LOCAL nLin
LOCAL cSQL
LOCAL cTitulo   
LOCAL oDlg
LOCAL oBrw

LOCAL nOpca     := 0      
LOCAL cRet 		:= ""
LOCAL aBrw  	:= {}
LOCAL bOK       := { || nOpca := K_OK , nLin := oBrw:nAt , oDlg:End() }
LOCAL bCancel   := { || oDlg:End() }
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// coloca virgula no comeco (caso tenha inicializador padrao)               
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If nTipo == 1
	If !Empty(cCampo1)
		cSQL := " SELECT BAQ_CODESP,BAQ_DESCRI,"+RetSQLName("BAQ")+".R_E_C_N_O_"
		cSQL += "   FROM "+RetSQLName("BAX")+", "+RetSQLName("BAQ")
		cSQL += "  WHERE BAX_FILIAL	= '"+xFilial("BAX")+"' " 
		cSQL += "    AND BAX_CODINT = '"+PlsIntPad()+"' "
		cSQL += "    AND BAX_CODIGO = '"+cCampo1+"' "
		cSQL += "    AND "+RetSQLName("BAX")+".D_E_L_E_T_ = ' ' "
		cSQL += "    AND BAQ_FILIAL	= '"+xFilial("BAQ")+"' "         
		cSQL += "    AND BAQ_CODESP = BAX_CODESP  "
		cSQL += "    AND "+RetSQLName("BAQ")+".D_E_L_E_T_ = ' ' "
		cSQL += " ORDER BY BAQ_DESCRI "
	Else
		cSQL := " SELECT BAQ_CODESP,BAQ_DESCRI,"+RetSQLName("BAQ")+".R_E_C_N_O_"
		cSQL += "   FROM "+RetSQLName("BAQ")
		cSQL += "  WHERE BAQ_FILIAL	= '"+xFilial("BAQ")+"' "         
		cSQL += "    AND "+RetSQLName("BAQ")+".D_E_L_E_T_ = ' ' "
		cSQL += " ORDER BY BAQ_DESCRI "
    EndIf
Else 
	If !Empty(cCampo1+cCampo2)
		cSQL := " SELECT DISTINCT BAU_CODIGO,BAU_NOME,BAU_ESTCR,BAU_CONREG,BAU_SIGLCR,"+RetSQLName("BAU")+".R_E_C_N_O_"
		cSQL += "   FROM "+RetSQLName("BAX")+", "+RetSQLName("BAU")
		cSQL += "  WHERE BAX_FILIAL	= '"+xFilial("BAX")+"' " 
		cSQL += "    AND BAX_CODINT = '"+plsIntPad()+"' "
		cSQL += "    AND BAX_CODESP = '"+cCampo2+"' "
		cSQL += "    AND "+RetSQLName("BAX")+".D_E_L_E_T_ = ' ' "
		cSQL += "    AND BAU_FILIAL	= '"+xFilial("BAU")+"' "         
		cSQL += "    AND BAU_CODIGO = BAX_CODIGO  "
		cSQL += "    AND "+RetSQLName("BAU")+".D_E_L_E_T_ = ' ' "
		cSQL += " ORDER BY BAU_NOME "
	Else
		cSQL := " SELECT BAU_CODIGO,BAU_NOME,BAU_ESTCR,BAU_CONREG,BAU_SIGLCR,R_E_C_N_O_"
		cSQL += "   FROM "+RetSQLName("BAU")
		cSQL += "  WHERE BAU_FILIAL	= '"+xFilial("BAU")+"' "         
		cSQL += "    AND BAU_TIPPE  = 'F' "
		cSQL += "    AND "+RetSQLName("BAU")+".D_E_L_E_T_ = ' ' "
		cSQL += " ORDER BY BAU_NOME "
    EndIf
EndIf	
PLSQuery(cSQL,"TrbBAG")
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Monta																	 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
While ! TrbBAG->( Eof() ) 
	If nTipo == 1
	   cTitulo := STR0140 //"Especialidades"
	   aadd(aBrw,{ TrbBAG->BAQ_CODESP,TrbBAG->BAQ_DESCRI,"",TrbBAG->R_E_C_N_O_ } )
	Else 
	   cTitulo := STR0141 //"Rede de Atendimento"
	   aadd(aBrw,{ TrbBAG->BAU_CODIGO,TrbBAG->BAU_NOME,TrbBAG->BAU_ESTCR+"-"+TrbBAG->BAU_CONREG+"-"+TrbBAG->BAU_SIGLCR,TrbBAG->R_E_C_N_O_ } )
	EndIf    
TRBBAG->( DbSkip() )
Enddo                  
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Fecha area de trabalho													 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
TrbBAG->( DbCloseArea() )
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Define tela																 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
DEFINE MSDIALOG oDlg TITLE cTitulo FROM ndLinIni,ndColIni TO ndLinFin,ndColFin OF GetWndDefault()

oBrw := TcBrowse():New( 018, 05, 343, 172,,,, oDlg,,,,,,,,,,,, .F.,, .T.,, .F., )

oBrw:AddColumn(TcColumn():New(STR0124,					{ || OemToAnsi(aBrw[oBrw:nAt,1]) },"@!",nil,nil,nil,030,.F.,.F.,nil,nil,nil,.F.,nil))      //"Codigo"
oBrw:AddColumn(TcColumn():New(STR0004,				{ || OemToAnsi(aBrw[oBrw:nAt,2]) },"@!",nil,nil,nil,200,.F.,.F.,nil,nil,nil,.F.,nil))      //"Descricao"
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Tipo Prestador															 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If nTipo == 2
   oBrw:AddColumn(TcColumn():New(STR0142, { || OemToAnsi(aBrw[oBrw:nAt,3]) },"@!",nil,nil,nil,200,.F.,.F.,nil,nil,nil,.F.,nil))      //"UF+Registro+Conselho"
EndIf
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Set Array																 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
oBrw:SetArray(aBrw)         
oBrw:bLDblClick := bOk

ACTIVATE MSDIALOG oDlg ON INIT EnChoiceBar(oDlg,bOK,bCancel,.F.,{})
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Posiciona																 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
If nOpca == K_OK
	If nTipo == 1
	   If !Empty( aBrw[nLin,4] )
	      BAQ->( DbGoTo( aBrw[nLin,4] ) )
	   Endif
	Else 
	   If !Empty( aBrw[nLin,4] )
	      BAU->( DbGoTo( aBrw[nLin,4] ) )
	   Endif
   EndIf    
Endif
//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
// Fim da Rotina															 
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
Return(nOpca==K_OK)

/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴藁袴袴袴錮袴袴袴袴袴袴袴袴袴袴箇袴袴錮袴袴袴袴袴袴敲굇
굇튡rograma  쿌300CLSUSR튍utor  쿒eraldo Felix Junior Data   09/18/07   볍
굇勁袴袴袴袴曲袴袴袴袴袴姦袴袴袴鳩袴袴袴袴袴袴袴袴袴菰袴袴袴鳩袴袴袴袴袴袴묽
굇튒esc.     쿗impa o usuario selecionado para que um novo possa ser      볍
굇          퀂elecionado.                                                볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴선
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Static Function A300CLSUSR()

	If !BBO->( Eof() )
		BBO->( RecLock("BBO", .F.) )
		BBO->BBO_NREDUZ 	:= ''
		BBO->BBO_NOME		:= ''
		BBO->BBO_CODPAC		:= ''
		BBO->BBO_NOMEMP		:= ''
		If lBBO_ATERNA//BBO->( FieldPos("BBO_ATERNA") ) > 0
			BBO->BBO_ATERNA		:= ''
		Endif
		BBO->BBO_TELEFO		:= ''
		BBO->BBO_MATANT		:= ''
		
		BBO->( MsUnlock() )
		
		oSay1:Refresh()
		oSay2:Refresh()
		oSay3:Refresh()
		oSay4:Refresh()
		
		If lBBO_ATERNA//BBO->( FieldPos("BBO_ATERNA") ) > 0
			oSay5:Refresh()
		EndIf
	Endif

Return()

/*/
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇旼컴컴컴컴컫컴컴컴컴컴쩡컴컴컴쩡컴컴컴컴컴컴컴컴컴컴컴쩡컴컴컫컴컴컴컴컴엽
굇쿛rograma  쿘enuDef    Autor  Darcio R. Sporl        Data 04/01/2007낢
굇쳐컴컴컴컴컵컴컴컴컴컴좔컴컴컴좔컴컴컴컴컴컴컴컴컴컴컴좔컴컴컨컴컴컴컴컴눙
굇쿏escri뇚o  Utilizacao de menu Funcional                               낢
굇쳐컴컴컴컴컵컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴눙
굇쿝etorno   쿌rray com opcoes da rotina.                                 낢
굇쳐컴컴컴컴컵컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴눙
굇쿛arametros쿛arametros do array a Rotina:                               낢
굇          1. Nome a aparecer no cabecalho                             낢
굇          2. Nome da Rotina associada                                 낢
굇          3. Reservado                                                낢
굇          4. Tipo de Transa뇙o a ser efetuada:                        낢
굇          	  1 - Pesquisa e Posiciona em um Banco de Dados           낢
굇              2 - Simplesmente Mostra os Campos                       낢
굇              3 - Inclui registros no Bancos de Dados                 낢
굇              4 - Altera o registro corrente                          낢
굇              5 - Remove o registro corrente do Banco de Dados        낢
굇          5. Nivel de acesso                                          낢
굇          6. Habilita Menu Funcional                                  낢
굇읕컴컴컴컴컨컴컴컴컴컴컴컴컨컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴袂
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
/*/
Static Function MenuDef()
Private aRotina := {	{ STRPL01 	, '' , 0 , K_Pesquisar  , 0, .F.},; //'Pesquisar'
						{ STRPL02 	, '' , 0 , K_Visualizar , 0, Nil},; //'Visualizar'
						{ STRPL03 	, '' , 0 , K_Incluir    , 0, Nil},; //'Incluir'
						{ STRPL04		, '' , 0 , K_Alterar    , 0, Nil}}  //'Alterar'
Return(aRotina)

/*
複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複複
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
굇袴袴袴袴袴佶袴袴袴袴藁袴袴袴錮袴袴袴袴袴袴袴袴袴袴箇袴袴錮袴袴袴袴袴袴敲굇
굇튡rograma  쿌300VldAge튍utor  쿏arcio R. Sporl      Data   29/06/10   볍
굇勁袴袴袴袴曲袴袴袴袴袴姦袴袴袴鳩袴袴袴袴袴袴袴袴袴菰袴袴袴鳩袴袴袴袴袴袴묽
굇튒esc.     쿑uncao criada para validar, se o usuario ja possui agenda   볍
굇          쿻o mesmo dia e horario ja agendado.                         볍
굇勁袴袴袴袴曲袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴묽
굇튧so        SIGAPLS                                                    볍
굇훤袴袴袴袴賈袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴袴선
굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇굇
賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽賽
*/
Static Function A300VldAge(dData)
Local cQry := ""
Local lRet := .T.

//旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
//쿐sta query faz a validacao da agenda, onde eh verificado 
//퀂e o paciente ja possui agenda para o mesmo dia e horario
//쿭igitados.                                               
//읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
cQry := "SELECT COUNT(*) REG "
cQry += "FROM " + RetSqlName("BBD") + " "
cQry += "WHERE BBD_FILIAL = '" + xFilial("BBD") + "' "
cQry += "  AND BBD_CODPAC = '" + M->BBD_CODPAC + "' "
cQry += "  AND BBD_DATA   = '" + DtoS(dData) + "' "
cQry += "  AND BBD_HORA   = '" + aHorAge[oHorarios:nAt,2] + "' "
cQry += "  AND BBD_DATCAN = '" + Space(TamSX3("BBD_DATCAN")[1]) + "' "
cQry += "  AND BBD_HORCAN = '" + Space(TamSX3("BBD_HORCAN")[1]) + "' "
cQry += "  AND D_E_L_E_T_ <> '*' "
		
cQry := ChangeQuery(cQry)
DbUseArea(.T., "TOPCONN", TcGenQry(,, cQry), "TMPBBD", .F., .F.)
		
If TMPBBD->REG > 0
	Aviso(STR0143,STR0144,{STR0145},1)	//"Aten豫o"###"Paciente j possui agendamento para este dia e horrio."###"Ok"
	lRet := .F.
EndIf
TMPBBD->(DbCloseArea())

Return(lRet)
